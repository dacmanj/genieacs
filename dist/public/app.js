(()=>{var e,t,n={},r={};function i(e){if(r[e])return r[e].exports;var t=r[e]={exports:{}};return n[e].call(t.exports,t,t.exports,i),t.exports}function s(e,t,n,r,i,s){return{tag:e,key:t,attrs:n,children:r,text:i,dom:s,domSize:void 0,state:void 0,events:void 0,instance:void 0}}i.m=n,i.t=function(e,t){if(1&t&&(e=this(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);i.r(n);var r={};if(2&t&&"object"==typeof e&&e)for(const t in e)r[t]=()=>e[t];return r.default=()=>e,i.d(n,r),n},i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.f={},i.e=e=>Promise.all(Object.keys(i.f).reduce(((t,n)=>(i.f[n](e,t),t)),[])),i.u=e=>e+".app.js",i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="genieacs:",i.l=(n,r,s)=>{if(e[n])e[n].push(r);else{var o,a;if(void 0!==s)for(var l=document.getElementsByTagName("script"),c=0;c<l.length;c++){var u=l[c];if(u.getAttribute("src")==n||u.getAttribute("data-webpack")==t+s){o=u;break}}o||(a=!0,(o=document.createElement("script")).charset="utf-8",o.timeout=120,i.nc&&o.setAttribute("nonce",i.nc),o.setAttribute("data-webpack",t+s),o.src=n),e[n]=[r];var f=(t,r)=>{o.onerror=o.onload=null,clearTimeout(d);var i=e[n];if(delete e[n],o.parentNode&&o.parentNode.removeChild(o),i&&i.forEach((e=>e(r))),t)return t(r)},d=setTimeout(f.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=f.bind(null,o.onerror),o.onload=f.bind(null,o.onload),a&&document.head.appendChild(o)}},i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;i.g.importScripts&&(e=i.g.location+"");var t=i.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");n.length&&(e=n[n.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),i.p=e})(),(()=>{var e={179:0};i.f.j=(t,n)=>{var r=i.o(e,t)?e[t]:void 0;if(0!==r)if(r)n.push(r[2]);else{var s=new Promise(((n,i)=>{r=e[t]=[n,i]}));n.push(r[2]=s);var o=i.p+i.u(t),a=new Error;i.l(o,(n=>{if(i.o(e,t)&&(0!==(r=e[t])&&(e[t]=void 0),r)){var s=n&&("load"===n.type?"missing":n.type),o=n&&n.target&&n.target.src;a.message="Loading chunk "+t+" failed.\n("+s+": "+o+")",a.name="ChunkLoadError",a.type=s,a.request=o,r[1](a)}}),"chunk-"+t)}};var t=self.webpackChunkgenieacs=self.webpackChunkgenieacs||[],n=t.push.bind(t);t.push=t=>{for(var r,s,[o,a,l]=t,c=0,u=[];c<o.length;c++)s=o[c],i.o(e,s)&&e[s]&&u.push(e[s][0]),e[s]=0;for(r in a)i.o(a,r)&&(i.m[r]=a[r]);for(l&&l(i),n(t);u.length;)u.shift()()}})(),s.normalize=function(e){return Array.isArray(e)?s("[",void 0,void 0,s.normalizeChildren(e),void 0,void 0):null==e||"boolean"==typeof e?null:"object"==typeof e?e:s("#",void 0,void 0,String(e),void 0,void 0)},s.normalizeChildren=function(e){var t=[];if(e.length){for(var n=null!=e[0]&&null!=e[0].key,r=1;r<e.length;r++)if((null!=e[r]&&null!=e[r].key)!==n)throw new TypeError("Vnodes must either always have keys or never have keys!");for(r=0;r<e.length;r++)t[r]=s.normalize(e[r])}return t};var o=s,a=function(){var e,t=arguments[this],n=this+1;if(null==t?t={}:("object"!=typeof t||null!=t.tag||Array.isArray(t))&&(t={},n=this),arguments.length===n+1)e=arguments[n],Array.isArray(e)||(e=[e]);else for(e=[];n<arguments.length;)e.push(arguments[n++]);return o("",t.key,t,e)},l=/(?:(^|#|\.)([^#\.\[\]]+))|(\[(.+?)(?:\s*=\s*("|'|)((?:\\["'\]]|.)*?)\5)?\])/g,c={},u={}.hasOwnProperty;function f(e){for(var t in e)if(u.call(e,t))return!1;return!0}function d(e){for(var t,n="div",r=[],i={};t=l.exec(e);){var s=t[1],o=t[2];if(""===s&&""!==o)n=o;else if("#"===s)i.id=o;else if("."===s)r.push(o);else if("["===t[3][0]){var a=t[6];a&&(a=a.replace(/\\(["'])/g,"$1").replace(/\\\\/g,"\\")),"class"===t[4]?r.push(a):i[t[4]]=""===a?a:a||!0}}return r.length>0&&(i.className=r.join(" ")),c[e]={tag:n,attrs:i}}function h(e,t){var n=t.attrs,r=o.normalizeChildren(t.children),i=u.call(n,"class"),s=i?n.class:n.className;if(t.tag=e.tag,t.attrs=null,t.children=void 0,!f(e.attrs)&&!f(n)){var a={};for(var l in n)u.call(n,l)&&(a[l]=n[l]);n=a}for(var l in e.attrs)u.call(e.attrs,l)&&"className"!==l&&!u.call(n,l)&&(n[l]=e.attrs[l]);for(var l in null==s&&null==e.attrs.className||(n.className=null!=s?null!=e.attrs.className?String(e.attrs.className)+" "+String(s):s:null!=e.attrs.className?e.attrs.className:null),i&&(n.class=null),n)if(u.call(n,l)&&"key"!==l){t.attrs=n;break}return Array.isArray(r)&&1===r.length&&null!=r[0]&&"#"===r[0].tag?t.text=r[0].children:t.children=r,t}var p=function(e){if(null==e||"string"!=typeof e&&"function"!=typeof e&&"function"!=typeof e.view)throw Error("The selector must be either a string or a component.");var t=a.apply(1,arguments);return"string"==typeof e&&(t.children=o.normalizeChildren(t.children),"["!==e)?h(c[e]||d(e),t):(t.tag=e,t)};p.trust=function(e){return null==e&&(e=""),o("<",void 0,void 0,e,void 0,void 0)},p.fragment=function(){var e=a.apply(0,arguments);return e.tag="[",e.children=o.normalizeChildren(e.children),e};var g=p,m="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==i.g?i.g:"undefined"!=typeof self?self:{},v=function(e){if(!(this instanceof v))throw new Error("Promise must be called with `new`");if("function"!=typeof e)throw new TypeError("executor must be a function");var t=this,n=[],r=[],i=l(n,!0),s=l(r,!1),o=t._instance={resolvers:n,rejectors:r},a="function"==typeof setImmediate?setImmediate:setTimeout;function l(e,i){return function l(u){var f;try{if(!i||null==u||"object"!=typeof u&&"function"!=typeof u||"function"!=typeof(f=u.then))a((function(){i||0!==e.length||console.error("Possible unhandled promise rejection:",u);for(var t=0;t<e.length;t++)e[t](u);n.length=0,r.length=0,o.state=i,o.retry=function(){l(u)}}));else{if(u===t)throw new TypeError("Promise can't be resolved w/ itself");c(f.bind(u))}}catch(e){s(e)}}}function c(e){var t=0;function n(e){return function(n){t++>0||e(n)}}var r=n(s);try{e(n(i),r)}catch(e){r(e)}}c(e)};v.prototype.then=function(e,t){var n,r,i=this._instance;function s(e,t,s,o){t.push((function(t){if("function"!=typeof e)s(t);else try{n(e(t))}catch(e){r&&r(e)}})),"function"==typeof i.retry&&o===i.state&&i.retry()}var o=new v((function(e,t){n=e,r=t}));return s(e,i.resolvers,n,!0),s(t,i.rejectors,r,!1),o},v.prototype.catch=function(e){return this.then(null,e)},v.prototype.finally=function(e){return this.then((function(t){return v.resolve(e()).then((function(){return t}))}),(function(t){return v.resolve(e()).then((function(){return v.reject(t)}))}))},v.resolve=function(e){return e instanceof v?e:new v((function(t){t(e)}))},v.reject=function(e){return new v((function(t,n){n(e)}))},v.all=function(e){return new v((function(t,n){var r=e.length,i=0,s=[];if(0===e.length)t([]);else for(var o=0;o<e.length;o++)!function(o){function a(e){i++,s[o]=e,i===r&&t(s)}null==e[o]||"object"!=typeof e[o]&&"function"!=typeof e[o]||"function"!=typeof e[o].then?a(e[o]):e[o].then(a,n)}(o)}))},v.race=function(e){return new v((function(t,n){for(var r=0;r<e.length;r++)e[r].then(t,n)}))};var _,w=v,b=(function(e){"undefined"!=typeof window?(void 0===window.Promise?window.Promise=w:window.Promise.prototype.finally||(window.Promise.prototype.finally=w.prototype.finally),e.exports=window.Promise):void 0!==m?(void 0===m.Promise?m.Promise=w:m.Promise.prototype.finally||(m.Promise.prototype.finally=w.prototype.finally),e.exports=m.Promise):e.exports=w}(_={path:undefined,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}()}}),_.exports),y=function(e){var t,n=e&&e.document,r={svg:"http://www.w3.org/2000/svg",math:"http://www.w3.org/1998/Math/MathML"};function i(e){return e.attrs&&e.attrs.xmlns||r[e.tag]}function s(e,t){if(e.state!==t)throw new Error("`vnode.state` must not be modified")}function a(e){var t=e.state;try{return this.apply(t,arguments)}finally{s(e,t)}}function l(){try{return n.activeElement}catch(e){return null}}function c(e,t,n,r,i,s,o){for(var a=n;a<r;a++){var l=t[a];null!=l&&u(e,l,i,o,s)}}function u(e,t,r,i,s){var o=t.tag;if("string"==typeof o)switch(t.state={},null!=t.attrs&&U(t.attrs,t,r),o){case"#":!function(e,t,r){t.dom=n.createTextNode(t.children),x(e,t.dom,r)}(e,t,s);break;case"<":d(e,t,i,s);break;case"[":!function(e,t,r,i,s){var o=n.createDocumentFragment();if(null!=t.children){var a=t.children;c(o,a,0,a.length,r,null,i)}t.dom=o.firstChild,t.domSize=o.childNodes.length,x(e,o,s)}(e,t,r,i,s);break;default:h(e,t,r,i,s)}else!function(e,t,n,r,i){p(t,n),null!=t.instance?(u(e,t.instance,n,r,i),t.dom=t.instance.dom,t.domSize=null!=t.dom?t.instance.domSize:0):t.domSize=0}(e,t,r,i,s)}var f={caption:"table",thead:"table",tbody:"table",tfoot:"table",tr:"tbody",th:"tr",td:"tr",colgroup:"table",col:"colgroup"};function d(e,t,r,i){var s=t.children.match(/^\s*?<(\w+)/im)||[],o=n.createElement(f[s[1]]||"div");"http://www.w3.org/2000/svg"===r?(o.innerHTML='<svg xmlns="http://www.w3.org/2000/svg">'+t.children+"</svg>",o=o.firstChild):o.innerHTML=t.children,t.dom=o.firstChild,t.domSize=o.childNodes.length,t.instance=[];for(var a,l=n.createDocumentFragment();a=o.firstChild;)t.instance.push(a),l.appendChild(a);x(e,l,i)}function h(e,t,r,s,a){var l=t.tag,u=t.attrs,f=u&&u.is,d=(s=i(t)||s)?f?n.createElementNS(s,l,{is:f}):n.createElementNS(s,l):f?n.createElement(l,{is:f}):n.createElement(l);if(t.dom=d,null!=u&&function(e,t,n){for(var r in t)N(e,r,null,t[r],n)}(t,u,s),x(e,d,a),!D(t)&&(null!=t.text&&(""!==t.text?d.textContent=t.text:t.children=[o("#",void 0,void 0,t.text,void 0,void 0)]),null!=t.children)){var h=t.children;c(d,h,0,h.length,r,null,s),"select"===t.tag&&null!=u&&function(e,t){if("value"in t)if(null===t.value)-1!==e.dom.selectedIndex&&(e.dom.value=null);else{var n=""+t.value;e.dom.value===n&&-1!==e.dom.selectedIndex||(e.dom.value=n)}"selectedIndex"in t&&N(e,"selectedIndex",null,t.selectedIndex,void 0)}(t,u)}}function p(e,t){var n;if("function"==typeof e.tag.view){if(e.state=Object.create(e.tag),null!=(n=e.state.view).$$reentrantLock$$)return;n.$$reentrantLock$$=!0}else{if(e.state=void 0,null!=(n=e.tag).$$reentrantLock$$)return;n.$$reentrantLock$$=!0,e.state=null!=e.tag.prototype&&"function"==typeof e.tag.prototype.view?new e.tag(e):e.tag(e)}if(U(e.state,e,t),null!=e.attrs&&U(e.attrs,e,t),e.instance=o.normalize(a.call(e.state.view,e)),e.instance===e)throw Error("A view cannot return the vnode it received as argument");n.$$reentrantLock$$=null}function g(e,t,n,r,i,s){if(t!==n&&(null!=t||null!=n))if(null==t||0===t.length)c(e,n,0,n.length,r,i,s);else if(null==n||0===n.length)k(e,t,0,t.length);else{var o=null!=t[0]&&null!=t[0].key,a=null!=n[0]&&null!=n[0].key,l=0,f=0;if(!o)for(;f<t.length&&null==t[f];)f++;if(!a)for(;l<n.length&&null==n[l];)l++;if(null===a&&null==o)return;if(o!==a)k(e,t,f,t.length),c(e,n,l,n.length,r,i,s);else if(a){for(var d,h,p,g,v,_=t.length-1,S=n.length-1;_>=f&&S>=l&&(p=t[_],g=n[S],p.key===g.key);)p!==g&&m(e,p,g,r,i,s),null!=g.dom&&(i=g.dom),_--,S--;for(;_>=f&&S>=l&&(d=t[f],h=n[l],d.key===h.key);)f++,l++,d!==h&&m(e,d,h,r,y(t,f,i),s);for(;_>=f&&S>=l&&l!==S&&d.key===g.key&&p.key===h.key;)A(e,p,v=y(t,f,i)),p!==h&&m(e,p,h,r,v,s),++l<=--S&&A(e,d,i),d!==g&&m(e,d,g,r,i,s),null!=g.dom&&(i=g.dom),f++,p=t[--_],g=n[S],d=t[f],h=n[l];for(;_>=f&&S>=l&&p.key===g.key;)p!==g&&m(e,p,g,r,i,s),null!=g.dom&&(i=g.dom),S--,p=t[--_],g=n[S];if(l>S)k(e,t,f,_+1);else if(f>_)c(e,n,l,S+1,r,i,s);else{var x,D,C=i,E=S-l+1,P=new Array(E),N=0,j=0,z=2147483647,I=0;for(j=0;j<E;j++)P[j]=-1;for(j=S;j>=l;j--){null==x&&(x=w(t,f,_+1));var T=x[(g=n[j]).key];null!=T&&(z=T<z?T:-1,P[j-l]=T,p=t[T],t[T]=null,p!==g&&m(e,p,g,r,i,s),null!=g.dom&&(i=g.dom),I++)}if(i=C,I!==_-f+1&&k(e,t,f,_+1),0===I)c(e,n,l,S+1,r,i,s);else if(-1===z)for(N=(D=function(e){var t=[0],n=0,r=0,i=0,s=b.length=e.length;for(i=0;i<s;i++)b[i]=e[i];for(i=0;i<s;++i)if(-1!==e[i]){var o=t[t.length-1];if(e[o]<e[i])b[i]=o,t.push(i);else{for(n=0,r=t.length-1;n<r;){var a=(n>>>1)+(r>>>1)+(n&r&1);e[t[a]]<e[i]?n=a+1:r=a}e[i]<e[t[n]]&&(n>0&&(b[i]=t[n-1]),t[n]=i)}}for(r=t[(n=t.length)-1];n-- >0;)t[n]=r,r=b[r];return b.length=0,t}(P)).length-1,j=S;j>=l;j--)h=n[j],-1===P[j-l]?u(e,h,r,s,i):D[N]===j-l?N--:A(e,h,i),null!=h.dom&&(i=n[j].dom);else for(j=S;j>=l;j--)h=n[j],-1===P[j-l]&&u(e,h,r,s,i),null!=h.dom&&(i=n[j].dom)}}else{var M=t.length<n.length?t.length:n.length;for(l=l<f?l:f;l<M;l++)(d=t[l])===(h=n[l])||null==d&&null==h||(null==d?u(e,h,r,s,y(t,l+1,i)):null==h?O(e,d):m(e,d,h,r,y(t,l+1,i),s));t.length>M&&k(e,t,l,t.length),n.length>M&&c(e,n,l,n.length,r,i,s)}}}function m(e,t,n,r,i,s){var o=t.tag;if(o===n.tag){if(n.state=t.state,n.events=t.events,function(e,t){do{var n;if(null!=e.attrs&&"function"==typeof e.attrs.onbeforeupdate&&void 0!==(n=a.call(e.attrs.onbeforeupdate,e,t))&&!n)break;if("string"!=typeof e.tag&&"function"==typeof e.state.onbeforeupdate&&void 0!==(n=a.call(e.state.onbeforeupdate,e,t))&&!n)break;return!1}while(0);return e.dom=t.dom,e.domSize=t.domSize,e.instance=t.instance,e.attrs=t.attrs,e.children=t.children,e.text=t.text,!0}(n,t))return;if("string"==typeof o)switch(null!=n.attrs&&F(n.attrs,n,r),o){case"#":!function(e,t){e.children.toString()!==t.children.toString()&&(e.dom.nodeValue=t.children),t.dom=e.dom}(t,n);break;case"<":!function(e,t,n,r,i){t.children!==n.children?(C(e,t),d(e,n,r,i)):(n.dom=t.dom,n.domSize=t.domSize,n.instance=t.instance)}(e,t,n,s,i);break;case"[":!function(e,t,n,r,i,s){g(e,t.children,n.children,r,i,s);var o=0,a=n.children;if(n.dom=null,null!=a){for(var l=0;l<a.length;l++){var c=a[l];null!=c&&null!=c.dom&&(null==n.dom&&(n.dom=c.dom),o+=c.domSize||1)}1!==o&&(n.domSize=o)}}(e,t,n,r,i,s);break;default:v(t,n,r,s)}else _(e,t,n,r,i,s)}else O(e,t),u(e,n,r,s,i)}function v(e,t,n,r){var s=t.dom=e.dom;r=i(t)||r,"textarea"===t.tag&&(null==t.attrs&&(t.attrs={}),null!=t.text&&(t.attrs.value=t.text,t.text=void 0)),function(e,t,n,r){if(null!=n)for(var i in n)N(e,i,t&&t[i],n[i],r);var s;if(null!=t)for(var i in t)null==(s=t[i])||null!=n&&null!=n[i]||j(e,i,s,r)}(t,e.attrs,t.attrs,r),D(t)||(null!=e.text&&null!=t.text&&""!==t.text?e.text.toString()!==t.text.toString()&&(e.dom.firstChild.nodeValue=t.text):(null!=e.text&&(e.children=[o("#",void 0,void 0,e.text,void 0,e.dom.firstChild)]),null!=t.text&&(t.children=[o("#",void 0,void 0,t.text,void 0,void 0)]),g(s,e.children,t.children,n,null,r)))}function _(e,t,n,r,i,s){if(n.instance=o.normalize(a.call(n.state.view,n)),n.instance===n)throw Error("A view cannot return the vnode it received as argument");F(n.state,n,r),null!=n.attrs&&F(n.attrs,n,r),null!=n.instance?(null==t.instance?u(e,n.instance,r,s,i):m(e,t.instance,n.instance,r,i,s),n.dom=n.instance.dom,n.domSize=n.instance.domSize):null!=t.instance?(O(e,t.instance),n.dom=void 0,n.domSize=0):(n.dom=t.dom,n.domSize=t.domSize)}function w(e,t,n){for(var r=Object.create(null);t<n;t++){var i=e[t];if(null!=i){var s=i.key;null!=s&&(r[s]=t)}}return r}var b=[];function y(e,t,n){for(;t<e.length;t++)if(null!=e[t]&&null!=e[t].dom)return e[t].dom;return n}function A(e,t,r){var i=n.createDocumentFragment();S(e,i,t),x(e,i,r)}function S(e,t,n){for(;null!=n.dom&&n.dom.parentNode===e;){if("string"!=typeof n.tag){if(null!=(n=n.instance))continue}else if("<"===n.tag)for(var r=0;r<n.instance.length;r++)t.appendChild(n.instance[r]);else if("["!==n.tag)t.appendChild(n.dom);else if(1===n.children.length){if(null!=(n=n.children[0]))continue}else for(r=0;r<n.children.length;r++){var i=n.children[r];null!=i&&S(e,t,i)}break}}function x(e,t,n){null!=n?e.insertBefore(t,n):e.appendChild(t)}function D(e){if(null==e.attrs||null==e.attrs.contenteditable&&null==e.attrs.contentEditable)return!1;var t=e.children;if(null!=t&&1===t.length&&"<"===t[0].tag){var n=t[0].children;e.dom.innerHTML!==n&&(e.dom.innerHTML=n)}else if(null!=e.text||null!=t&&0!==t.length)throw new Error("Child node of a contenteditable must be trusted");return!0}function k(e,t,n,r){for(var i=n;i<r;i++){var s=t[i];null!=s&&O(e,s)}}function O(e,t){var n,r,i,o=0,l=t.state;if("string"!=typeof t.tag&&"function"==typeof t.state.onbeforeremove&&null!=(i=a.call(t.state.onbeforeremove,t))&&"function"==typeof i.then&&(o=1,n=i),t.attrs&&"function"==typeof t.attrs.onbeforeremove&&null!=(i=a.call(t.attrs.onbeforeremove,t))&&"function"==typeof i.then&&(o|=2,r=i),s(t,l),o){if(null!=n){var c=function(){1&o&&((o&=2)||u())};n.then(c,c)}null!=r&&(c=function(){2&o&&((o&=1)||u())},r.then(c,c))}else P(t),E(e,t);function u(){s(t,l),P(t),E(e,t)}}function C(e,t){for(var n=0;n<t.instance.length;n++)e.removeChild(t.instance[n])}function E(e,t){for(;null!=t.dom&&t.dom.parentNode===e;){if("string"!=typeof t.tag){if(null!=(t=t.instance))continue}else if("<"===t.tag)C(e,t);else{if("["!==t.tag&&(e.removeChild(t.dom),!Array.isArray(t.children)))break;if(1===t.children.length){if(null!=(t=t.children[0]))continue}else for(var n=0;n<t.children.length;n++){var r=t.children[n];null!=r&&E(e,r)}}break}}function P(e){if("string"!=typeof e.tag&&"function"==typeof e.state.onremove&&a.call(e.state.onremove,e),e.attrs&&"function"==typeof e.attrs.onremove&&a.call(e.attrs.onremove,e),"string"!=typeof e.tag)null!=e.instance&&P(e.instance);else{var t=e.children;if(Array.isArray(t))for(var n=0;n<t.length;n++){var r=t[n];null!=r&&P(r)}}}function N(e,t,r,i,s){if("key"!==t&&"is"!==t&&null!=i&&!z(t)&&(r!==i||function(e,t){return"value"===t||"checked"===t||"selectedIndex"===t||"selected"===t&&e.dom===l()||"option"===e.tag&&e.dom.parentNode===n.activeElement}(e,t)||"object"==typeof i)){if("o"===t[0]&&"n"===t[1])return B(e,t,i);if("xlink:"===t.slice(0,6))e.dom.setAttributeNS("http://www.w3.org/1999/xlink",t.slice(6),i);else if("style"===t)R(e.dom,r,i);else if(I(e,t,s)){if("value"===t){if(("input"===e.tag||"textarea"===e.tag)&&e.dom.value===""+i&&e.dom===l())return;if("select"===e.tag&&null!==r&&e.dom.value===""+i)return;if("option"===e.tag&&null!==r&&e.dom.value===""+i)return}"input"===e.tag&&"type"===t?e.dom.setAttribute(t,i):e.dom[t]=i}else"boolean"==typeof i?i?e.dom.setAttribute(t,""):e.dom.removeAttribute(t):e.dom.setAttribute("className"===t?"class":t,i)}}function j(e,t,n,r){if("key"!==t&&"is"!==t&&null!=n&&!z(t))if("o"!==t[0]||"n"!==t[1]||z(t))if("style"===t)R(e.dom,n,null);else if(!I(e,t,r)||"className"===t||"value"===t&&("option"===e.tag||"select"===e.tag&&-1===e.dom.selectedIndex&&e.dom===l())||"input"===e.tag&&"type"===t){var i=t.indexOf(":");-1!==i&&(t=t.slice(i+1)),!1!==n&&e.dom.removeAttribute("className"===t?"class":t)}else e.dom[t]=null;else B(e,t,void 0)}function z(e){return"oninit"===e||"oncreate"===e||"onupdate"===e||"onremove"===e||"onbeforeremove"===e||"onbeforeupdate"===e}function I(e,t,n){return void 0===n&&(e.tag.indexOf("-")>-1||null!=e.attrs&&e.attrs.is||"href"!==t&&"list"!==t&&"form"!==t&&"width"!==t&&"height"!==t)&&t in e.dom}var T=/[A-Z]/g;function M(e){return"-"+e.toLowerCase()}function L(e){return"-"===e[0]&&"-"===e[1]?e:"cssFloat"===e?"float":e.replace(T,M)}function R(e,t,n){if(t===n);else if(null==n)e.style.cssText="";else if("object"!=typeof n)e.style.cssText=n;else if(null==t||"object"!=typeof t)for(var r in e.style.cssText="",n)null!=(i=n[r])&&e.style.setProperty(L(r),String(i));else{for(var r in n){var i;null!=(i=n[r])&&(i=String(i))!==String(t[r])&&e.style.setProperty(L(r),i)}for(var r in t)null!=t[r]&&null==n[r]&&e.style.removeProperty(L(r))}}function $(){this._=t}function B(e,t,n){if(null!=e.events){if(e.events[t]===n)return;null==n||"function"!=typeof n&&"object"!=typeof n?(null!=e.events[t]&&e.dom.removeEventListener(t.slice(2),e.events,!1),e.events[t]=void 0):(null==e.events[t]&&e.dom.addEventListener(t.slice(2),e.events,!1),e.events[t]=n)}else null==n||"function"!=typeof n&&"object"!=typeof n||(e.events=new $,e.dom.addEventListener(t.slice(2),e.events,!1),e.events[t]=n)}function U(e,t,n){"function"==typeof e.oninit&&a.call(e.oninit,t),"function"==typeof e.oncreate&&n.push(a.bind(e.oncreate,t))}function F(e,t,n){"function"==typeof e.onupdate&&n.push(a.bind(e.onupdate,t))}return $.prototype=Object.create(null),$.prototype.handleEvent=function(e){var t,n=this["on"+e.type];"function"==typeof n?t=n.call(e.currentTarget,e):"function"==typeof n.handleEvent&&n.handleEvent(e),this._&&!1!==e.redraw&&(0,this._)(),!1===t&&(e.preventDefault(),e.stopPropagation())},function(e,n,r){if(!e)throw new TypeError("Ensure the DOM element being passed to m.route/m.mount/m.render is not undefined.");var i=[],s=l(),a=e.namespaceURI;null==e.vnodes&&(e.textContent=""),n=o.normalizeChildren(Array.isArray(n)?n:[n]);var c=t;try{t="function"==typeof r?r:void 0,g(e,e.vnodes,n,i,null,"http://www.w3.org/1999/xhtml"===a?void 0:a)}finally{t=c}e.vnodes=n,null!=s&&l()!==s&&"function"==typeof s.focus&&s.focus();for(var u=0;u<i.length;u++)i[u]()}}(window),A=function(e,t,n){var r=[],i=!1,s=!1;function a(){if(i)throw new Error("Nested m.redraw.sync() call");i=!0;for(var t=0;t<r.length;t+=2)try{e(r[t],o(r[t+1]),l)}catch(e){n.error(e)}i=!1}function l(){s||(s=!0,t((function(){s=!1,a()})))}return l.sync=a,{mount:function(t,n){if(null!=n&&null==n.view&&"function"!=typeof n)throw new TypeError("m.mount(element, component) expects a component, not a vnode");var i=r.indexOf(t);i>=0&&(r.splice(i,2),e(t,[],l)),null!=n&&(r.push(t,n),e(t,o(n),l))},redraw:l}}(y,requestAnimationFrame,console),S=function(e){if("[object Object]"!==Object.prototype.toString.call(e))return"";var t=[];for(var n in e)r(n,e[n]);return t.join("&");function r(e,n){if(Array.isArray(n))for(var i=0;i<n.length;i++)r(e+"["+i+"]",n[i]);else if("[object Object]"===Object.prototype.toString.call(n))for(var i in n)r(e+"["+i+"]",n[i]);else t.push(encodeURIComponent(e)+(null!=n&&""!==n?"="+encodeURIComponent(n):""))}},x=Object.assign||function(e,t){t&&Object.keys(t).forEach((function(n){e[n]=t[n]}))},D=function(e,t){if(/:([^\/\.-]+)(\.{3})?:/.test(e))throw new SyntaxError("Template parameter names *must* be separated");if(null==t)return e;var n=e.indexOf("?"),r=e.indexOf("#"),i=r<0?e.length:r,s=n<0?i:n,o=e.slice(0,s),a={};x(a,t);var l=o.replace(/:([^\/\.-]+)(\.{3})?/g,(function(e,n,r){return delete a[n],null==t[n]?e:r?t[n]:encodeURIComponent(String(t[n]))})),c=l.indexOf("?"),u=l.indexOf("#"),f=u<0?l.length:u,d=c<0?f:c,h=l.slice(0,d);n>=0&&(h+=e.slice(n,i)),c>=0&&(h+=(n<0?"?":"&")+l.slice(c,f));var p=S(a);return p&&(h+=(n<0&&c<0?"?":"&")+p),r>=0&&(h+=e.slice(r)),u>=0&&(h+=(r<0?"":"&")+l.slice(u)),h},k=function(e,t,n){var r=0;function i(e){return new t(e)}function s(e){return function(r,s){"string"!=typeof r?(s=r,r=r.url):null==s&&(s={});var o=new t((function(t,n){e(D(r,s.params),s,(function(e){if("function"==typeof s.type)if(Array.isArray(e))for(var n=0;n<e.length;n++)e[n]=new s.type(e[n]);else e=new s.type(e);t(e)}),n)}));if(!0===s.background)return o;var a=0;function l(){0==--a&&"function"==typeof n&&n()}return function e(t){var n=t.then;return t.constructor=i,t.then=function(){a++;var r=n.apply(t,arguments);return r.then(l,(function(e){if(l(),0===a)throw e})),e(r)},t}(o)}}function o(e,t){for(var n in e.headers)if({}.hasOwnProperty.call(e.headers,n)&&t.test(n))return!0;return!1}return i.prototype=t.prototype,i.__proto__=t,{request:s((function(t,n,r,i){var s,a=null!=n.method?n.method.toUpperCase():"GET",l=n.body,c=!(null!=n.serialize&&n.serialize!==JSON.serialize||l instanceof e.FormData),u=n.responseType||("function"==typeof n.extract?"":"json"),f=new e.XMLHttpRequest,d=!1,h=f,p=f.abort;for(var g in f.abort=function(){d=!0,p.call(this)},f.open(a,t,!1!==n.async,"string"==typeof n.user?n.user:void 0,"string"==typeof n.password?n.password:void 0),c&&null!=l&&!o(n,/^content-type$/i)&&f.setRequestHeader("Content-Type","application/json; charset=utf-8"),"function"==typeof n.deserialize||o(n,/^accept$/i)||f.setRequestHeader("Accept","application/json, text/*"),n.withCredentials&&(f.withCredentials=n.withCredentials),n.timeout&&(f.timeout=n.timeout),f.responseType=u,n.headers)({}).hasOwnProperty.call(n.headers,g)&&f.setRequestHeader(g,n.headers[g]);f.onreadystatechange=function(e){if(!d&&4===e.target.readyState)try{var s,o=e.target.status>=200&&e.target.status<300||304===e.target.status||/^file:\/\//i.test(t),a=e.target.response;if("json"===u?e.target.responseType||"function"==typeof n.extract||(a=JSON.parse(e.target.responseText)):u&&"text"!==u||null==a&&(a=e.target.responseText),"function"==typeof n.extract?(a=n.extract(e.target,n),o=!0):"function"==typeof n.deserialize&&(a=n.deserialize(a)),o)r(a);else{try{s=e.target.responseText}catch(e){s=a}var l=new Error(s);l.code=e.target.status,l.response=a,i(l)}}catch(e){i(e)}},"function"==typeof n.config&&(f=n.config(f,n,t)||f)!==h&&(s=f.abort,f.abort=function(){d=!0,s.call(this)}),null==l?f.send():"function"==typeof n.serialize?f.send(n.serialize(l)):l instanceof e.FormData?f.send(l):f.send(JSON.stringify(l))})),jsonp:s((function(t,n,i,s){var o=n.callbackName||"_mithril_"+Math.round(1e16*Math.random())+"_"+r++,a=e.document.createElement("script");e[o]=function(t){delete e[o],a.parentNode.removeChild(a),i(t)},a.onerror=function(){delete e[o],a.parentNode.removeChild(a),s(new Error("JSONP request failed"))},a.src=t+(t.indexOf("?")<0?"?":"&")+encodeURIComponent(n.callbackKey||"callback")+"="+encodeURIComponent(o),e.document.documentElement.appendChild(a)}))}}(window,b,A.redraw),O=function(e){if(""===e||null==e)return{};"?"===e.charAt(0)&&(e=e.slice(1));for(var t=e.split("&"),n={},r={},i=0;i<t.length;i++){var s=t[i].split("="),o=decodeURIComponent(s[0]),a=2===s.length?decodeURIComponent(s[1]):"";"true"===a?a=!0:"false"===a&&(a=!1);var l=o.split(/\]\[?|\[/),c=r;o.indexOf("[")>-1&&l.pop();for(var u=0;u<l.length;u++){var f=l[u],d=l[u+1],h=""==d||!isNaN(parseInt(d,10));if(""===f)null==n[o=l.slice(0,u).join()]&&(n[o]=Array.isArray(c)?c.length:0),f=n[o]++;else if("__proto__"===f)break;if(u===l.length-1)c[f]=a;else{var p=Object.getOwnPropertyDescriptor(c,f);null!=p&&(p=p.value),null==p&&(c[f]=p=h?[]:{}),c=p}}}return r},C=function(e){var t=e.indexOf("?"),n=e.indexOf("#"),r=n<0?e.length:n,i=t<0?r:t,s=e.slice(0,i).replace(/\/{2,}/g,"/");return s?("/"!==s[0]&&(s="/"+s),s.length>1&&"/"===s[s.length-1]&&(s=s.slice(0,-1))):s="/",{path:s,params:t<0?{}:O(e.slice(t+1,r))}},E=function(e){var t=C(e),n=Object.keys(t.params),r=[],i=new RegExp("^"+t.path.replace(/:([^\/.-]+)(\.{3}|\.(?!\.)|-)?|[\\^$*+.()|\[\]{}]/g,(function(e,t,n){return null==t?"\\"+e:(r.push({k:t,r:"..."===n}),"..."===n?"(.*)":"."===n?"([^/]+)\\.":"([^/]+)"+(n||""))}))+"$");return function(e){for(var s=0;s<n.length;s++)if(t.params[n[s]]!==e.params[n[s]])return!1;if(!r.length)return i.test(e.path);var o=i.exec(e.path);if(null==o)return!1;for(s=0;s<r.length;s++)e.params[r[s].k]=r[s].r?o[s+1]:decodeURIComponent(o[s+1]);return!0}},P={},N=function(e,t){var n;function r(t,r,i){if(t=D(t,r),null!=n){n();var s=i?i.state:null,o=i?i.title:null;i&&i.replace?e.history.replaceState(s,o,f.prefix+t):e.history.pushState(s,o,f.prefix+t)}else e.location.href=f.prefix+t}var i,s,a,l,c=P,u=f.SKIP={};function f(d,h,p){if(null==d)throw new Error("Ensure the DOM element that was passed to `m.route` is not undefined");var g,m=0,v=Object.keys(p).map((function(e){if("/"!==e[0])throw new SyntaxError("Routes must start with a `/`");if(/:([^\/\.-]+)(\.{3})?:/.test(e))throw new SyntaxError("Route parameter names must be separated with either `/`, `.`, or `-`");return{route:e,component:p[e],check:E(e)}})),_="function"==typeof setImmediate?setImmediate:setTimeout,w=b.resolve(),y=!1;if(n=null,null!=h){var A=C(h);if(!v.some((function(e){return e.check(A)})))throw new ReferenceError("Default route doesn't match any known routes")}function S(){y=!1;var n=e.location.hash;"#"!==f.prefix[0]&&(n=e.location.search+n,"?"!==f.prefix[0]&&"/"!==(n=e.location.pathname+n)[0]&&(n="/"+n));var o=n.concat().replace(/(?:%[a-f89][a-f0-9])+/gim,decodeURIComponent).slice(f.prefix.length),d=C(o);function p(){if(o===h)throw new Error("Could not resolve default route "+h);r(h,null,{replace:!0})}x(d.params,e.history.state),function e(n){for(;n<v.length;n++)if(v[n].check(d)){var r=v[n].component,f=v[n].route,h=r,g=l=function(f){if(g===l){if(f===u)return e(n+1);i=null==f||"function"!=typeof f.view&&"function"!=typeof f?"div":f,s=d.params,a=o,l=null,c=r.render?r:null,2===m?t.redraw():(m=2,t.redraw.sync())}};return void(r.view||"function"==typeof r?(r={},g(h)):r.onmatch?w.then((function(){return r.onmatch(d.params,o,f)})).then(g,p):g("div"))}p()}(0)}return n=function(){y||(y=!0,_(S))},"function"==typeof e.history.pushState?(g=function(){e.removeEventListener("popstate",n,!1)},e.addEventListener("popstate",n,!1)):"#"===f.prefix[0]&&(n=null,g=function(){e.removeEventListener("hashchange",S,!1)},e.addEventListener("hashchange",S,!1)),t.mount(d,{onbeforeupdate:function(){return!(!(m=m?2:1)||P===c)},oncreate:S,onremove:g,view:function(){if(m&&P!==c){var e=[o(i,s.key,s)];return c&&(e=c.render(e[0])),e}}})}return f.set=function(e,t,n){null!=l&&((n=n||{}).replace=!0),l=null,r(e,t,n)},f.get=function(){return a},f.prefix="#!",f.Link={view:function(e){var t,n,r=e.attrs.options,i={};x(i,e.attrs),i.selector=i.options=i.key=i.oninit=i.oncreate=i.onbeforeupdate=i.onupdate=i.onbeforeremove=i.onremove=null;var s=p(e.attrs.selector||"a",i,e.children);return(s.attrs.disabled=Boolean(s.attrs.disabled))?(s.attrs.href=null,s.attrs["aria-disabled"]="true",s.attrs.onclick=null):(t=s.attrs.onclick,n=s.attrs.href,s.attrs.href=f.prefix+n,s.attrs.onclick=function(e){var i;"function"==typeof t?i=t.call(e.currentTarget,e):null==t||"object"!=typeof t||"function"==typeof t.handleEvent&&t.handleEvent(e),!1===i||e.defaultPrevented||0!==e.button&&0!==e.which&&1!==e.which||e.currentTarget.target&&"_self"!==e.currentTarget.target||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||(e.preventDefault(),e.redraw=!1,f.set(n,null,r))}),s}},f.param=function(e){return s&&null!=e?s[e]:s},f}(window,A),j=function(){return g.apply(this,arguments)};j.m=g,j.trust=g.trust,j.fragment=g.fragment,j.mount=A.mount,j.route=N,j.render=y,j.redraw=A.redraw,j.request=k.request,j.jsonp=k.jsonp,j.parseQueryString=O,j.buildQueryString=S,j.parsePathname=C,j.buildPathname=D,j.vnode=o,j.PromisePolyfill=w;var z=j;const I=()=>({view:e=>{const t={[e.attrs.page]:"active"},n=[];window.authorizer.hasAccess("devices",1)&&n.push(z("li",{class:t.overview},z("a",{href:"#!/overview"},"Overview"))),window.authorizer.hasAccess("devices",2)&&n.push(z("li",{class:t.devices},z("a",{href:"#!/devices"},"Devices"))),window.authorizer.hasAccess("faults",2)&&n.push(z("li",{class:t.faults},z("a",{href:"#!/faults"},"Faults")));const r=["presets","provisions","virtualParameters","files"];for(const e of r)if(window.authorizer.hasAccess(e,2)){n.push(z("li",{class:t.admin},z("a",{href:"#!/admin"},"Admin")));break}return z("nav",z("ul",n))}});function T(e){if(!(this instanceof T))return new T(e);this._=e}var M=T.prototype;function L(e,t){for(var n=0;n<e;n++)t(n)}function R(e,t,n){return function(e,t){L(t.length,(function(n){e(t[n],n,t)}))}((function(n,r,i){t=e(t,n,r,i)}),n),t}function $(e,t){return R((function(t,n,r,i){return t.concat([e(n,r,i)])}),[],t)}function B(e){var t=R((function(e,t,n,r){return e.concat(n===r.length-1?Buffer.from([t,0]).readUInt16BE(0):r.readUInt16BE(n))}),[],e);return Buffer.from($((function(e){return(e<<1&65535)>>8}),t))}function U(e){return e[0]>>7}function F(){return"undefined"!=typeof Buffer}function q(){if(!F())throw new Error("Buffer global does not exist; please use webpack if you need to parse Buffers in the browser.")}function W(e){q();var t=R((function(e,t){return e+t}),0,e);if(t%8!=0)throw new Error("The bits ["+e.join(", ")+"] add up to "+t+" which is not an even number of bytes; the total should be divisible by 8");var n,r=t/8,i=(n=function(e){return e>48},R((function(e,t){return e||(n(t)?t:e)}),null,e));if(i)throw new Error(i+" bit range requested exceeds 48 bit (6 byte) Number max.");return new T((function(t,n){var i=r+n;return i>t.length?ne(n,r.toString()+" bytes"):te(i,R((function(e,t){var n=function(e,t){var n={v:0,buf:t};return L(e,(function(){n={v:n.v<<1|U(n.buf),buf:B(n.buf)}})),n}(t,e.buf);return{coll:e.coll.concat(n.v),buf:n.buf}}),{coll:[],buf:t.slice(n,i)},e).coll)}))}function J(e,t){return new T((function(n,r){return q(),r+t>n.length?ne(r,t+" bytes for "+e):te(r+t,n.slice(r,r+t))}))}function V(e,t){if("number"!=typeof(n=t)||Math.floor(n)!==n||t<0||t>6)throw new Error(e+" requires integer length in range [0, 6].");var n}function H(e){return V("uintBE",e),J("uintBE("+e+")",e).map((function(t){return t.readUIntBE(0,e)}))}function K(e){return V("uintLE",e),J("uintLE("+e+")",e).map((function(t){return t.readUIntLE(0,e)}))}function G(e){return V("intBE",e),J("intBE("+e+")",e).map((function(t){return t.readIntBE(0,e)}))}function Q(e){return V("intLE",e),J("intLE("+e+")",e).map((function(t){return t.readIntLE(0,e)}))}function Y(e){return Array.prototype.slice.call(e)}function Z(e){return e instanceof T}function X(e){return"[object Array]"==={}.toString.call(e)}function ee(e){return F()&&Buffer.isBuffer(e)}function te(e,t){return{status:!0,index:e,value:t,furthest:-1,expected:[]}}function ne(e,t){return X(t)||(t=[t]),{status:!1,index:-1,value:null,furthest:e,expected:t}}function re(e,t){if(!t)return e;if(e.furthest>t.furthest)return e;var n=e.furthest===t.furthest?function(e,t){if(function(){if(void 0!==T._supportsSet)return T._supportsSet;var e="undefined"!=typeof Set;return T._supportsSet=e,e}()&&Array.from){for(var n=new Set(e),r=0;r<t.length;r++)n.add(t[r]);var i=Array.from(n);return i.sort(),i}for(var s={},o=0;o<e.length;o++)s[e[o]]=!0;for(var a=0;a<t.length;a++)s[t[a]]=!0;var l=[];for(var c in s)({}).hasOwnProperty.call(s,c)&&l.push(c);return l.sort(),l}(e.expected,t.expected):t.expected;return{status:e.status,index:e.index,value:e.value,furthest:t.furthest,expected:n}}var ie={};function se(e,t){if(ee(e))return{offset:t,line:-1,column:-1};if(ie.input===e&&ie.i===t)return ie.value;var n=e.slice(0,t).split("\n"),r={offset:t,line:n.length,column:n[n.length-1].length+1};return ie.input=e,ie.i=t,ie.value=r,r}function oe(e){if(!Z(e))throw new Error("not a parser: "+e)}function ae(e,t){return"string"==typeof e?e.charAt(t):e[t]}function le(e){if("number"!=typeof e)throw new Error("not a number: "+e)}function ce(e){if(!(e instanceof RegExp))throw new Error("not a regexp: "+e);for(var t=ve(e),n=0;n<t.length;n++){var r=t.charAt(n);if("i"!==r&&"m"!==r&&"u"!==r&&"s"!==r)throw new Error('unsupported regexp flag "'+r+'": '+e)}}function ue(e){if("function"!=typeof e)throw new Error("not a function: "+e)}function fe(e){if("string"!=typeof e)throw new Error("not a string: "+e)}function de(e,t){return new Array(t+1).join(e)}function he(e,t,n){var r=t-e.length;return r<=0?e:de(n,r)+e}function pe(e,t,n,r){return{from:e-t>0?e-t:0,to:e+n>r?r:e+n}}function ge(e,t){var n,r,i,s,o,a=t.index,l=a.offset,c=1;if(l===e.length)return"Got the end of the input";if(ee(e)){var u=l-l%8,f=l-u,d=pe(u,40,40,e.length),h=$((function(e){return $((function(e){return he(e.toString(16),2,"0")}),e)}),function(e,t){var n=e.length,r=[],i=0;if(n<=8)return[e.slice()];for(var s=0;s<n;s++)r[i]||r.push([]),r[i].push(e[s]),(s+1)%8==0&&i++;return r}(e.slice(d.from,d.to).toJSON().data));s=function(e){return 0===e.from&&1===e.to?{from:e.from,to:e.to}:{from:e.from/8,to:Math.floor(e.to/8)}}(d),r=u/8,n=3*f,f>=4&&(n+=1),c=2,i=$((function(e){return e.length<=4?e.join(" "):e.slice(0,4).join(" ")+"  "+e.slice(4).join(" ")}),h),(o=(8*(s.to>0?s.to-1:s.to)).toString(16).length)<2&&(o=2)}else{var p=e.split(/\r\n|[\n\r\u2028\u2029]/);n=a.column-1,r=a.line-1,s=pe(r,2,3,p.length),i=p.slice(s.from,s.to),o=s.to.toString().length}var g=r-s.from;return ee(e)&&(o=(8*(s.to>0?s.to-1:s.to)).toString(16).length)<2&&(o=2),R((function(t,r,i){var a,l=i===g,u=l?"> ":"  ";return a=ee(e)?he((8*(s.from+i)).toString(16),o,"0"):he((s.from+i+1).toString(),o," "),[].concat(t,[u+a+" | "+r],l?["  "+de(" ",o)+" | "+he("",n," ")+de("^",c)]:[])}),[],i).join("\n")}function me(e,t){return["\n","-- PARSING FAILED "+de("-",50),"\n\n",ge(e,t),"\n\n",(n=t.expected,1===n.length?"Expected:\n\n"+n[0]:"Expected one of the following: \n\n"+n.join(", ")),"\n"].join("");var n}function ve(e){return void 0!==e.flags?e.flags:[e.global?"g":"",e.ignoreCase?"i":"",e.multiline?"m":"",e.unicode?"u":"",e.sticky?"y":""].join("")}function _e(e){return RegExp("^(?:"+e.source+")",ve(e))}function we(){for(var e=[].slice.call(arguments),t=e.length,n=0;n<t;n+=1)oe(e[n]);return T((function(n,r){for(var i,s=new Array(t),o=0;o<t;o+=1){if(!(i=re(e[o]._(n,r),i)).status)return i;s[o]=i.value,r=i.index}return re(te(r,s),i)}))}function be(){var e=[].slice.call(arguments);if(0===e.length)throw new Error("seqMap needs at least one argument");var t=e.pop();return ue(t),we.apply(null,e).map((function(e){return t.apply(null,e)}))}function ye(){var e=[].slice.call(arguments),t=e.length;if(0===t)return Oe("zero alternates");for(var n=0;n<t;n+=1)oe(e[n]);return T((function(t,n){for(var r,i=0;i<e.length;i+=1)if((r=re(e[i]._(t,n),r)).status)return r;return r}))}function Ae(e,t){return Se(e,t).or(ke([]))}function Se(e,t){return oe(e),oe(t),be(e,t.then(e).many(),(function(e,t){return[e].concat(t)}))}function xe(e){fe(e);var t="'"+e+"'";return T((function(n,r){var i=r+e.length,s=n.slice(r,i);return s===e?te(i,s):ne(r,t)}))}function De(e,t){ce(e),arguments.length>=2?le(t):t=0;var n=_e(e),r=""+e;return T((function(e,i){var s=n.exec(e.slice(i));if(s){if(0<=t&&t<=s.length){var o=s[0],a=s[t];return te(i+o.length,a)}return ne(i,"valid match group (0 to "+s.length+") in "+r)}return ne(i,r)}))}function ke(e){return T((function(t,n){return te(n,e)}))}function Oe(e){return T((function(t,n){return ne(n,e)}))}function Ce(e){if(Z(e))return T((function(t,n){var r=e._(t,n);return r.index=n,r.value="",r}));if("string"==typeof e)return Ce(xe(e));if(e instanceof RegExp)return Ce(De(e));throw new Error("not a string, regexp, or parser: "+e)}function Ee(e){return oe(e),T((function(t,n){var r=e._(t,n),i=t.slice(n,r.index);return r.status?ne(n,'not "'+i+'"'):te(n,null)}))}function Pe(e){return ue(e),T((function(t,n){var r=ae(t,n);return n<t.length&&e(r)?te(n+1,r):ne(n,"a character/byte matching "+e)}))}function Ne(e,t){arguments.length<2&&(t=e,e=void 0);var n=T((function(e,r){return n._=t()._,n._(e,r)}));return e?n.desc(e):n}function je(){return Oe("fantasy-land/empty")}M.parse=function(e){if("string"!=typeof e&&!ee(e))throw new Error(".parse must be called with a string or Buffer as its argument");var t=this.skip(Me)._(e,0);return t.status?{status:!0,value:t.value}:{status:!1,index:se(e,t.furthest),expected:t.expected}},M.tryParse=function(e){var t=this.parse(e);if(t.status)return t.value;var n=me(e,t),r=new Error(n);throw r.type="ParsimmonError",r.result=t,r},M.assert=function(e,t){return this.chain((function(n){return e(n)?ke(n):Oe(t)}))},M.or=function(e){return ye(this,e)},M.trim=function(e){return this.wrap(e,e)},M.wrap=function(e,t){return be(e,this,t,(function(e,t){return t}))},M.thru=function(e){return e(this)},M.then=function(e){return oe(e),we(this,e).map((function(e){return e[1]}))},M.many=function(){var e=this;return T((function(t,n){for(var r=[],i=void 0;;){if(!(i=re(e._(t,n),i)).status)return re(te(n,r),i);if(n===i.index)throw new Error("infinite loop detected in .many() parser --- calling .many() on a parser which can accept zero characters is usually the cause");n=i.index,r.push(i.value)}}))},M.tieWith=function(e){return fe(e),this.map((function(t){if(function(e){if(!X(e))throw new Error("not an array: "+e)}(t),t.length){fe(t[0]);for(var n=t[0],r=1;r<t.length;r++)fe(t[r]),n+=e+t[r];return n}return""}))},M.tie=function(){return this.tieWith("")},M.times=function(e,t){var n=this;return arguments.length<2&&(t=e),le(e),le(t),T((function(r,i){for(var s=[],o=void 0,a=void 0,l=0;l<e;l+=1){if(a=re(o=n._(r,i),a),!o.status)return a;i=o.index,s.push(o.value)}for(;l<t&&(a=re(o=n._(r,i),a),o.status);l+=1)i=o.index,s.push(o.value);return re(te(i,s),a)}))},M.result=function(e){return this.map((function(){return e}))},M.atMost=function(e){return this.times(0,e)},M.atLeast=function(e){return be(this.times(e),this.many(),(function(e,t){return e.concat(t)}))},M.map=function(e){ue(e);var t=this;return T((function(n,r){var i=t._(n,r);return i.status?re(te(i.index,e(i.value)),i):i}))},M.contramap=function(e){ue(e);var t=this;return T((function(n,r){var i=t.parse(e(n.slice(r)));return i.status?te(r+n.length,i.value):i}))},M.promap=function(e,t){return ue(e),ue(t),this.contramap(e).map(t)},M.skip=function(e){return we(this,e).map((function(e){return e[0]}))},M.mark=function(){return be(ze,this,ze,(function(e,t,n){return{start:e,value:t,end:n}}))},M.node=function(e){return be(ze,this,ze,(function(t,n,r){return{name:e,value:n,start:t,end:r}}))},M.sepBy=function(e){return Ae(this,e)},M.sepBy1=function(e){return Se(this,e)},M.lookahead=function(e){return this.skip(Ce(e))},M.notFollowedBy=function(e){return this.skip(Ee(e))},M.desc=function(e){X(e)||(e=[e]);var t=this;return T((function(n,r){var i=t._(n,r);return i.status||(i.expected=e),i}))},M.fallback=function(e){return this.or(ke(e))},M.ap=function(e){return be(e,this,(function(e,t){return e(t)}))},M.chain=function(e){var t=this;return T((function(n,r){var i=t._(n,r);return i.status?re(e(i.value)._(n,i.index),i):i}))},M.concat=M.or,M.empty=je,M.of=ke,M["fantasy-land/ap"]=M.ap,M["fantasy-land/chain"]=M.chain,M["fantasy-land/concat"]=M.concat,M["fantasy-land/empty"]=M.empty,M["fantasy-land/of"]=M.of,M["fantasy-land/map"]=M.map;var ze=T((function(e,t){return te(t,se(e,t))})),Ie=T((function(e,t){return t>=e.length?ne(t,"any character/byte"):te(t+1,ae(e,t))})),Te=T((function(e,t){return te(e.length,e.slice(t))})),Me=T((function(e,t){return t<e.length?ne(t,"EOF"):te(t,null)})),Le=De(/[0-9]/).desc("a digit"),Re=De(/[0-9]*/).desc("optional digits"),$e=De(/[a-z]/i).desc("a letter"),Be=De(/[a-z]*/i).desc("optional letters"),Ue=De(/\s*/).desc("optional whitespace"),Fe=De(/\s+/).desc("whitespace"),qe=xe("\r"),We=xe("\n"),Je=xe("\r\n"),Ve=ye(Je,We,qe).desc("newline"),He=ye(Ve,Me);T.all=Te,T.alt=ye,T.any=Ie,T.cr=qe,T.createLanguage=function(e){var t={};for(var n in e)({}).hasOwnProperty.call(e,n)&&function(n){t[n]=Ne((function(){return e[n](t)}))}(n);return t},T.crlf=Je,T.custom=function(e){return T(e(te,ne))},T.digit=Le,T.digits=Re,T.empty=je,T.end=He,T.eof=Me,T.fail=Oe,T.formatError=me,T.index=ze,T.isParser=Z,T.lazy=Ne,T.letter=$e,T.letters=Be,T.lf=We,T.lookahead=Ce,T.makeFailure=ne,T.makeSuccess=te,T.newline=Ve,T.noneOf=function(e){return Pe((function(t){return e.indexOf(t)<0})).desc("none of '"+e+"'")},T.notFollowedBy=Ee,T.of=ke,T.oneOf=function(e){for(var t=e.split(""),n=0;n<t.length;n++)t[n]="'"+t[n]+"'";return Pe((function(t){return e.indexOf(t)>=0})).desc(t)},T.optWhitespace=Ue,T.Parser=T,T.range=function(e,t){return Pe((function(n){return e<=n&&n<=t})).desc(e+"-"+t)},T.regex=De,T.regexp=De,T.sepBy=Ae,T.sepBy1=Se,T.seq=we,T.seqMap=be,T.seqObj=function(){for(var e={},t=0,n=Y(arguments),r=n.length,i=0;i<r;i+=1){var s=n[i];if(!Z(s)){if(X(s)){var o=2===s.length&&"string"==typeof s[0]&&Z(s[1]);if(o){var a=s[0];if(Object.prototype.hasOwnProperty.call(e,a))throw new Error("seqObj: duplicate key "+a);e[a]=!0,t++;continue}}throw new Error("seqObj arguments must be parsers or [string, parser] array pairs.")}}if(0===t)throw new Error("seqObj expects at least one named parser, found zero");return T((function(e,t){for(var i,s={},o=0;o<r;o+=1){var a,l;if(X(n[o])?(a=n[o][0],l=n[o][1]):(a=null,l=n[o]),!(i=re(l._(e,t),i)).status)return i;a&&(s[a]=i.value),t=i.index}return re(te(t,s),i)}))},T.string=xe,T.succeed=ke,T.takeWhile=function(e){return ue(e),T((function(t,n){for(var r=n;r<t.length&&e(ae(t,r));)r++;return te(r,t.slice(n,r))}))},T.test=Pe,T.whitespace=Fe,T["fantasy-land/empty"]=je,T["fantasy-land/of"]=ke,T.Binary={bitSeq:W,bitSeqObj:function(e){q();var t={},n=0,r=$((function(e){if(X(e)){var r=e;if(2!==r.length)throw new Error("["+r.join(", ")+"] should be length 2, got length "+r.length);if(fe(r[0]),le(r[1]),Object.prototype.hasOwnProperty.call(t,r[0]))throw new Error("duplicate key in bitSeqObj: "+r[0]);return t[r[0]]=!0,n++,r}return le(e),[null,e]}),e);if(n<1)throw new Error("bitSeqObj expects at least one named pair, got ["+e.join(", ")+"]");var i=$((function(e){return e[0]}),r);return W($((function(e){return e[1]}),r)).map((function(e){return R((function(e,t){return null!==t[0]&&(e[t[0]]=t[1]),e}),{},$((function(t,n){return[t,e[n]]}),i))}))},byte:function(e){if(q(),le(e),e>255)throw new Error("Value specified to byte constructor ("+e+"=0x"+e.toString(16)+") is larger in value than a single byte.");var t=(e>15?"0x":"0x0")+e.toString(16);return T((function(n,r){var i=ae(n,r);return i===e?te(r+1,i):ne(r,t)}))},buffer:function(e){return J("buffer",e).map((function(e){return Buffer.from(e)}))},encodedString:function(e,t){return J("string",t).map((function(t){return t.toString(e)}))},uintBE:H,uint8BE:H(1),uint16BE:H(2),uint32BE:H(4),uintLE:K,uint8LE:K(1),uint16LE:K(2),uint32LE:K(4),intBE:G,int8BE:G(1),int16BE:G(2),int32BE:G(4),intLE:Q,int8LE:Q(1),int16LE:Q(2),int32LE:Q(4),floatBE:J("floatBE",4).map((function(e){return e.readFloatBE(0)})),floatLE:J("floatLE",4).map((function(e){return e.readFloatLE(0)})),doubleBE:J("doubleBE",8).map((function(e){return e.readDoubleBE(0)})),doubleLE:J("doubleLE",8).map((function(e){return e.readDoubleLE(0)}))};var Ke=T;function Ge(e){const t={b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};return e.replace(/\\(u[0-9a-fA-F]{4}|[^u])/,((e,n)=>{const r=n.charAt(0),i=n.slice(1);return"u"===r?String.fromCharCode(parseInt(i,16)):t.hasOwnProperty(r)?t[r]:r}))}function Qe(e,t){if(!Array.isArray(e))return t(e);let n;for(let r=1;r<e.length;++r){const i=Qe(e[r],t);i!==e[r]&&(n=n||e.slice(),n[r]=i)}return t(n||e)}function Ye(e,t){return Ke.seqMap(t,Ke.seq(e,t).many(),((e,t)=>t.reduce(((e,t)=>{const[n,r]=t;return Array.isArray(e)&&n===e[0]?e.concat([r]):Array.isArray(r)&&n===r[0]?[n,e].concat(r.slice(1)):[n,e,r]}),e)))}const Ze=Ke.createLanguage({ComparisonOperator:function(){return Ke.alt(Ke.string(">="),Ke.string("<>"),Ke.string("<="),Ke.string("="),Ke.string(">"),Ke.string("<")).skip(Ke.optWhitespace)},LikeOperator:function(){return Ke.alt(Ke.regexp(/like/i).result("LIKE").desc("LIKE"),Ke.regexp(/not\s+like/i).result("NOT LIKE").desc("NOT LIKE")).notFollowedBy(Ke.regexp(/[a-zA-Z0-9_]/)).skip(Ke.optWhitespace)},IsNullOperator:function(){return Ke.alt(Ke.regexp(/is\s+null/i).result("IS NULL").desc("IS NULL"),Ke.regexp(/is\s+not\s+null/i).result("IS NOT NULL").desc("IS NOT NULL")).notFollowedBy(Ke.regexp(/[a-zA-Z0-9_]/)).skip(Ke.optWhitespace)},NotOperator:function(){return Ke.regexp(/not/i).result("NOT").notFollowedBy(Ke.regexp(/[a-zA-Z0-9_]/)).skip(Ke.optWhitespace).desc("NOT")},AndOperator:function(){return Ke.regexp(/and/i).result("AND").notFollowedBy(Ke.regexp(/[a-zA-Z0-9_]/)).skip(Ke.optWhitespace).desc("AND")},OrOperator:function(){return Ke.regexp(/or/i).result("OR").notFollowedBy(Ke.regexp(/[a-zA-Z0-9_]/)).skip(Ke.optWhitespace).desc("OR")},Parameter:function(e){return Ke.alt(Ke.regexp(/[a-zA-Z0-9_.*-]+/),e.Expression.wrap(Ke.string("{").skip(Ke.optWhitespace),Ke.string("}"))).atLeast(1).map((e=>["PARAM",e.length>1?["||"].concat(e):e[0]])).skip(Ke.optWhitespace).desc("parameter")},StringValueSql:function(){return Ke.regexp(/'([^']*)'/,1).atLeast(1).skip(Ke.optWhitespace).map((e=>e.join("'"))).desc("string")},StringValueJs:function(){return Ke.regexp(/"((?:\\.|.)*?)"/,1).skip(Ke.optWhitespace).map(Ge).desc("string")},NumberValue:function(){return Ke.regexp(/-?(0|[1-9][0-9]*)([.][0-9]+)?([eE][+-]?[0-9]+)?/).notFollowedBy(Ke.regexp(/[a-zA-Z0-9_]/)).skip(Ke.optWhitespace).map(Number).desc("number")},BooleanValue:function(){return Ke.alt(Ke.regexp(/true/i).result(!0).desc("TRUE"),Ke.regexp(/false/i).result(!1).desc("FALSE")).notFollowedBy(Ke.regexp(/[a-zA-Z0-9_]/)).skip(Ke.optWhitespace)},NullValue:function(){return Ke.regexp(/null/i).notFollowedBy(Ke.regexp(/[a-zA-Z0-9_]/)).skip(Ke.optWhitespace).result(null).desc("NULL")},FuncValue:function(e){return Ke.seqMap(Ke.regexp(/([a-zA-Z0-9_]+)/,1).skip(Ke.optWhitespace).desc("function"),e.ExpressionList.wrap(Ke.string("(").skip(Ke.optWhitespace),Ke.string(")").skip(Ke.optWhitespace)),((e,t)=>["FUNC",e.toUpperCase()].concat(t)))},WhenPair:function(e){return Ke.seq(Ke.regexp(/when/i).notFollowedBy(Ke.regexp(/[a-zA-Z0-9_]/)).skip(Ke.optWhitespace).desc("WHEN").then(e.Expression),Ke.regexp(/then/i).notFollowedBy(Ke.regexp(/[a-zA-Z0-9_]/)).skip(Ke.optWhitespace).desc("THEN").then(e.Expression))},CaseStatement:function(e){return Ke.seqMap(Ke.regexp(/case/i).result("CASE").notFollowedBy(Ke.regexp(/[a-zA-Z0-9_]/)).skip(Ke.optWhitespace).desc("CASE"),e.WhenPair.many(),Ke.regexp(/else/i).notFollowedBy(Ke.regexp(/[a-zA-Z0-9_]/)).skip(Ke.optWhitespace).desc("ELSE").then(e.Expression).map((e=>[[!0,e]])).fallback(null).skip(Ke.regex(/end/i).notFollowedBy(Ke.regexp(/[a-zA-Z0-9_]/))).skip(Ke.optWhitespace),((...e)=>e.flat(2)))},Value:function(e){return Ke.alt(e.NullValue,e.BooleanValue,e.NumberValue,e.StringValueSql,e.StringValueJs,e.FuncValue,e.CaseStatement)},ValueExpression:function(e){return Ye(Ke.string("||").skip(Ke.optWhitespace),Ye(Ke.alt(Ke.string("+"),Ke.string("-")).skip(Ke.optWhitespace),Ye(Ke.alt(Ke.string("*"),Ke.string("/")).skip(Ke.optWhitespace),Ke.alt(e.Value,e.Parameter,e.Expression.wrap(Ke.string("(").skip(Ke.optWhitespace),Ke.string(")").skip(Ke.optWhitespace))))))},Comparison:function(e){return Ke.alt(Ke.seqMap(e.ValueExpression,e.IsNullOperator,((e,t)=>[t,e])),Ke.seqMap(e.ValueExpression,e.ComparisonOperator,e.ValueExpression,((e,t,n)=>[t,e,n])),Ke.seqMap(e.ValueExpression,e.LikeOperator,e.ValueExpression.skip(Ke.regexp(/escape/i).result("ESCAPE").skip(Ke.whitespace).desc("ESCAPE")),e.ValueExpression,((e,t,n,r)=>[t,e,n,r])),Ke.seqMap(e.ValueExpression,e.LikeOperator,e.ValueExpression,((e,t,n)=>[t,e,n])))},ExpressionList:function(e){return e.Expression.sepBy(Ke.string(",").skip(Ke.optWhitespace))},Expression:function(e){return Ye(e.OrOperator,Ye(e.AndOperator,(t=e.NotOperator,n=e.Comparison.or(e.ValueExpression),Ke.seq(t,n).or(n)))).trim(Ke.optWhitespace);var t,n}});function Xe(e){return e?Ze.Expression.tryParse(e):null}function et(e,t=0){if(!Array.isArray(e))return JSON.stringify(e);const n={OR:10,AND:11,NOT:12,"=":20,"<>":20,">":20,">=":20,"<":20,"<=":20,LIKE:20,"NOT LIKE":20,"IS NULL":20,"IS NOT NULL":20,"||":30,"+":31,"-":31,"*":32,"/":32},r=e[0].toUpperCase();function i(e){return n[r]<=t?`(${e})`:e}if("FUNC"===r)return i(`${e[1]}(${e.slice(2).map((e=>et(e))).join(", ")})`);if("PARAM"===r)return"string"==typeof e[1]?i(e[1]):Array.isArray(e[1])&&"||"===e[1][0]?i(e[1].slice(1).map((e=>"string"==typeof e?e:`{${et(e)}}`)).join("")):i(`{${et(e[1])}}`);if("IS NULL"===r||"IS NOT NULL"===r)return i(`${et(e[1],n[r])} ${r}`);if("LIKE"===r||"NOT LIKE"===r)return e[3]?i(`${et(e[1],n[r])} ${r} ${et(e[2],n[r])} ESCAPE ${et(e[3],n[r])}`):i(`${et(e[1],n[r])} ${r} ${et(e[2],n[r])}`);if("CASE"===r){const t=["CASE"];for(let n=1;n<e.length-1;n+=2){if(!Array.isArray(e[n])&&e[n]){null!=e[n+1]&&t.push("ELSE",et(e[n+1]));break}t.push("WHEN",et(e[n]),"THEN",et(e[n+1]))}return t.push("END"),t.join(" ")}if(r in n){const t=e.slice(1).map(((t,r)=>et(t,n[e[0]]+Math.min(r-1,0))));return i("NOT"===r?`${r} ${t[0]}`:t.join(` ${r} `))}throw new Error("Unrecognized operator "+e[0])}const tt=Array.isArray,nt=new WeakMap,rt={};function it(e,t){let n=!0;for(;n;){n=!1;for(let r=2;r<e.length;++r){const i=t(e[r-1],e[r],r-2);i!==rt&&(n=!0,(e=e.slice()).splice(r-1,2,i))}}return 2===e.length?e[1]:e}function st(e,t="",n=""){const r={"-":"\\-","/":"\\/","\\":"\\/","^":"\\^",$:"\\$","*":"\\*","+":"\\+","?":"\\?",".":"\\.","(":"\\(",")":"\\)","|":"\\|","[":"\\[","]":"\\]","{":"\\{","}":"\\}","\\%":".*","\\_":"."};let i=function(e,t){const n=e.split("");for(let e=0;e<n.length;++e){const r=n[e];if(r===t)n[e]=n[e+1]||"",n[e+1]="";else if("_"===r)n[e]="\\_";else if("%"===r)for(n[e]="\\%";"%"===n[e+1];)n[++e]=""}return n.filter((e=>e))}(e,t);if(!i.length)return new RegExp("^$",n);i=i.map((e=>r[e]||e)),i[0]=".*"===i[0]?"":"^"+i[0];const s=i.length-1;return i[s]=[".*",""].includes(i[s])?"":i[s]+"$",new RegExp(i.join(""),n)}function ot(e,t){return"boolean"==typeof e&&(e=+e),"boolean"==typeof t&&(t=+t),typeof e!=typeof t?"string"==typeof e?1:-1:e>t?1:e<t?-1:0}function at(e){switch(typeof e){case"number":return e;case"boolean":return+e;case"string":return parseFloat(e)||0}}function lt(e){switch(typeof e){case"string":return e;case"number":return e.toString();case"boolean":return(+e).toString()}}function ct(e){if(!Array.isArray(e))return e;if("CASE"===e[0]){for(let t=1;t<e.length;t+=2){if(Array.isArray(e[t]))return e;if(e[t])return e[t+1]}return null}if("FUNC"===e[0]){if("COALESCE"===e[1]){const t=[];for(let n=2;n<e.length;++n){const r=e[n];if(null!=r&&(t.push(r),!Array.isArray(r)))break}return t.length?1===t.length?t[0]:["FUNC","COALESCE",...t]:null}if("UPPER"===e[1]){if(null==e[2])return null;if(!tt(e[2]))return lt(e[2]).toUpperCase()}else if("LOWER"===e[1]){if(null==e[2])return null;if(!tt(e[2]))return lt(e[2]).toLowerCase()}}else if("PARAM"===e[0]){if(null==e[1])return null}else{if("AND"===e[0]){for(let t=1;t<e.length;++t)if(!Array.isArray(e[t])&&null!=e[t]&&!e[t])return!1;const t=[];for(let n=1;n<e.length;++n){const r=e[n];if(null==r)return null;Array.isArray(r)&&("AND"===r[0]?t.push(...r.slice(1)):t.push(r))}return!t.length||(1===t.length&&t.push(!0),["AND",...t])}if("OR"===e[0]){const t=[];for(let n=1;n<e.length;++n){const r=e[n];if(Array.isArray(r))"OR"===r[0]?t.push(...r.slice(1)):t.push(r);else if(r)return!0}return t.length?(1===t.length&&t.push(!1),["OR",...t]):!!e.some((e=>null==e))&&null}if("NOT"===e[0]){if(null==e[1])return null;if(!tt(e[1]))return!e[1];if("NOT"===e[1][0])return e[1][1]}else{if("IS NULL"===e[0])return tt(e[1])?e:null==e[1]||null;if("IS NOT NULL"===e[0])return tt(e[1])?e:null!=e[1]||null;if("LIKE"===e[0]){if(tt(e[1])||tt(e[2])||tt(e[3]))return e;if(null==e[1]||null==e[2]||e.length>=4&&null==e[3])return null;let t=nt.get(e);return t||(t=st(e[2],e[3]),nt.set(e,t)),t.test(e[1])}if("NOT LIKE"===e[0]){if(tt(e[1])||tt(e[2])||tt(e[3]))return e;if(null==e[1]||null==e[2]||e.length>=4&&null==e[3])return null;let t=nt.get(e);return t||(t=st(e[2],e[3]),nt.set(e,t)),!t.test(e[1])}if("="===e[0])return null==e[1]||null==e[2]?null:tt(e[1])||tt(e[2])?e:0===ot(e[1],e[2]);if("<>"===e[0])return null==e[1]||null==e[2]?null:tt(e[1])||tt(e[2])?e:0!==ot(e[1],e[2]);if(">"===e[0])return null==e[1]||null==e[2]?null:tt(e[1])||tt(e[2])?e:ot(e[1],e[2])>0;if(">="===e[0])return null==e[1]||null==e[2]?null:tt(e[1])||tt(e[2])?e:ot(e[1],e[2])>=0;if("<"===e[0])return null==e[1]||null==e[2]?null:tt(e[1])||tt(e[2])?e:ot(e[1],e[2])<0;if("<="===e[0])return null==e[1]||null==e[2]?null:tt(e[1])||tt(e[2])?e:ot(e[1],e[2])<=0;if("*"===e[0])return it(e,((e,t)=>null==e||null==t?null:tt(e)||tt(t)?rt:at(e)*at(t)));if("/"===e[0])return it(e,((e,t,n)=>null==e||null==t?null:tt(e)||tt(t)?rt:0===n?at(e)/at(t):at(e)*at(t)));if("+"===e[0])return it(e,((e,t)=>null==e||null==t?null:tt(e)||tt(t)?rt:at(e)+at(t)));if("-"===e[0])return it(e,((e,t,n)=>null==e||null==t?null:tt(e)||tt(t)?rt:0===n?at(e)-at(t):at(e)+at(t)));if("||"===e[0])return it(e,((e,t)=>null==e||null==t?null:tt(e)||tt(t)?rt:lt(e)+lt(t)))}}return e}function ut(e,t,n,r){return Qe(e,(e=>{if(r&&(e=r(e)),!tt(e))return e;if("FUNC"===e[0]&&"NOW"===e[1]){if(n)return n}else if("PARAM"===e[0]){if(null==e[1])return null;if(t&&!tt(e[1])){let n;return n="function"==typeof t?t(e[1]):t[e[1]],null==n?null:("object"==typeof n&&(n=n.value?n.value[0]:null),n)}}return ct(e)}))}function ft(e,t){if(null!=e&&!e)return!1;if(null!=t&&!t)return!1;if(!Array.isArray(e)&&!Array.isArray(t))return null!=e&&null!=t||null;if(!Array.isArray(t)&&"AND"===e[0])return e;if(!Array.isArray(e)&&"AND"===t[0])return t;const n=["AND"];return Array.isArray(e)&&"AND"===e[0]?n.push(...e.slice(1)):n.push(e),Array.isArray(t)&&"AND"===t[0]?n.push(...t.slice(1)):n.push(t),n}function dt(e,t){if(!Array.isArray(e)&&e)return!0;if(!Array.isArray(t)&&t)return!0;if(!Array.isArray(e)&&!Array.isArray(t))return(null==e||null==t)&&null;if(!Array.isArray(t)&&"OR"===e[0])return e;if(!Array.isArray(e)&&"OR"===t[0])return t;const n=["OR"];return Array.isArray(e)&&"OR"===e[0]?n.push(...e.slice(1)):n.push(e),Array.isArray(t)&&"OR"===t[0]?n.push(...t.slice(1)):n.push(t),n}let ht=new Map,pt=new Map;const gt=new WeakMap;function mt(e){if(null===e)return"null";if(void 0===e)return"undefined";const t=typeof e;if("number"===t||"boolean"===t||"string"===t)return`${t}:${e}`;if("function"!==t&&"object"!==t)throw new Error(`Cannot memoize ${t} arguments`);let n=gt.get(e);return n||(n=`${t}:${Math.trunc(Math.random()*Number.MAX_SAFE_INTEGER).toString(36)}`,gt.set(e,n)),n}function vt(e){const t=mt(e);return(...n)=>{const r=JSON.stringify(n.map(mt))+t;if(ht.has(r))return ht.get(r);let i;return i=pt.has(r)?pt.get(r):e(...n),ht.set(r,i),i}}const _t=setInterval((()=>{pt=ht,ht=new Map}),12e4);_t.unref&&_t.unref();const wt=new Set;function bt(e,t,n){const r={type:e,message:t,timestamp:Date.now(),actions:n};return wt.add(r),z.redraw(),n||setTimeout((()=>{yt(r)}),4e3),r}function yt(e){wt.delete(e),z.redraw()}const At=window.clientConfig,St=window.configSnapshot,xt=window.genieacsVersion;class Dt extends Array{constructor(e,t){if(e>Dt.__kMaxLength)throw new RangeError("Maximum BigInt size exceeded");super(e),this.sign=t}static BigInt(e){var t=Math.floor,n=Number.isFinite;if("number"==typeof e){if(0===e)return Dt.__zero();if((0|e)===e)return 0>e?Dt.__oneDigit(-e,!0):Dt.__oneDigit(e,!1);if(!n(e)||t(e)!==e)throw new RangeError("The number "+e+" cannot be converted to BigInt because it is not an integer");return Dt.__fromDouble(e)}if("string"==typeof e){const t=Dt.__fromString(e);if(null===t)throw new SyntaxError("Cannot convert "+e+" to a BigInt");return t}if("boolean"==typeof e)return!0===e?Dt.__oneDigit(1,!1):Dt.__zero();if("object"==typeof e){if(e.constructor===Dt)return e;const t=Dt.__toPrimitive(e);return Dt.BigInt(t)}throw new TypeError("Cannot convert "+e+" to a BigInt")}toDebugString(){const e=["BigInt["];for(const t of this)e.push((t?(t>>>0).toString(16):t)+", ");return e.push("]"),e.join("")}toString(e=10){if(2>e||36<e)throw new RangeError("toString() radix argument must be between 2 and 36");return 0===this.length?"0":0==(e&e-1)?Dt.__toStringBasePowerOfTwo(this,e):Dt.__toStringGeneric(this,e,!1)}static toNumber(e){const t=e.length;if(0===t)return 0;if(1===t){const t=e.__unsignedDigit(0);return e.sign?-t:t}const n=e.__digit(t-1),r=Dt.__clz32(n),i=32*t-r;if(1024<i)return e.sign?-1/0:1/0;let s=i-1,o=n,a=t-1;const l=r+1;let c=32===l?0:o<<l;c>>>=12;const u=l-12;let f=12<=l?0:o<<20+l,d=20+l;0<u&&0<a&&(a--,o=e.__digit(a),c|=o>>>32-u,f=o<<u,d=u),0<d&&0<a&&(a--,o=e.__digit(a),f|=o>>>32-d,d-=32);const h=Dt.__decideRounding(e,d,a,o);if((1===h||0===h&&1==(1&f))&&(f=f+1>>>0,0===f&&(c++,0!=c>>>20&&(c=0,s++,1023<s))))return e.sign?-1/0:1/0;const p=e.sign?-2147483648:0;return s=s+1023<<20,Dt.__kBitConversionInts[1]=p|s|c,Dt.__kBitConversionInts[0]=f,Dt.__kBitConversionDouble[0]}static unaryMinus(e){if(0===e.length)return e;const t=e.__copy();return t.sign=!e.sign,t}static bitwiseNot(e){return e.sign?Dt.__absoluteSubOne(e).__trim():Dt.__absoluteAddOne(e,!0)}static exponentiate(e,t){if(t.sign)throw new RangeError("Exponent must be positive");if(0===t.length)return Dt.__oneDigit(1,!1);if(0===e.length)return e;if(1===e.length&&1===e.__digit(0))return e.sign&&0==(1&t.__digit(0))?Dt.unaryMinus(e):e;if(1<t.length)throw new RangeError("BigInt too big");let n=t.__unsignedDigit(0);if(1===n)return e;if(n>=Dt.__kMaxLengthBits)throw new RangeError("BigInt too big");if(1===e.length&&2===e.__digit(0)){const t=1+(n>>>5),r=e.sign&&0!=(1&n),i=new Dt(t,r);i.__initializeDigits();const s=1<<(31&n);return i.__setDigit(t-1,s),i}let r=null,i=e;for(0!=(1&n)&&(r=e),n>>=1;0!==n;n>>=1)i=Dt.multiply(i,i),0!=(1&n)&&(r=null===r?i:Dt.multiply(r,i));return r}static multiply(e,t){if(0===e.length)return e;if(0===t.length)return t;let n=e.length+t.length;32<=e.__clzmsd()+t.__clzmsd()&&n--;const r=new Dt(n,e.sign!==t.sign);r.__initializeDigits();for(let n=0;n<e.length;n++)Dt.__multiplyAccumulate(t,e.__digit(n),r,n);return r.__trim()}static divide(e,t){if(0===t.length)throw new RangeError("Division by zero");if(0>Dt.__absoluteCompare(e,t))return Dt.__zero();const n=e.sign!==t.sign,r=t.__unsignedDigit(0);let i;if(1===t.length&&65535>=r){if(1===r)return n===e.sign?e:Dt.unaryMinus(e);i=Dt.__absoluteDivSmall(e,r,null)}else i=Dt.__absoluteDivLarge(e,t,!0,!1);return i.sign=n,i.__trim()}static remainder(e,t){if(0===t.length)throw new RangeError("Division by zero");if(0>Dt.__absoluteCompare(e,t))return e;const n=t.__unsignedDigit(0);if(1===t.length&&65535>=n){if(1===n)return Dt.__zero();const t=Dt.__absoluteModSmall(e,n);return 0===t?Dt.__zero():Dt.__oneDigit(t,e.sign)}const r=Dt.__absoluteDivLarge(e,t,!1,!0);return r.sign=e.sign,r.__trim()}static add(e,t){const n=e.sign;return n===t.sign?Dt.__absoluteAdd(e,t,n):0<=Dt.__absoluteCompare(e,t)?Dt.__absoluteSub(e,t,n):Dt.__absoluteSub(t,e,!n)}static subtract(e,t){const n=e.sign;return n===t.sign?0<=Dt.__absoluteCompare(e,t)?Dt.__absoluteSub(e,t,n):Dt.__absoluteSub(t,e,!n):Dt.__absoluteAdd(e,t,n)}static leftShift(e,t){return 0===t.length||0===e.length?e:t.sign?Dt.__rightShiftByAbsolute(e,t):Dt.__leftShiftByAbsolute(e,t)}static signedRightShift(e,t){return 0===t.length||0===e.length?e:t.sign?Dt.__leftShiftByAbsolute(e,t):Dt.__rightShiftByAbsolute(e,t)}static unsignedRightShift(){throw new TypeError("BigInts have no unsigned right shift; use >> instead")}static lessThan(e,t){return 0>Dt.__compareToBigInt(e,t)}static lessThanOrEqual(e,t){return 0>=Dt.__compareToBigInt(e,t)}static greaterThan(e,t){return 0<Dt.__compareToBigInt(e,t)}static greaterThanOrEqual(e,t){return 0<=Dt.__compareToBigInt(e,t)}static equal(e,t){if(e.sign!==t.sign)return!1;if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e.__digit(n)!==t.__digit(n))return!1;return!0}static notEqual(e,t){return!Dt.equal(e,t)}static bitwiseAnd(e,t){var n=Math.max;if(!e.sign&&!t.sign)return Dt.__absoluteAnd(e,t).__trim();if(e.sign&&t.sign){const r=n(e.length,t.length)+1;let i=Dt.__absoluteSubOne(e,r);const s=Dt.__absoluteSubOne(t);return i=Dt.__absoluteOr(i,s,i),Dt.__absoluteAddOne(i,!0,i).__trim()}return e.sign&&([e,t]=[t,e]),Dt.__absoluteAndNot(e,Dt.__absoluteSubOne(t)).__trim()}static bitwiseXor(e,t){var n=Math.max;if(!e.sign&&!t.sign)return Dt.__absoluteXor(e,t).__trim();if(e.sign&&t.sign){const r=n(e.length,t.length),i=Dt.__absoluteSubOne(e,r),s=Dt.__absoluteSubOne(t);return Dt.__absoluteXor(i,s,i).__trim()}const r=n(e.length,t.length)+1;e.sign&&([e,t]=[t,e]);let i=Dt.__absoluteSubOne(t,r);return i=Dt.__absoluteXor(i,e,i),Dt.__absoluteAddOne(i,!0,i).__trim()}static bitwiseOr(e,t){const n=(0,Math.max)(e.length,t.length);if(!e.sign&&!t.sign)return Dt.__absoluteOr(e,t).__trim();if(e.sign&&t.sign){let r=Dt.__absoluteSubOne(e,n);const i=Dt.__absoluteSubOne(t);return r=Dt.__absoluteAnd(r,i,r),Dt.__absoluteAddOne(r,!0,r).__trim()}e.sign&&([e,t]=[t,e]);let r=Dt.__absoluteSubOne(t,n);return r=Dt.__absoluteAndNot(r,e,r),Dt.__absoluteAddOne(r,!0,r).__trim()}static asIntN(e,t){if(0===t.length)return t;if(0===e)return Dt.__zero();if(e>=Dt.__kMaxLengthBits)return t;const n=e+31>>>5;if(t.length<n)return t;const r=t.__unsignedDigit(n-1),i=1<<(31&e-1);if(t.length===n&&r<i)return t;if((r&i)!==i)return Dt.__truncateToNBits(e,t);if(!t.sign)return Dt.__truncateAndSubFromPowerOfTwo(e,t,!0);if(0==(r&i-1)){for(let r=n-2;0<=r;r--)if(0!==t.__digit(r))return Dt.__truncateAndSubFromPowerOfTwo(e,t,!1);return t.length===n&&r===i?t:Dt.__truncateToNBits(e,t)}return Dt.__truncateAndSubFromPowerOfTwo(e,t,!1)}static asUintN(e,t){if(0===t.length)return t;if(0===e)return Dt.__zero();if(t.sign){if(e>Dt.__kMaxLengthBits)throw new RangeError("BigInt too big");return Dt.__truncateAndSubFromPowerOfTwo(e,t,!1)}if(e>=Dt.__kMaxLengthBits)return t;const n=e+31>>>5;if(t.length<n)return t;const r=31&e;if(t.length==n){if(0===r)return t;if(0==t.__digit(n-1)>>>r)return t}return Dt.__truncateToNBits(e,t)}static ADD(e,t){if(e=Dt.__toPrimitive(e),t=Dt.__toPrimitive(t),"string"==typeof e)return"string"!=typeof t&&(t=t.toString()),e+t;if("string"==typeof t)return e.toString()+t;if(e=Dt.__toNumeric(e),t=Dt.__toNumeric(t),Dt.__isBigInt(e)&&Dt.__isBigInt(t))return Dt.add(e,t);if("number"==typeof e&&"number"==typeof t)return e+t;throw new TypeError("Cannot mix BigInt and other types, use explicit conversions")}static LT(e,t){return Dt.__compare(e,t,0)}static LE(e,t){return Dt.__compare(e,t,1)}static GT(e,t){return Dt.__compare(e,t,2)}static GE(e,t){return Dt.__compare(e,t,3)}static EQ(e,t){for(;;){if(Dt.__isBigInt(e))return Dt.__isBigInt(t)?Dt.equal(e,t):Dt.EQ(t,e);if("number"==typeof e){if(Dt.__isBigInt(t))return Dt.__equalToNumber(t,e);if("object"!=typeof t)return e==t;t=Dt.__toPrimitive(t)}else if("string"==typeof e){if(Dt.__isBigInt(t))return null!==(e=Dt.__fromString(e))&&Dt.equal(e,t);if("object"!=typeof t)return e==t;t=Dt.__toPrimitive(t)}else if("boolean"==typeof e){if(Dt.__isBigInt(t))return Dt.__equalToNumber(t,+e);if("object"!=typeof t)return e==t;t=Dt.__toPrimitive(t)}else if("symbol"==typeof e){if(Dt.__isBigInt(t))return!1;if("object"!=typeof t)return e==t;t=Dt.__toPrimitive(t)}else{if("object"!=typeof e)return e==t;if("object"==typeof t&&t.constructor!==Dt)return e==t;e=Dt.__toPrimitive(e)}}}static NE(e,t){return!Dt.EQ(e,t)}static __zero(){return new Dt(0,!1)}static __oneDigit(e,t){const n=new Dt(1,t);return n.__setDigit(0,e),n}__copy(){const e=new Dt(this.length,this.sign);for(let t=0;t<this.length;t++)e[t]=this[t];return e}__trim(){let e=this.length,t=this[e-1];for(;0===t;)e--,t=this[e-1],this.pop();return 0===e&&(this.sign=!1),this}__initializeDigits(){for(let e=0;e<this.length;e++)this[e]=0}static __decideRounding(e,t,n,r){if(0<t)return-1;let i;if(0>t)i=-t-1;else{if(0===n)return-1;n--,r=e.__digit(n),i=31}let s=1<<i;if(0==(r&s))return-1;if(s-=1,0!=(r&s))return 1;for(;0<n;)if(n--,0!==e.__digit(n))return 1;return 0}static __fromDouble(e){Dt.__kBitConversionDouble[0]=e;const t=(2047&Dt.__kBitConversionInts[1]>>>20)-1023,n=1+(t>>>5),r=new Dt(n,0>e);let i=1048575&Dt.__kBitConversionInts[1]|1048576,s=Dt.__kBitConversionInts[0];const o=31&t;let a,l=0;if(o<20){const e=20-o;l=e+32,a=i>>>e,i=i<<32-e|s>>>e,s<<=32-e}else if(20===o)l=32,a=i,i=s;else{const e=o-20;l=32-e,a=i<<e|s>>>32-e,i=s<<e}r.__setDigit(n-1,a);for(let e=n-2;0<=e;e--)0<l?(l-=32,a=i,i=s):a=0,r.__setDigit(e,a);return r.__trim()}static __isWhitespace(e){return!!(13>=e&&9<=e)||(159>=e?32==e:131071>=e?160==e||5760==e:196607>=e?10>=(e&=131071)||40==e||41==e||47==e||95==e||4096==e:65279==e)}static __fromString(e,t=0){let n=0;const r=e.length;let i=0;if(i===r)return Dt.__zero();let s=e.charCodeAt(i);for(;Dt.__isWhitespace(s);){if(++i===r)return Dt.__zero();s=e.charCodeAt(i)}if(43===s){if(++i===r)return null;s=e.charCodeAt(i),n=1}else if(45===s){if(++i===r)return null;s=e.charCodeAt(i),n=-1}if(0===t){if(t=10,48===s){if(++i===r)return Dt.__zero();if(s=e.charCodeAt(i),88===s||120===s){if(t=16,++i===r)return null;s=e.charCodeAt(i)}else if(79===s||111===s){if(t=8,++i===r)return null;s=e.charCodeAt(i)}else if(66===s||98===s){if(t=2,++i===r)return null;s=e.charCodeAt(i)}}}else if(16===t&&48===s){if(++i===r)return Dt.__zero();if(s=e.charCodeAt(i),88===s||120===s){if(++i===r)return null;s=e.charCodeAt(i)}}for(;48===s;){if(++i===r)return Dt.__zero();s=e.charCodeAt(i)}const o=r-i;let a=Dt.__kMaxBitsPerChar[t],l=Dt.__kBitsPerCharTableMultiplier-1;if(o>1073741824/a)return null;const c=a*o+l>>>Dt.__kBitsPerCharTableShift,u=new Dt(c+31>>>5,!1),f=10>t?t:10,d=10<t?t-10:0;if(0==(t&t-1)){a>>=Dt.__kBitsPerCharTableShift;const t=[],n=[];let o=!1;do{let l=0,c=0;for(;;){let t;if(s-48>>>0<f)t=s-48;else{if(!((32|s)-97>>>0<d)){o=!0;break}t=(32|s)-87}if(c+=a,l=l<<a|t,++i===r){o=!0;break}if(s=e.charCodeAt(i),32<c+a)break}t.push(l),n.push(c)}while(!o);Dt.__fillFromParts(u,t,n)}else{u.__initializeDigits();let n=!1,o=0;do{let c=0,h=1;for(;;){let a;if(s-48>>>0<f)a=s-48;else{if(!((32|s)-97>>>0<d)){n=!0;break}a=(32|s)-87}const l=h*t;if(4294967295<l)break;if(h=l,c=c*t+a,o++,++i===r){n=!0;break}s=e.charCodeAt(i)}l=32*Dt.__kBitsPerCharTableMultiplier-1;const p=a*o+l>>>Dt.__kBitsPerCharTableShift+5;u.__inplaceMultiplyAdd(h,c,p)}while(!n)}if(i!==r){if(!Dt.__isWhitespace(s))return null;for(i++;i<r;i++)if(s=e.charCodeAt(i),!Dt.__isWhitespace(s))return null}return 0!=n&&10!==t?null:(u.sign=-1==n,u.__trim())}static __fillFromParts(e,t,n){let r=0,i=0,s=0;for(let o=t.length-1;0<=o;o--){const a=t[o],l=n[o];i|=a<<s,s+=l,32===s?(e.__setDigit(r++,i),s=0,i=0):32<s&&(e.__setDigit(r++,i),s-=32,i=a>>>l-s)}if(0!==i){if(r>=e.length)throw new Error("implementation bug");e.__setDigit(r++,i)}for(;r<e.length;r++)e.__setDigit(r,0)}static __toStringBasePowerOfTwo(e,t){const n=e.length;let r=t-1;r=(85&r>>>1)+(85&r),r=(51&r>>>2)+(51&r),r=(15&r>>>4)+(15&r);const i=r,s=t-1,o=e.__digit(n-1);let a=0|(32*n-Dt.__clz32(o)+i-1)/i;if(e.sign&&a++,268435456<a)throw new Error("string too long");const l=Array(a);let c=a-1,u=0,f=0;for(let t=0;t<n-1;t++){const n=e.__digit(t),r=(u|n<<f)&s;l[c--]=Dt.__kConversionChars[r];const o=i-f;for(u=n>>>o,f=32-o;f>=i;)l[c--]=Dt.__kConversionChars[u&s],u>>>=i,f-=i}const d=(u|o<<f)&s;for(l[c--]=Dt.__kConversionChars[d],u=o>>>i-f;0!==u;)l[c--]=Dt.__kConversionChars[u&s],u>>>=i;if(e.sign&&(l[c--]="-"),-1!=c)throw new Error("implementation bug");return l.join("")}static __toStringGeneric(e,t,n){const r=e.length;if(0===r)return"";if(1===r){let r=e.__unsignedDigit(0).toString(t);return!1===n&&e.sign&&(r="-"+r),r}const i=32*r-Dt.__clz32(e.__digit(r-1)),s=Dt.__kMaxBitsPerChar[t]-1;let o=i*Dt.__kBitsPerCharTableMultiplier;o+=s-1,o=0|o/s;const a=o+1>>1,l=Dt.exponentiate(Dt.__oneDigit(t,!1),Dt.__oneDigit(a,!1));let c,u;const f=l.__unsignedDigit(0);if(1===l.length&&65535>=f){c=new Dt(e.length,!1),c.__initializeDigits();let n=0;for(let t=2*e.length-1;0<=t;t--){const r=n<<16|e.__halfDigit(t);c.__setHalfDigit(t,0|r/f),n=0|r%f}u=n.toString(t)}else{const n=Dt.__absoluteDivLarge(e,l,!0,!0);c=n.quotient;const r=n.remainder.__trim();u=Dt.__toStringGeneric(r,t,!0)}c.__trim();let d=Dt.__toStringGeneric(c,t,!0);for(;u.length<a;)u="0"+u;return!1===n&&e.sign&&(d="-"+d),d+u}static __unequalSign(e){return e?-1:1}static __absoluteGreater(e){return e?-1:1}static __absoluteLess(e){return e?1:-1}static __compareToBigInt(e,t){const n=e.sign;if(n!==t.sign)return Dt.__unequalSign(n);const r=Dt.__absoluteCompare(e,t);return 0<r?Dt.__absoluteGreater(n):0>r?Dt.__absoluteLess(n):0}static __compareToNumber(e,t){if(!0|t){const n=e.sign,r=0>t;if(n!==r)return Dt.__unequalSign(n);if(0===e.length){if(r)throw new Error("implementation bug");return 0===t?0:-1}if(1<e.length)return Dt.__absoluteGreater(n);const i=Math.abs(t),s=e.__unsignedDigit(0);return s>i?Dt.__absoluteGreater(n):s<i?Dt.__absoluteLess(n):0}return Dt.__compareToDouble(e,t)}static __compareToDouble(e,t){if(t!=t)return t;if(t===1/0)return-1;if(t===-1/0)return 1;const n=e.sign;if(n!==0>t)return Dt.__unequalSign(n);if(0===t)throw new Error("implementation bug: should be handled elsewhere");if(0===e.length)return-1;Dt.__kBitConversionDouble[0]=t;const r=2047&Dt.__kBitConversionInts[1]>>>20;if(2047==r)throw new Error("implementation bug: handled elsewhere");const i=r-1023;if(0>i)return Dt.__absoluteGreater(n);const s=e.length;let o=e.__digit(s-1);const a=Dt.__clz32(o),l=32*s-a,c=i+1;if(l<c)return Dt.__absoluteLess(n);if(l>c)return Dt.__absoluteGreater(n);let u=1048576|1048575&Dt.__kBitConversionInts[1],f=Dt.__kBitConversionInts[0];const d=31-a;if(d!==(l-1)%31)throw new Error("implementation bug");let h,p=0;if(20>d){const e=20-d;p=e+32,h=u>>>e,u=u<<32-e|f>>>e,f<<=32-e}else if(20===d)p=32,h=u,u=f;else{const e=d-20;p=32-e,h=u<<e|f>>>32-e,u=f<<e}if(o>>>=0,h>>>=0,o>h)return Dt.__absoluteGreater(n);if(o<h)return Dt.__absoluteLess(n);for(let t=s-2;0<=t;t--){0<p?(p-=32,h=u>>>0,u=f,f=0):h=0;const r=e.__unsignedDigit(t);if(r>h)return Dt.__absoluteGreater(n);if(r<h)return Dt.__absoluteLess(n)}if(0!==u||0!==f){if(0===p)throw new Error("implementation bug");return Dt.__absoluteLess(n)}return 0}static __equalToNumber(e,t){var n=Math.abs;return t|0===t?0===t?0===e.length:1===e.length&&e.sign===0>t&&e.__unsignedDigit(0)===n(t):0===Dt.__compareToDouble(e,t)}static __comparisonResultToBool(e,t){switch(t){case 0:return 0>e;case 1:return 0>=e;case 2:return 0<e;case 3:return 0<=e}throw new Error("unreachable")}static __compare(e,t,n){if(e=Dt.__toPrimitive(e),t=Dt.__toPrimitive(t),"string"==typeof e&&"string"==typeof t)switch(n){case 0:return e<t;case 1:return e<=t;case 2:return e>t;case 3:return e>=t}if(Dt.__isBigInt(e)&&"string"==typeof t)return null!==(t=Dt.__fromString(t))&&Dt.__comparisonResultToBool(Dt.__compareToBigInt(e,t),n);if("string"==typeof e&&Dt.__isBigInt(t))return null!==(e=Dt.__fromString(e))&&Dt.__comparisonResultToBool(Dt.__compareToBigInt(e,t),n);if(e=Dt.__toNumeric(e),t=Dt.__toNumeric(t),Dt.__isBigInt(e)){if(Dt.__isBigInt(t))return Dt.__comparisonResultToBool(Dt.__compareToBigInt(e,t),n);if("number"!=typeof t)throw new Error("implementation bug");return Dt.__comparisonResultToBool(Dt.__compareToNumber(e,t),n)}if("number"!=typeof e)throw new Error("implementation bug");if(Dt.__isBigInt(t))return Dt.__comparisonResultToBool(Dt.__compareToNumber(t,e),2^n);if("number"!=typeof t)throw new Error("implementation bug");return 0===n?e<t:1===n?e<=t:2===n?e>t:3===n?e>=t:void 0}__clzmsd(){return Dt.__clz32(this[this.length-1])}static __absoluteAdd(e,t,n){if(e.length<t.length)return Dt.__absoluteAdd(t,e,n);if(0===e.length)return e;if(0===t.length)return e.sign===n?e:Dt.unaryMinus(e);let r=e.length;(0===e.__clzmsd()||t.length===e.length&&0===t.__clzmsd())&&r++;const i=new Dt(r,n);let s=0,o=0;for(;o<t.length;o++){const n=t.__digit(o),r=e.__digit(o),a=(65535&r)+(65535&n)+s,l=(r>>>16)+(n>>>16)+(a>>>16);s=l>>>16,i.__setDigit(o,65535&a|l<<16)}for(;o<e.length;o++){const t=e.__digit(o),n=(65535&t)+s,r=(t>>>16)+(n>>>16);s=r>>>16,i.__setDigit(o,65535&n|r<<16)}return o<i.length&&i.__setDigit(o,s),i.__trim()}static __absoluteSub(e,t,n){if(0===e.length)return e;if(0===t.length)return e.sign===n?e:Dt.unaryMinus(e);const r=new Dt(e.length,n);let i=0,s=0;for(;s<t.length;s++){const n=e.__digit(s),o=t.__digit(s),a=(65535&n)-(65535&o)-i;i=1&a>>>16;const l=(n>>>16)-(o>>>16)-i;i=1&l>>>16,r.__setDigit(s,65535&a|l<<16)}for(;s<e.length;s++){const t=e.__digit(s),n=(65535&t)-i;i=1&n>>>16;const o=(t>>>16)-i;i=1&o>>>16,r.__setDigit(s,65535&n|o<<16)}return r.__trim()}static __absoluteAddOne(e,t,n=null){const r=e.length;null===n?n=new Dt(r,t):n.sign=t;let i=!0;for(let t,s=0;s<r;s++){if(t=e.__digit(s),i){const e=-1===t;t=0|t+1,i=e}n.__setDigit(s,t)}return i&&n.__setDigitGrow(r,1),n}static __absoluteSubOne(e,t){const n=e.length,r=new Dt(t=t||n,!1);let i=!0;for(let t,s=0;s<n;s++){if(t=e.__digit(s),i){const e=0===t;t=0|t-1,i=e}r.__setDigit(s,t)}if(i)throw new Error("implementation bug");for(let e=n;e<t;e++)r.__setDigit(e,0);return r}static __absoluteAnd(e,t,n=null){let r=e.length,i=t.length,s=i;if(r<i){s=r;const n=e,o=r;e=t,r=i,t=n,i=o}let o=s;null===n?n=new Dt(o,!1):o=n.length;let a=0;for(;a<s;a++)n.__setDigit(a,e.__digit(a)&t.__digit(a));for(;a<o;a++)n.__setDigit(a,0);return n}static __absoluteAndNot(e,t,n=null){const r=e.length,i=t.length;let s=i;r<i&&(s=r);let o=r;null===n?n=new Dt(o,!1):o=n.length;let a=0;for(;a<s;a++)n.__setDigit(a,e.__digit(a)&~t.__digit(a));for(;a<r;a++)n.__setDigit(a,e.__digit(a));for(;a<o;a++)n.__setDigit(a,0);return n}static __absoluteOr(e,t,n=null){let r=e.length,i=t.length,s=i;if(r<i){s=r;const n=e,o=r;e=t,r=i,t=n,i=o}let o=r;null===n?n=new Dt(o,!1):o=n.length;let a=0;for(;a<s;a++)n.__setDigit(a,e.__digit(a)|t.__digit(a));for(;a<r;a++)n.__setDigit(a,e.__digit(a));for(;a<o;a++)n.__setDigit(a,0);return n}static __absoluteXor(e,t,n=null){let r=e.length,i=t.length,s=i;if(r<i){s=r;const n=e,o=r;e=t,r=i,t=n,i=o}let o=r;null===n?n=new Dt(o,!1):o=n.length;let a=0;for(;a<s;a++)n.__setDigit(a,e.__digit(a)^t.__digit(a));for(;a<r;a++)n.__setDigit(a,e.__digit(a));for(;a<o;a++)n.__setDigit(a,0);return n}static __absoluteCompare(e,t){const n=e.length-t.length;if(0!=n)return n;let r=e.length-1;for(;0<=r&&e.__digit(r)===t.__digit(r);)r--;return 0>r?0:e.__unsignedDigit(r)>t.__unsignedDigit(r)?1:-1}static __multiplyAccumulate(e,t,n,r){if(0===t)return;const i=65535&t,s=t>>>16;let o=0,a=0,l=0;for(let t=0;t<e.length;t++,r++){let c=n.__digit(r),u=65535&c,f=c>>>16;const d=e.__digit(t),h=65535&d,p=d>>>16,g=Dt.__imul(h,i),m=Dt.__imul(h,s),v=Dt.__imul(p,i),_=Dt.__imul(p,s);u+=a+(65535&g),f+=l+o+(u>>>16)+(g>>>16)+(65535&m)+(65535&v),o=f>>>16,a=(m>>>16)+(v>>>16)+(65535&_)+o,o=a>>>16,a&=65535,l=_>>>16,c=65535&u|f<<16,n.__setDigit(r,c)}for(;0!=o||0!==a||0!==l;r++){let e=n.__digit(r);const t=(65535&e)+a,i=(e>>>16)+(t>>>16)+l+o;a=0,l=0,o=i>>>16,e=65535&t|i<<16,n.__setDigit(r,e)}}static __internalMultiplyAdd(e,t,n,r,i){let s=n,o=0;for(let n=0;n<r;n++){const r=e.__digit(n),a=Dt.__imul(65535&r,t),l=(65535&a)+o+s;s=l>>>16;const c=Dt.__imul(r>>>16,t),u=(65535&c)+(a>>>16)+s;s=u>>>16,o=c>>>16,i.__setDigit(n,u<<16|65535&l)}if(i.length>r)for(i.__setDigit(r++,s+o);r<i.length;)i.__setDigit(r++,0);else if(0!==s+o)throw new Error("implementation bug")}__inplaceMultiplyAdd(e,t,n){n>this.length&&(n=this.length);const r=65535&e,i=e>>>16;let s=0,o=65535&t,a=t>>>16;for(let e=0;e<n;e++){const t=this.__digit(e),n=65535&t,l=t>>>16,c=Dt.__imul(n,r),u=Dt.__imul(n,i),f=Dt.__imul(l,r),d=Dt.__imul(l,i),h=o+(65535&c),p=a+s+(h>>>16)+(c>>>16)+(65535&u)+(65535&f);o=(u>>>16)+(f>>>16)+(65535&d)+(p>>>16),s=o>>>16,o&=65535,a=d>>>16,this.__setDigit(e,65535&h|p<<16)}if(0!=s||0!==o||0!==a)throw new Error("implementation bug")}static __absoluteDivSmall(e,t,n){null===n&&(n=new Dt(e.length,!1));let r=0;for(let i,s=2*e.length-1;0<=s;s-=2){i=(r<<16|e.__halfDigit(s))>>>0;const o=0|i/t;r=0|i%t,i=(r<<16|e.__halfDigit(s-1))>>>0;const a=0|i/t;r=0|i%t,n.__setDigit(s>>>1,o<<16|a)}return n}static __absoluteModSmall(e,t){let n=0;for(let r=2*e.length-1;0<=r;r--)n=0|((n<<16|e.__halfDigit(r))>>>0)%t;return n}static __absoluteDivLarge(e,t,n,r){const i=t.__halfDigitLength(),s=t.length,o=e.__halfDigitLength()-i;let a=null;n&&(a=new Dt(o+2>>>1,!1),a.__initializeDigits());const l=new Dt(i+2>>>1,!1);l.__initializeDigits();const c=Dt.__clz16(t.__halfDigit(i-1));0<c&&(t=Dt.__specialLeftShift(t,c,0));const u=Dt.__specialLeftShift(e,c,1),f=t.__halfDigit(i-1);let d=0;for(let e,r=o;0<=r;r--){e=65535;const o=u.__halfDigit(r+i);if(o!==f){const n=(o<<16|u.__halfDigit(r+i-1))>>>0;e=0|n/f;let s=0|n%f;const a=t.__halfDigit(i-2),l=u.__halfDigit(r+i-2);for(;Dt.__imul(e,a)>>>0>(s<<16|l)>>>0&&(e--,s+=f,!(65535<s)););}Dt.__internalMultiplyAdd(t,e,0,s,l);let c=u.__inplaceSub(l,r,i+1);0!==c&&(c=u.__inplaceAdd(t,r,i),u.__setHalfDigit(r+i,u.__halfDigit(r+i)+c),e--),n&&(1&r?d=e<<16:a.__setDigit(r>>>1,d|e))}return r?(u.__inplaceRightShift(c),n?{quotient:a,remainder:u}:u):n?a:void 0}static __clz16(e){return Dt.__clz32(e)-16}__inplaceAdd(e,t,n){let r=0;for(let i=0;i<n;i++){const n=this.__halfDigit(t+i)+e.__halfDigit(i)+r;r=n>>>16,this.__setHalfDigit(t+i,n)}return r}__inplaceSub(e,t,n){let r=0;if(1&t){t>>=1;let i=this.__digit(t),s=65535&i,o=0;for(;o<n-1>>>1;o++){const n=e.__digit(o),a=(i>>>16)-(65535&n)-r;r=1&a>>>16,this.__setDigit(t+o,a<<16|65535&s),i=this.__digit(t+o+1),s=(65535&i)-(n>>>16)-r,r=1&s>>>16}const a=e.__digit(o),l=(i>>>16)-(65535&a)-r;if(r=1&l>>>16,this.__setDigit(t+o,l<<16|65535&s),t+o+1>=this.length)throw new RangeError("out of bounds");0==(1&n)&&(i=this.__digit(t+o+1),s=(65535&i)-(a>>>16)-r,r=1&s>>>16,this.__setDigit(t+e.length,4294901760&i|65535&s))}else{t>>=1;let i=0;for(;i<e.length-1;i++){const n=this.__digit(t+i),s=e.__digit(i),o=(65535&n)-(65535&s)-r;r=1&o>>>16;const a=(n>>>16)-(s>>>16)-r;r=1&a>>>16,this.__setDigit(t+i,a<<16|65535&o)}const s=this.__digit(t+i),o=e.__digit(i),a=(65535&s)-(65535&o)-r;r=1&a>>>16;let l=0;0==(1&n)&&(l=(s>>>16)-(o>>>16)-r,r=1&l>>>16),this.__setDigit(t+i,l<<16|65535&a)}return r}__inplaceRightShift(e){if(0===e)return;let t=this.__digit(0)>>>e;const n=this.length-1;for(let r=0;r<n;r++){const n=this.__digit(r+1);this.__setDigit(r,n<<32-e|t),t=n>>>e}this.__setDigit(n,t)}static __specialLeftShift(e,t,n){const r=e.length,i=new Dt(r+n,!1);if(0===t){for(let t=0;t<r;t++)i.__setDigit(t,e.__digit(t));return 0<n&&i.__setDigit(r,0),i}let s=0;for(let n=0;n<r;n++){const r=e.__digit(n);i.__setDigit(n,r<<t|s),s=r>>>32-t}return 0<n&&i.__setDigit(r,s),i}static __leftShiftByAbsolute(e,t){const n=Dt.__toShiftAmount(t);if(0>n)throw new RangeError("BigInt too big");const r=n>>>5,i=31&n,s=e.length,o=0!==i&&0!=e.__digit(s-1)>>>32-i,a=s+r+(o?1:0),l=new Dt(a,e.sign);if(0===i){let t=0;for(;t<r;t++)l.__setDigit(t,0);for(;t<a;t++)l.__setDigit(t,e.__digit(t-r))}else{let t=0;for(let e=0;e<r;e++)l.__setDigit(e,0);for(let n=0;n<s;n++){const s=e.__digit(n);l.__setDigit(n+r,s<<i|t),t=s>>>32-i}if(o)l.__setDigit(s+r,t);else if(0!==t)throw new Error("implementation bug")}return l.__trim()}static __rightShiftByAbsolute(e,t){const n=e.length,r=e.sign,i=Dt.__toShiftAmount(t);if(0>i)return Dt.__rightShiftByMaximum(r);const s=i>>>5,o=31&i;let a=n-s;if(0>=a)return Dt.__rightShiftByMaximum(r);let l=!1;if(r)if(0!=(e.__digit(s)&(1<<o)-1))l=!0;else for(let t=0;t<s;t++)if(0!==e.__digit(t)){l=!0;break}l&&0===o&&0==~e.__digit(n-1)&&a++;let c=new Dt(a,r);if(0===o)for(let t=s;t<n;t++)c.__setDigit(t-s,e.__digit(t));else{let t=e.__digit(s)>>>o;const r=n-s-1;for(let n=0;n<r;n++){const r=e.__digit(n+s+1);c.__setDigit(n,r<<32-o|t),t=r>>>o}c.__setDigit(r,t)}return l&&(c=Dt.__absoluteAddOne(c,!0,c)),c.__trim()}static __rightShiftByMaximum(e){return e?Dt.__oneDigit(1,!0):Dt.__zero()}static __toShiftAmount(e){if(1<e.length)return-1;const t=e.__unsignedDigit(0);return t>Dt.__kMaxLengthBits?-1:t}static __toPrimitive(e,t="default"){if("object"!=typeof e)return e;if(e.constructor===Dt)return e;const n=e[Symbol.toPrimitive];if(n){const e=n(t);if("object"!=typeof e)return e;throw new TypeError("Cannot convert object to primitive value")}const r=e.valueOf;if(r){const t=r.call(e);if("object"!=typeof t)return t}const i=e.toString;if(i){const t=i.call(e);if("object"!=typeof t)return t}throw new TypeError("Cannot convert object to primitive value")}static __toNumeric(e){return Dt.__isBigInt(e)?e:+e}static __isBigInt(e){return"object"==typeof e&&e.constructor===Dt}static __truncateToNBits(e,t){const n=e+31>>>5,r=new Dt(n,t.sign),i=n-1;for(let e=0;e<i;e++)r.__setDigit(e,t.__digit(e));let s=t.__digit(i);if(0!=(31&e)){const t=32-(31&e);s=s<<t>>>t}return r.__setDigit(i,s),r.__trim()}static __truncateAndSubFromPowerOfTwo(e,t,n){var r=Math.min;const i=e+31>>>5,s=new Dt(i,n);let o=0;const a=i-1;let l=0;for(const e=r(a,t.length);o<e;o++){const e=t.__digit(o),n=0-(65535&e)-l;l=1&n>>>16;const r=0-(e>>>16)-l;l=1&r>>>16,s.__setDigit(o,65535&n|r<<16)}for(;o<a;o++)s.__setDigit(o,0|-l);let c=a<t.length?t.__digit(a):0;const u=31&e;let f;if(0==u){const e=0-(65535&c)-l;l=1&e>>>16,f=65535&e|0-(c>>>16)-l<<16}else{const e=32-u;c=c<<e>>>e;const t=1<<32-e,n=(65535&t)-(65535&c)-l;l=1&n>>>16,f=65535&n|(t>>>16)-(c>>>16)-l<<16,f&=t-1}return s.__setDigit(a,f),s.__trim()}__digit(e){return this[e]}__unsignedDigit(e){return this[e]>>>0}__setDigit(e,t){this[e]=0|t}__setDigitGrow(e,t){this[e]=0|t}__halfDigitLength(){const e=this.length;return 65535>=this.__unsignedDigit(e-1)?2*e-1:2*e}__halfDigit(e){return 65535&this[e>>>1]>>>((1&e)<<4)}__setHalfDigit(e,t){const n=e>>>1,r=this.__digit(n),i=1&e?65535&r|t<<16:4294901760&r|65535&t;this.__setDigit(n,i)}static __digitPow(e,t){let n=1;for(;0<t;)1&t&&(n*=e),t>>>=1,e*=e;return n}}function kt(e,t){return Dt.add(e,t)}function Ot(e,t){return Dt.multiply(e,t)}function Ct(e,t){return Dt.divide(e,t)}function Et(e,t){return Dt.remainder(e,t)}function Pt(e){return Dt.toNumber(e)}function Nt(e,t){return Dt.notEqual(e,t)}function jt(e,t){return Dt.lessThan(e,t)}Dt.__kMaxLength=33554432,Dt.__kMaxLengthBits=Dt.__kMaxLength<<5,Dt.__kMaxBitsPerChar=[0,0,32,51,64,75,83,90,96,102,107,111,115,119,122,126,128,131,134,136,139,141,143,145,147,149,151,153,154,156,158,159,160,162,163,165,166],Dt.__kBitsPerCharTableShift=5,Dt.__kBitsPerCharTableMultiplier=1<<Dt.__kBitsPerCharTableShift,Dt.__kConversionChars=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],Dt.__kBitConversionBuffer=new ArrayBuffer(8),Dt.__kBitConversionDouble=new Float64Array(Dt.__kBitConversionBuffer),Dt.__kBitConversionInts=new Int32Array(Dt.__kBitConversionBuffer),Dt.__clz32=Math.clz32||function(e){return 0===e?32:0|31-(0|Math.log(e>>>0)/Math.LN2)},Dt.__imul=Math.imul||function(e,t){return 0|e*t};const zt=Dt.BigInt;function It(e,t){return Dt.bitwiseAnd(e,t)}function Tt(e,t){return Dt.bitwiseOr(e,t)}function Mt(e,t){return Dt.bitwiseXor(e,t)}function Lt(e){return Dt.bitwiseNot(e)}function Rt(e,t){return Dt.leftShift(e,t)}function $t(e,t){return Dt.signedRightShift(e,t)}function Bt(e){return Dt.toNumber(e)}function Ut(e,t){return Dt.equal(e,t)}function Ft(e,t){return Dt.notEqual(e,t)}function qt(e,t){return Dt.greaterThanOrEqual(e,t)}function Wt(e,t){return Dt.asIntN(e,t)}const Jt=Dt.BigInt,Vt=Jt(0),Ht=Jt(1),Kt=Lt(Vt),Gt=Jt(32),Qt=[],Yt=[];for(let e=0;e<=512;++e){const t=Rt(Ht,Jt(e));Qt.push(t),Yt.push(Lt(t))}const Zt=Qt.filter(((e,t)=>t%2==0)).reduce(((e,t)=>Tt(e,t)));function Xt(e){const t=[];let n=0;for(;Ft(e,Vt);){let r=Bt(Wt(32,e));e=$t(e,Gt);let i=Math.clz32(r);for(;i<32;){const e=31-i;t.push(n+e),r^=1<<e,i=Math.clz32(r)}n+=32}return t}function en(e){const t=1431655765,n=[];let r=0;for(;Ft(e,Vt);){let i=Bt(Wt(32,e));i=i&t|i>>1&t,e=$t(e,Gt);let s=Math.clz32(i);for(;s<32;){const e=31-s;n.push(r+e),i^=1<<e,s=Math.clz32(i)}r+=32}return n}function tn(e,t){const n=new Map;for(const r of t){const t=r-r%2;if(n.has(t))continue;const i=new Set;for(const t of e)(t.set.has(r)||t.set.has(r+1))&&i.add(t);i.size&&n.set(t,i)}if(n.size<=1)return[e];for(const t of e){let r=-1;for(const[i,s]of n)if(s.has(t))if(-1!==r){if(n.set(r,new Set([...n.get(r),...s])),n.delete(i),1===n.size)return[e]}else r=i}return[...n.values()].map((e=>[...e]))}function nn(e){return Tt(Rt(It(e,Zt),Ht),It($t(e,Ht),Zt))}function rn(e,t=512){let n=0;for(;n<t&&Ft(e,Vt);++n)e=It(e,(r=e,i=Ht,Dt.subtract(r,i)));var r,i;return n}class sn{constructor(e,t,n){this._bigint=e,this._set=t,this._hash=n}get bigint(){return this._bigint}get set(){return this._set}get hash(){return this._hash}raise(e){if(!this._set.has(e))return this;const t=Mt(this._bigint,Qt[e]),n=new Set(this._set);n.delete(e);const r=this._hash^1<<e;return new sn(t,n,r)}covers(e){return this.set.size<=e.set.size&&Ut(It(this.bigint,e.bigint),this.bigint)}static parse(e){const t=e.split("");let n=Vt,r=0;const i=new Set;for(const[e,s]of t.entries()){if("-"===s)continue;const t=2*e;if("0"===s)n=Tt(n,Qt[t]),i.add(t),r^=1<<t;else if("1"===s)n=Tt(n,Qt[t+1]),i.add(t+1),r^=2<<t;else{if("/"!==s)throw new Error("Invalid cube string");n=Tt(n,Qt[t]),i.add(t),n=Tt(n,Qt[t+1]),i.add(t+1),r^=3<<t}}return new sn(n,i,r)}toString(){let e=this.bigint.toString(2);return e.length%2&&(e="0"+e),e.match(/.{2}/g).reverse().map((e=>"00"===e?"-":"01"===e?"0":"10"===e?"1":"/")).join("")}static from(e){let t=Vt,n=0;const r=new Set;for(const i of e)r.add(i),n^=1<<i,t=Tt(t,Qt[i]);return new sn(t,r,n)}static fromBigInt(e){let t=0;const n=new Set;let r=0,i=e;for(;Ft(i,Vt);){let e=Bt(Wt(32,i));t^=e,i=$t(i,Gt);let s=Math.clz32(e);for(;s<32;){const t=31-s;n.add(r+t),e^=1<<t,s=Math.clz32(e)}r+=32}return new sn(e,n,t)}}class on{constructor(e,t,n){this._cubes=e,this._count=t,this._bigint=n}static from(e){const t=[];let n=Vt;const r=[];for(const i of e){n=Tt(n,i.bigint),t.push(i);for(const e of i.set){for(;r.length<=e+1-e%2;)r.push(0);++r[e]}}return new on(t,r,n)}get bigint(){return this._bigint}get cubes(){return this._cubes}count(e){return this._count[e]}filter(e){const t=this._count.slice();let n=this._bigint;const r=this._cubes.filter((r=>{if(e(r))return!0;for(const e of r.set)--t[e]||(n=Mt(n,Qt[e]));return!1}));return new on(r,t,n)}pop(){const e=this._cubes.pop();if(e){for(const t of e.set)--this._count[t]||(this._bigint=Mt(this._bigint,Qt[t]));return e}}push(e){const t=this._cubes.push(e);for(const t of e.set)++this._count[t];return this._bigint=Tt(this._bigint,e.bigint),t}unshift(e){const t=this._cubes.unshift(e);for(const t of e.set)++this._count[t];return this._bigint=Tt(this._bigint,e.bigint),t}}function an(e,t=Vt,n=It(e.bigint,Lt(Tt(t,nn(t))))){let r=!1,i=!1;do{if(r=!1,e=e.filter((e=>{if(Ft(It(t,e.bigint),Vt))return!1;const s=It(e.bigint,n),o=rn(s,2);return 1===o?(r=!0,t=Tt(t,s),n=Ut(It(Zt,s),Vt)?Mt(n,$t(s,Ht)):Mt(n,Rt(s,Ht)),!1):(0===o&&(i=!0),!0)})),i)return!0}while(r);if(e.cubes.length<=1)return!1;let s=-1,o=0,a=0,l=0;const c=en(n=It(e.bigint,n)),u=new Set;for(const r of c){const i=e.count(r),c=e.count(r+1),f=i+c;if(i&&c){if(f>=o){const e=Math.min(i,c);(f>o||e>a)&&(s=r,o=f,a=e)}}else{if(f===e.cubes.length)return!1;u.add(r),t=Tt(t,Qt[i?r:r+1]),n=Mt(n,Qt[i?r+1:r])}l=Math.max(l,f)}if(-1===s)return!1;if(3*l<e.cubes.length&&c.length-u.size>8){const r=tn(e.cubes,c.filter((e=>!u.has(e))));if(r.length>1){for(const e of r)if(!an(on.from(e),t,n))return!1;return!0}}return!!an(e,Tt(t,Qt[s]),Mt(n,Qt[s+1]))&&an(e,Tt(t,Qt[s+1]),Mt(n,Qt[s]))}function ln(e,t=Vt,n=e.bigint){let r=!1,i=!1;do{if(r=!1,e=e.filter((e=>{if(Ft(It(t,e.bigint),Vt))return!1;const s=It(e.bigint,n),o=rn(s,2);return 1===o?(r=!0,t=Tt(t,s),n=Ut(It(Zt,s),Vt)?Mt(n,$t(s,Ht)):Mt(n,Rt(s,Ht)),!1):(0===o&&(i=!0),!0)})),i)return[]}while(r);if(!e.cubes.length)return[sn.fromBigInt(nn(t))];n=It(e.bigint,n);const s=[];if(1===e.cubes.length){const e=nn(t);for(const t of Xt(n))s.push(sn.fromBigInt(Tt(e,Qt[1^t])));return s}let o=-1,a=0,l=0,c=0;const u=en(n),f=new Set;for(const r of u){const i=e.count(r),u=e.count(r+1),d=i+u;if(i&&u){if(d>=a){const e=Math.min(i,u);(d>a||e>l)&&(o=r,a=d,l=e)}}else d===e.cubes.length&&(f.add(r),s.push(sn.fromBigInt(nn(Tt(t,Qt[i?r:r+1])))),n=Mt(n,Qt[i?r:r+1]));c=Math.max(c,d)}if(3*c<e.cubes.length&&u.length-f.size>8){const r=tn(e.cubes,u.filter((e=>!f.has(e))));if(r.length>1){let e=ln(on.from(r.pop()),t,n);for(const i of r){if(!e.length)return s;const r=ln(on.from(i),t,n),o=[];for(const t of e)for(const e of r)o.push(sn.fromBigInt(Tt(t.bigint,e.bigint)));e=o}return[...s,...e]}}if(-1===o)return cn(e,s,t,n),s;const d=ln(e,Tt(t,Qt[o]),Mt(n,Qt[o+1]));let h=ln(e,Tt(t,Qt[o+1]),Mt(n,Qt[o]));const p=3<<o,g=Tt(Qt[o],Qt[o+1]),m=new Set;e:for(const[e,t]of d.entries()){const n=t.hash^p;for(const r of h)if(r.hash===n&&Ut(Mt(t.bigint,r.bigint),g)){d[e]=sn.fromBigInt(It(t.bigint,r.bigint)),m.add(r);continue e}}return m.size&&(h=h.filter((e=>!m.has(e)))),[...s,...d,...h]}function cn(e,t,n,r){let i=!1,s=!1,o=512,a=Vt;do{if(o=512,a=Vt,i=!1,e=e.filter((e=>{if(Ft(It(n,e.bigint),Vt))return!1;const t=It(e.bigint,r),l=rn(t,o);return 1===l?(i=!0,n=Tt(n,t),!1):(l<o&&(a=t,o=l),0===l&&(s=!0),!0)})),s)return}while(i);if(!e.cubes.length)return void t.push(sn.fromBigInt(nn(n)));const l=Xt(a);if(1===e.cubes.length){const e=nn(n);for(const n of l)t.push(sn.fromBigInt(Tt(e,Qt[1^n])));return}let c=-1,u=0;for(const t of l){const n=e.count(t);n>u&&(c=t,u=n)}cn(e,t,Tt(n,Qt[c]),r),cn(e,t,n,Mt(r,Qt[c]))}function un(e,t){return an(e,nn(t.bigint))}function fn(e,t,n,r){const i=nn(e.bigint);let s=n.map((e=>new Set(Xt(It(i,e.bigint)))));s=s.filter((e=>e.size));let o=t.map((e=>new Set(Xt(It(i,e.bigint)))));o=o.filter((e=>e.size));const a=new Set;for(const t of e.set)a.add(1^t);const l=[];for(let e=Math.max(...a);e>=0;--e)l.push(0);for(const e of o)for(const t of e)++l[t];for(;o.length&&s.length;){const t=new Set;for(const e of s)1===e.size&&t.add(...e);if(t.size){for(const e of t)a.delete(e),s=s.filter((t=>!t.has(e))),o=o.filter((t=>!t.has(e)));const n=new Set(a);for(const e of s)for(const t of e)n.delete(t);for(const t of n)a.delete(t),e=e.raise(1^t),o=o.filter((e=>!(e.delete(t)&&!e.size)));if(!s.length||!o.length)break}const n=new Set;for(const e of o)1===e.size&&n.add(...e);if(n.size){let t=0,i=-1;for(const s of n)l[s]>t&&r(1^s,e.set)&&(t=l[s],i=s);if(i>=0){a.delete(i),e=e.raise(1^i),o=o.filter((e=>!(e.delete(i)&&!e.size)));for(const e of s)e.delete(i);continue}}let i=0,c=-1;for(const t of a)l[t]>i&&r(1^t,e.set)&&(i=l[t],c=t);if(c<0){a.clear();break}a.delete(c),e=e.raise(1^c);for(const e of o)e.delete(c);for(const e of s)e.delete(c)}if(s.length){const e=pn(s);for(const t of e)a.delete(t)}for(const t of a)r(1^t,e.set)&&(e=e.raise(1^t));return e}function dn(e,t,n,r){const i=nn(e.bigint);let s=t.map((e=>new Set(Xt(It(i,e.bigint)))));s=s.filter((e=>e.size));const o=[...e.set].map((e=>1^e)),a=[];for(let e=Math.max(...o);e>=0;--e)a.push(0);for(const e of s)for(const t of e)++a[t];for(;o.length;){const t=new Set;for(const e of s)1===e.size&&t.add(...e);o.sort(((e,n)=>+t.has(e)-+t.has(n)||a[e]-a[n]));const i=[];for(;o.length;){const t=o.pop();if(!r(1^t,e.set)){i.unshift(t);continue}const a=e.raise(1^t);if(!un(n,a)){s=s.filter((e=>!e.has(t))),o.push(...i);break}e=a;for(const e of s)e.delete(t);s=s.filter((e=>e.size)),o.push(...i.splice(0))}}return e}function hn(e,t,n,r,i){if(!e.length)return e;(e=e.slice()).sort(((e,t)=>e.set.size-t.set.size));const s=e[0];do{let s=e[0];r.has(s)||(s=n?fn(s,e,n,i):dn(s,e,on.from([...e,...t]),i)),(e=e.filter((e=>!s.covers(e)))).push(s)}while(e[0].set.size>=s.set.size&&Ft(e[0].bigint,s.bigint));return e}function pn(e){let t=new Set;const n=function(e){const t=new Map,n=e.length;for(let e=0;e<n;++e)t.set(e,new Set);for(let r=0;r<n;++r){const i=e[r],s=t.get(r);for(let o=r+1;o<n;++o){const n=e[o];let a=!1;for(const e of i)if(n.has(e)){a=!0;break}if(!a){const e=t.get(o);s.add(o),e.add(r)}}}const r=Array.from(e.keys());r.sort(((e,n)=>t.get(n).size-t.get(e).size));let i=[],s=0,o=0;return function e(r,a,l){if(o>n)return;if(!a.length&&!l.length){if(++o,r.length>=i.length){const e=r.reduce(((e,n)=>e+t.get(n).size),0);(e>s||r.length>i.length)&&(i=r,s=e,o=0)}return}const c=new Set,u=t.get(a[0]);for(const n of a){if(u.has(n))continue;const s=t.get(n),o=a.filter((e=>s.has(e)&&!c.has(e))),f=l.filter((e=>s.has(e)));if(e([...r,n],o,f),i.length>r.length+a.length)return;l.push(n),c.add(n)}}([],r,[]),i.map((t=>e[t]))}(e);let r=e;for(const i of n){const n=new Map;for(const t of e)for(const e of t)if(i.has(e)){let r=n.get(e);r||n.set(e,r=new Set),r.add(t)}const[s,o]=Array.from(n).reduce(((e,t)=>t[1].size>e[1].size?t:e));r=r.filter((e=>!o.has(e))),t.add(s)}return t=function(e,t){let n=e.map((e=>new Set([...e].filter((e=>t.has(e))))));const r=new Set;for(;;){for(const e of n)if(1===e.size){const[t]=e;r.add(t)}if(n=n.filter((e=>{for(const t of e)if(r.has(t))return!1;return e.size>1})),!n.length)break;const e=new Map;for(const t of n){for(const n of t)e.has(n)||e.set(n,new Set);if(2===t.size){const[n,r]=t,i=e.get(n),s=e.get(r);i.add(r),s.add(n)}}const t=Array.from(e).reduce(((e,t)=>t[1].size<e[1].size?t:e))[0];for(const e of n)e.delete(t)}return r}(e,t),r.length&&(t=new Set([...t,...pn(r)])),t}function gn(e,t,n,r){let i=!1,s=!1;const o=[];do{if(i=!1,e=e.filter((e=>{if(Ft(It(n,e.bigint),Vt))return!1;const a=It(e.bigint,r),l=rn(a,2);if(1===l&&!t.has(e))return i=!0,n=Tt(n,a),r=Ut(It(Zt,a),Vt)?Mt(r,$t(a,Ht)):Mt(r,Rt(a,Ht)),!1;if(0===l){const n=t.get(e);if(null!=n)return o.push(n),!1;s=!0}return!0})),s)return[]}while(i);if(e.cubes.length<=1)return[new Set(o)];let a=-1,l=0,c=0,u=0;const f=en(r=It(e.bigint,r)),d=new Set;for(const t of f){const i=e.count(t),s=e.count(t+1),o=i+s;if(i&&s){if(o>=l){const e=Math.min(i,s);(o>l||e>c)&&(a=t,l=o,c=e)}}else d.add(t),n=Tt(n,Qt[i?t:t+1]),r=Mt(r,Qt[i?t+1:t]);u=Math.max(u,o)}if(-1===a)return[new Set(o)];if(3*u<e.cubes.length&&f.length-d.size>8){const i=tn(e.cubes,f.filter((e=>!d.has(e))));if(i.length>1){let e=[new Set(o)];for(const s of i){const i=e;e=gn(on.from(s),t,n,r);const o=[];for(const t of e)for(const e of i)o.push(new Set([...t,...e]));e=o}return e}}let h=gn(e,t,Tt(n,Qt[a]),Mt(r,Qt[a+1])),p=gn(e,t,Tt(n,Qt[a+1]),Mt(r,Qt[a]));const g=new Set,m=new Set;for(const e of h)for(const t of p)if(e.size<=t.size){let n=!0;for(const r of e)if(!t.has(r)){n=!1;break}n&&m.delete(t)}else{let n=!0;for(const r of t)if(!e.has(r)){n=!1;break}n&&g.delete(e)}return g.size&&(h=h.filter((e=>!g.has(e)))),m.size&&(p=p.filter((e=>!m.has(e)))),[...h,...p].map((e=>new Set([...o,...e])))}function mn(e,t){const[n,r]=function(e,t){const n=on.from([...t,...e]),r=[],i=[];for(let t=0;t<e.length;++t){const e=n.pop();un(n,e)?i.push(e):r.push(e),n.unshift(e)}return[r,i]}(e,t),i=function(e,t,n){const r=pn(function(e,t,n){const r=new Map,i=new WeakMap;for(const[t,n]of e.entries())i.set(n,t);const s=on.from([...e,...t,...n]);for(const t of e){const e=nn(t.bigint),n=gn(s,i,e,It(s.bigint,Lt(Tt(t.bigint,e))));for(const e of n){let t=0;for(const n of e)t^=1<<n;const n=r.get(t);if(!n){r.set(t,[e]);continue}let i=!1;e:for(const t of n)if(t.size===e.size){for(const n of t)if(!e.has(n))continue e;i=!0;break}i||n.push(e)}}return[...r.values()].flat()}(e,t,n));return e.filter(((e,t)=>r.has(t)))}(function(e,t,n){const r=on.from([...n,...t]);return e.filter((e=>!un(r,e)))}(r,n,t),n,t);return[...n,...i]}function vn(e,t,n){let r=!1,i=!1;do{if(r=!1,e=e.filter((e=>{if(Ft(It(t,e.bigint),Vt))return!1;const s=It(e.bigint,n),o=rn(s,2);return 1===o?(r=!0,t=Tt(t,s),n=Ut(It(Zt,s),Vt)?Mt(n,$t(s,Ht)):Mt(n,Rt(s,Ht)),!1):(0===o&&(i=!0),!0)})),i)return Kt}while(r);if(e.cubes.length<=1)return t;let s=-1,o=0,a=0,l=0;const c=en(n=It(e.bigint,n)),u=new Set;for(const t of c){const n=e.count(t),r=e.count(t+1),i=n+r;if(n&&r){if(i>=o){const e=Math.min(n,r);(i>o||e>a)&&(s=t,o=i,a=e)}}else u.add(t),e=n?e.filter((e=>!e.set.has(t))):e.filter((e=>!e.set.has(t+1)));l=Math.max(l,i)}if(-1===s)return t;if(3*l<e.cubes.length&&c.length-u.size>8){const r=tn(e.cubes,c.filter((e=>!u.has(e))));let i=Kt;if(r.length>1){for(const e of r)i=It(i,vn(on.from(e),t,n));return i}}return It(vn(e,Tt(t,Qt[s]),Mt(n,Qt[s+1])),vn(e,Tt(t,Qt[s+1]),Mt(n,Qt[s])))}function _n(e,t,n){!function(e){if(e.length<=1)return;const t=e.reduce(((e,t)=>t.set.size<=e.set.size?t:e));e.sort(((e,n)=>{const r=rn(It(e.bigint,t.bigint)),i=e.set.size-r+(t.set.size-r),s=rn(It(n.bigint,t.bigint));return i-(n.set.size-s+(t.set.size-s))}))}(e=e.slice());for(let r=e.length;r>0;--r){const r=e.shift(),i=nn(r.bigint),s=Tt(r.bigint,i),o=[...e,...t].filter((e=>Ut(It(i,e.bigint),Vt))),a=vn(on.from(o),i,Lt(s));qt(a,Vt)&&(Ut(a,i)?(e.push(r),n.add(r)):e.push(sn.fromBigInt(nn(a))))}return e}function wn(e,t,n,r){const i=function(e,t){const n=[];for(let r=e.length;r>0;--r){const r=e.shift(),i=nn(r.bigint),s=Tt(r.bigint,i),o=[...e,...t].filter((e=>Ut(It(i,e.bigint),Vt))),a=vn(on.from(o),i,Lt(s));Ft(a,i)&&qt(a,Vt)&&n.push(sn.fromBigInt(nn(a))),e.push(r)}return n}(e,t),s=[],o=r?null:on.from([...e,...t]);for(let e=i.length;e>0;--e){const e=i.shift(),t=r?fn(e,i,r,n):dn(e,i,o,n);for(const e of i)t.covers(e)&&s.push(t);i.push(e)}return s.length?mn([...e,...s],t):e}function bn(e){return e.reduce(((e,t)=>e+t.set.size),0)}function yn(e){return e.map((e=>sn.from(e)))}function An(e){return e.map((e=>[...e.set]))}function Sn(e){return An(ln(on.from(yn(e))))}function xn(e,t=[],n={}){const r=yn(e),i=yn(t);return An(function(e,t,n,r=(()=>!0)){if(!e.length)return e;const i=new WeakSet,s=function(e,t){const n=[...t,...e],r=[];for(let t=0;t<e.length;++t){const e=n.pop(),t=nn(e.bigint),i=[];for(const e of n){const n=It(t,e.bigint),r=rn(n,2);0===r?i.push(e):1===r&&i.push(sn.fromBigInt(Mt(e.bigint,n)))}an(on.from(i),t)||r.push(e),n.unshift(e)}return r}(e=mn(e=hn(e,t,n,i,r),t),t);s.length&&(e=e.filter((e=>!s.includes(e))),t=[...t,...s]);let o=bn(e);for(;;){let s=_n(e,t,i);s=hn(s,t,n,i,r),s=mn(s,t);let a=bn(s);if(a>=o&&(s=wn(e,t,r,n),a=bn(s),a>=o))break;o=a,e=s}return[...s,...e]}(r,i,n.computeOffSet?ln(on.from([...r,...i])):void 0,n.canRaise))}const Dn=zt(0),kn=zt(1),On=zt(2),Cn=zt(-1);class En{constructor(e){this.map=new Map,e?(this.map.set(e,1),this.sortedKeys=[e]):this.sortedKeys=[]}reciprocal(){const e=new En;e.sortedKeys=this.sortedKeys,e.map=new Map;for(const[t,n]of this.map)e.map.set(t,0-n);return e}static multiply(e,t){const n=new En;n.sortedKeys=e.sortedKeys.slice(),n.map=new Map(e.map);for(const[e,r]of t.map){const t=n.map.get(e);if(t){const i=r+t;i?n.map.set(e,i):(n.map.delete(e),n.sortedKeys=n.sortedKeys.filter((t=>t!==e)))}else n.map.set(e,r),n.sortedKeys.push(e)}return n.sortedKeys.sort(((e,t)=>e.length!==t.length?t.length-e.length:e>t?1:e<t?-1:0)),n}static compare(e,t){if(e.sortedKeys.length!==t.sortedKeys.length)return t.sortedKeys.length-e.sortedKeys.length;for(let n=0;n<e.sortedKeys.length;++n){const r=e.sortedKeys[n],i=e.map.get(r),s=t.sortedKeys[n],o=t.map.get(s);if(i!==o)return o-i;if(r.length>s.length)return-1;if(r.length<s.length)return 1;if(r>s)return 1;if(r<s)return-1}return 0}}function Pn(e,t){for(;Nt(t,Dn);){const n=t;t=Et(e,t),e=n}return e}class Nn{constructor(e){this.terms=e}static simplifyTerms(e){const t=e.slice().sort(((e,t)=>En.compare(e.indeterminates,t.indeterminates)));for(let e=1;e<t.length;++e){const n=t[e-1],r=t[e];if(0===En.compare(n.indeterminates,r.indeterminates)){const i=kt(Ot(n.coefficientNumerator,r.coefficientDenominator),Ot(r.coefficientNumerator,n.coefficientDenominator)),s=Ot(n.coefficientDenominator,r.coefficientDenominator),o=Pn(i,s);t[e]={indeterminates:r.indeterminates,coefficientNumerator:Ct(i,o),coefficientDenominator:Ct(s,o)},t[e-1]={indeterminates:n.indeterminates,coefficientNumerator:Dn,coefficientDenominator:n.coefficientDenominator}}}return t.filter((e=>Nt(e.coefficientNumerator,Dn)))}static fromIndeterminate(e){const t=new En(JSON.stringify(e));return new Nn([{indeterminates:t,coefficientNumerator:kn,coefficientDenominator:kn}])}static fromConstant(e){const[t,n]=Math.abs(e).toString(2).split(".",2);let r=zt("0b"+t);e<0&&(r=Ot(r,Cn));let i=kn;var s,o;n&&(s=On,o=zt(n.length),i=Dt.exponentiate(s,o),r=kt(Ot(r,i),zt("0b"+n)));const a=[{indeterminates:new En,coefficientNumerator:r,coefficientDenominator:i}];return new Nn(a)}negation(){const e=this.terms.map((e=>({indeterminates:e.indeterminates,coefficientNumerator:Ot(e.coefficientNumerator,Cn),coefficientDenominator:e.coefficientDenominator})));return new Nn(e)}reciprocal(){const e=this.terms.map((e=>({indeterminates:e.indeterminates.reciprocal(),coefficientNumerator:e.coefficientDenominator,coefficientDenominator:e.coefficientNumerator})));return new Nn(e)}constant(){const e=this.terms.filter((e=>!e.indeterminates.sortedKeys.length));return new Nn(e)}add(e){return new Nn(Nn.simplifyTerms(this.terms.concat(e.terms)))}subtract(e){return this.add(e.negation())}multiply(e){const t=[];for(const n of this.terms)for(const r of e.terms){const e=Ot(n.coefficientNumerator,r.coefficientNumerator),i=Ot(n.coefficientDenominator,r.coefficientDenominator),s=Pn(e,i);t.push({indeterminates:En.multiply(n.indeterminates,r.indeterminates),coefficientNumerator:Ct(e,s),coefficientDenominator:Ct(i,s)})}return new Nn(Nn.simplifyTerms(t))}divide(e){return this.multiply(e.reciprocal())}toString(){const e=[];for(const t of this.terms){const n=Pt(t.coefficientNumerator)/Pt(t.coefficientDenominator),r=[];if(t.indeterminates.sortedKeys.length){for(const e of t.indeterminates.sortedKeys){const n=t.indeterminates.map.get(e);for(let t=Math.abs(n);t>0;--t)n>0?r.push(e):r.push(`["/",1,${e}]`)}1!==n&&r.push(n.toString()),r.length>1?e.push(`["*",${r.join(",")}]`):e.push(r[0])}else e.push(n.toString())}return e.length?1===e.length?e[0]:`["+",${e.join(",")}]`:"0"}}class jn{}class zn extends jn{true(){return[[]]}false(){return[]}null(){return[]}}class In extends jn{true(){return[]}false(){return[[]]}null(){return[]}}class Tn extends jn{true(){return[]}false(){return[]}null(){return[[]]}}class Mn extends jn{constructor(e){if(super(),this.negate=!1,Array.isArray(e)){const t=e[0];"<>"===t?((e=e.slice())[0]="=",this.negate=!0):">="===t?((e=e.slice())[0]="<",this.negate=!0):"<="===t&&((e=e.slice())[0]=">",this.negate=!0)}this.expStr=JSON.stringify(e)}true(e){let t=e.get(this.expStr);return null==t&&e.set(this.expStr,t=e.size),[[t<<2^(this.negate?1:3)]]}false(e){let t=e.get(this.expStr);return null==t&&e.set(this.expStr,t=e.size),[[t<<2^(this.negate?3:1)]]}null(e){let t=e.get(this.expStr);return null==t&&e.set(this.expStr,t=e.size),[[t<<2,t<<2^2]]}}class Ln extends jn{constructor(e){super(),this.exprSynth=e}true(e){return this.exprSynth.false(e)}false(e){return this.exprSynth.true(e)}null(e){return this.exprSynth.null(e)}}class Rn extends jn{constructor(e){super(),this.exprSynth=e}true(e){return this.exprSynth.null(e)}false(e){return[...this.exprSynth.true(e),...this.exprSynth.false(e)]}null(){return[]}}class $n extends jn{constructor(...e){super(),this.exprSynths=e.filter((e=>!(e instanceof In)));const t=[];this.exprSynths=this.exprSynths.filter((e=>!(e instanceof $n&&(t.push(...e.exprSynths),1)))),this.exprSynths.push(...t)}true(e){return 0===this.exprSynths.length?[]:1===this.exprSynths.length?this.exprSynths[0].true(e):this.exprSynths.some((e=>e instanceof zn))?[[]]:this.exprSynths.map((t=>t.true(e))).flat()}false(e){return 0===this.exprSynths.length?[[]]:1===this.exprSynths.length?this.exprSynths[0].false(e):this.exprSynths.some((e=>e instanceof zn||e instanceof Tn))?[]:Sn(this.exprSynths.map((t=>Sn(t.false(e)))).flat())}null(e){if(0===this.exprSynths.length)return[];if(1===this.exprSynths.length)return this.exprSynths[0].null(e);const t=this.exprSynths.map((t=>t.null(e))).flat(),n=this.exprSynths.map((t=>t.true(e))).flat();return Sn([...Sn(t),...n])}}class Bn extends jn{constructor(...e){super(),this.exprSynths=e.filter((e=>!(e instanceof zn)));const t=[];this.exprSynths=this.exprSynths.filter((e=>!(e instanceof Bn&&(t.push(...e.exprSynths),1)))),this.exprSynths.push(...t)}true(e){return 0===this.exprSynths.length?[[]]:1===this.exprSynths.length?this.exprSynths[0].true(e):this.exprSynths.some((e=>e instanceof In||e instanceof Tn))?[]:Sn(this.exprSynths.map((t=>Sn(t.true(e)))).flat())}false(e){return 0===this.exprSynths.length?[]:1===this.exprSynths.length?this.exprSynths[0].false(e):this.exprSynths.some((e=>e instanceof In))?[[]]:this.exprSynths.map((t=>t.false(e))).flat()}null(e){if(0===this.exprSynths.length)return[];if(1===this.exprSynths.length)return this.exprSynths[0].null(e);const t=this.exprSynths.map((t=>t.null(e))).flat(),n=this.exprSynths.map((t=>t.false(e))).flat();return Sn([...Sn(t),...n])}}class Un extends jn{constructor(e){super(),this.exprSynths=e}true(e){const t=[],n=[];for(let r=0;r<this.exprSynths.length;r+=2){const i=this.exprSynths[r].true(e),s=this.exprSynths[r+1].true(e);t.push(...Sn([...n,...Sn(i),...Sn(s)])),r<this.exprSynths.length-2&&n.push(...Sn([...this.exprSynths[r].false(e),...this.exprSynths[r].null(e)]))}return t}false(e){const t=[],n=[];for(let r=0;r<this.exprSynths.length;r+=2){const i=this.exprSynths[r].true(e),s=this.exprSynths[r+1].false(e);t.push(...Sn([...n,...Sn(i),...Sn(s)])),r<this.exprSynths.length-2&&n.push(...Sn([...this.exprSynths[r].false(e),...this.exprSynths[r].null(e)]))}return t}null(e){const t=[],n=[];for(let r=0;r<this.exprSynths.length;r+=2){const i=this.exprSynths[r].true(e),s=this.exprSynths[r+1].null(e);t.push(...Sn([...n,...Sn(i),...Sn(s)])),n.push(...Sn([...this.exprSynths[r].false(e),...this.exprSynths[r].null(e)]))}return t.push(...Sn([...n])),t}}const Fn=Nn.fromConstant(0),qn=Nn.fromConstant(1),Wn={"=":"=","<>":"<>",">":"<",">=":"<=","<":">","<=":">="};function Jn(e){if(!Array.isArray(e))return e;const t=e[0];if("FUNC"===t&&"COALESCE"===e[1]){const t=["CASE"];for(let n=2;n<e.length;++n)t.push(Jn(["IS NOT NULL",e[n]]),e[n]);return Jn(t)}if("CASE"===t){const t=[];for(let n=1;n<e.length;n+=2){let r=e[n];if(r instanceof Nn&&(r=JSON.parse(r.toString())),!Array.isArray(r)&&!r)continue;const i=e[n+1];if(Array.isArray(i)&&"CASE"===i[0]){for(let e=1;e<i.length;e+=2)t.push([ft(r,i[e]),i[e+1]]);if(t.push([r,null]),!Array.isArray(r)&&r)break}else t.push([r,i])}for(;null==t[t.length-1][1];)t.pop();return["CASE",...t.flat()]}const n=new Map;for(const[t,r]of e.entries()){if(!Array.isArray(r))continue;if("CASE"!==r[0])continue;const e=[];for(let t=1;t<r.length;t+=2)e.push([r[t],r[t+1]]);n.set(t,e)}if(n.size){let t=[[!0,e]];for(const[e,r]of n){const n=[];for(const[i,s]of r)n.push(...t.map((t=>{const n=t[1].slice();return n[e]=s,[ft(i,t[0]),n]})));t=n}for(const e of t)e[1]=Jn(e[1]);if(!0===t[0][0])return t[0][1];for(;null==t[t.length-1][1];)t.pop();return["CASE",...t.flat()]}function r(e){return null==e?null:e instanceof Nn?e:"number"==typeof e?Nn.fromConstant(e):"string"==typeof e?Nn.fromConstant(parseFloat(e)||0):"boolean"==typeof e?Nn.fromConstant(+e):Nn.fromIndeterminate(e)}if("+"===t){const t=[];for(let n=1;n<e.length;++n){const i=r(e[n]);if(null==i)return null;t.push(i)}return t.reduce(((e,t)=>e.add(t)),Fn)}if("*"===t){const t=[];for(let n=1;n<e.length;++n){const i=r(e[n]);if(null==i)return null;t.push(i)}return t.reduce(((e,t)=>e.multiply(t)),qn)}if("-"===t){const t=[];for(let n=1;n<e.length;++n){const i=r(e[n]);if(null==i)return null;t.push(i)}return t.reduce(((e,t)=>e.subtract(t)))}if("/"===t){const t=[];for(let n=1;n<e.length;++n){const i=r(e[n]);if(null==i)return null;t.push(i)}return t.reduce(((e,t)=>e.divide(t)))}if(["=","<>",">",">=","<","<="].includes(t)){if(null==e[1]||null==e[2])return null;let n,r;if(e[1]instanceof Nn?n=e[1]:"number"==typeof e[1]&&(n=Nn.fromConstant(e[1])),e[2]instanceof Nn?r=e[2]:"number"==typeof e[2]&&(r=Nn.fromConstant(e[2])),n||r)if(n||(n=Nn.fromIndeterminate(e[1])),r||(r=Nn.fromIndeterminate(e[2])),n=n.subtract(r),r=n.constant().negation(),n=n.add(r),n.terms.length){let i=1;const s=n.terms[0].coefficientNumerator,o=n.terms[0].coefficientDenominator;(jt(s,Dn)||jt(o,Dn))&&(i*=-1);const a=new Nn([{indeterminates:new En,coefficientNumerator:o,coefficientDenominator:s}]);n=n.multiply(a),r=r.multiply(a);const l=n.terms[0].indeterminates.sortedKeys;let c=n.terms[0].indeterminates.map.get(l[0])<0?-1:0;for(const e of n.terms)for(const t of e.indeterminates.map.values())c+=t;c<0&&(i*=-1,n=n.reciprocal(),r=r.reciprocal()),e=i<0?[Wn[t],n,r]:[t,n,r]}else{if(e=[t,JSON.parse(n.toString()),JSON.parse(r.toString())],"="===t)return e[1]===e[2];if("<>"===t)return e[1]!==e[2];if(">"===t)return e[1]>e[2];if(">="===t)return e[1]>=e[2];if("<"===t)return e[1]<e[2];if("<="===t)return e[1]<=e[2]}}return ct(e=e.map((e=>e instanceof Nn?JSON.parse(e.toString()):e)))}function Vn(e){return(e=Qe(e,Jn))instanceof Nn?e=JSON.parse(e.toString()):Array.isArray(e)&&"CASE"===e[0]&&(e=e.map((e=>e instanceof Nn?JSON.parse(e.toString()):e))),e}function Hn(e){return e instanceof jn?e:Array.isArray(e)?"CASE"===e[0]?new Un(e.slice(1).map((e=>Hn(e)))):new Mn(e):null==e?new Tn:e?new zn:new In}function Kn(e,t){if(!e.length)return!1;const n=[];for(const r of e){if(!r.length)return!0;const e=[];for(const n of r){let r=t.get(n>>>2);if(!(1&n)!=!(2&n)&&(r=["NOT",r]),Array.isArray(r)&&"NOT"===r[0]&&Array.isArray(r[1])){const e=r[1];r="IS NULL"===e[0]?["IS NOT NULL",...e.slice(1)]:"="===e[0]?["<>",...e.slice(1)]:"<>"===e[0]?["=",...e.slice(1)]:">"===e[0]?["<=",...e.slice(1)]:">="===e[0]?["<",...e.slice(1)]:"<"===e[0]?[">=",...e.slice(1)]:"<="===e[0]?[">",...e.slice(1)]:"NOT"===e[0]?e[1]:["NOT",e]}e.push(r)}e.length>1?n.push(["AND"].concat(e)):n.push(e[0])}return n.length>1?["OR"].concat(n):n[0]}function Gn(e){const t=new Map;for(const[n,r]of e){const e=r[0];if(["=",">","<"].includes(e)&&!Array.isArray(r[2])){const i=JSON.stringify(r[1]);let s=t.get(i);s||t.set(i,s=[]),s.push({op:e,rhs:r[2],var:n})}else{const e=JSON.stringify(r);let i=t.get(e);i||t.set(e,i=[]),i.push({op:"",rhs:null,var:n})}}const n=[],r=new Map;for(const[i,s]of t){const t=e.size;e.set(t,["IS NULL",JSON.parse(i)]),'["PARAM","DeviceID.ID"]'!==i&&'["PARAM","_id"]'!==i||n.push([t<<2^3]);const o=new Map;for(const e of s){if(!e.op)continue;const t=JSON.stringify(e.rhs),n=o.get(t);n?n.set(e.op,e.var):o.set(t,new Map([[e.op,e.var]]))}for(const[t,r]of o)if(r.size>1){if(!r.has("=")){const n=e.size;e.set(n,["=",JSON.parse(i),JSON.parse(t)]),s.push({op:"=",rhs:JSON.parse(t),var:n}),r.set("=",n)}if(!r.has(">")){const n=e.size;e.set(n,[">",JSON.parse(i),JSON.parse(t)]),s.push({op:">",rhs:JSON.parse(t),var:n}),r.set(">",n)}if(!r.has("<")){const n=e.size;e.set(n,["<",JSON.parse(i),JSON.parse(t)]),s.push({op:"<",rhs:JSON.parse(t),var:n}),r.set("<",n)}n.push([r.get("=")<<2^1,r.get(">")<<2^1,r.get("<")<<2^1])}for(let e=0;e<s.length;++e){const i=s[e];if(r.set(i.var,t),n.push([t<<2^3,i.var<<2^1]),n.push([t<<2^3,i.var<<2^3]),n.push([i.var<<2^0,i.var<<2^2,t<<2^2]),i.op)for(let t=e+1;t<s.length;++t){const e=s[t];if(!e.op)continue;let r=0;if(Array.isArray(i.rhs)||Array.isArray(e.rhs)){if(JSON.stringify(i.rhs)!==JSON.stringify(e.rhs))continue}else"string"==typeof i.rhs?"string"==typeof e.rhs?i.rhs>e.rhs?r=1:i.rhs<e.rhs&&(r=-1):r=1:r="string"==typeof e.rhs?-1:+i.rhs-+e.rhs;if(i.op===e.op)0===r?n.push([i.var<<2^1,e.var<<2^1]):"="===i.op?n.push([i.var<<2^3,e.var<<2^3]):">"===i.op&&r>0||"<"===i.op&&r<0?n.push([i.var<<2^3,e.var<<2^1]):("<"===i.op&&r>0||">"===i.op&&r<0)&&n.push([i.var<<2^1,e.var<<2^3]);else if("="===i.op||"="===e.op){let t=i,s=e,o=r;"="!==i.op&&(s=i,t=e,o=-r),">"!==s.op&&"<"!==s.op||(0===o?n.push([t.var<<2^3,s.var<<2^3]):o>0&&">"===s.op||o<0&&"<"===s.op?n.push([t.var<<2^3,s.var<<2^1]):n.push([t.var<<2^3,s.var<<2^3]))}else[">","<"].includes(i.op)&&[">","<"].includes(e.op)&&(">"===i.op&&r<0||"<"===i.op&&r>0?n.push([i.var<<2^1,e.var<<2^1]):n.push([i.var<<2^3,e.var<<2^3]))}}}return{dcSet:n,isNull:r}}function Qn(e,t){const n=[];e:for(const r of e){const e=new Map;for(const t of r)e.set(t>>2,(e.get(t>>2)||0)|1<<(3&t));const i=[],s=[];for(const[n,r]of e){if(10===r)continue e;const e=t.get(n)<<2,o=n<<2;5===r?i.push(3^e):1===r?s.push([3^e,3^o]):4===r?s.push([3^e,1^o]):8&r?i.push(3^o):2&r&&i.push(1^o)}let o=[i];for(;s.length;){const e=[],t=s.pop();for(const n of t)e.push(...o.map((e=>[...e,n])));o=e}n.push(...o)}return n}function Yn(e){const t=new Map;let n=e.true(t);const r=new Map(Array.from(t).map((([e,t])=>[t,JSON.parse(e)]))),{dcSet:i,isNull:s}=Gn(r);return n=Qn(n,s),n=xn(n,i,{canRaise:Xn(s)}),Kn(n,r)}function Zn(e){if(!Array.isArray(e))return e;if("CASE"===e[0]){e=e.slice();for(let t=1;t<e.length;t+=2)e[t]=Hn(e[t]);return e}const t=e[0];if("IS NULL"===t)return new Rn(Hn(e[1]));if("IS NOT NULL"===t)return new Ln(new Rn(Hn(e[1])));if("NOT"===t)return new Ln(Hn(e[1]));if("OR"===t)return new $n(...e.slice(1).map((e=>Hn(e))));if("AND"===t)return new Bn(...e.slice(1).map((e=>Hn(e))));for(let t=1;t<e.length;++t)if(e[t]instanceof jn)e[t]=Yn(e[t]);else if(Array.isArray(e[t])&&"CASE"===e[t][0])for(let n=2;n<e[t].length;n+=2)e[t][n]instanceof jn&&(e[t][n]=Yn(e[t][n]));return e}function Xn(e){return(t,n)=>{const r=t>>2,i=e.get(r);if(null!=i)return!(1&t&&!n.has(i<<2^2)&&!n.has(i<<2^3)&&n.has(3^t));for(const[t,i]of e)if(i===r&&!n.has(t<<2^1)&&!n.has(t<<2^3)){if(n.has(t<<2^0))return!1;if(n.has(t<<2^2))return!1}return!0}}function er(e,t){if(!(t=Vn(t)))return[e,!1];if(t=Qe(t,Zn),!e)return Array.isArray(t)&&"CASE"===t[0]&&(t=Hn(t)),t instanceof jn&&(t=Yn(t)),[t,t];const n=Hn(t),r=Hn(e=Qe(e=Vn(e),Zn)),i=new Map,s=n.true(i),o=r.true(i),a=r.null(i),l=r.false(i),c=new Map(Array.from(i).map((([e,t])=>[t,JSON.parse(e)]))),{dcSet:u,isNull:f}=Gn(c),d=Qn([...o,...s],f),h=Qn(Sn([...Sn([...a,...l]),...Sn(s)]),f),p=Xn(f),g=xn(d,u,{canRaise:p}),m=xn(h,u,{canRaise:p});return[Kn(g,c),Kn(m,c)]}const tr=vt(et),nr=vt(ut);let rr,ir,sr,or=0;const ar={filter:new WeakMap,bookmark:new WeakMap,limit:new WeakMap,sort:new WeakMap,fulfilled:new WeakMap,fulfilling:new WeakSet,accessed:new WeakMap,value:new WeakMap},lr={};for(const e of["devices","faults","files","presets","provisions","virtualParameters","files","config","users","permissions"])lr[e]={objects:new Map,count:new Map,fetch:new Map,combinedFilter:null};class cr{get fulfilled(){return ar.accessed.set(this,Date.now()),!!ar.fulfilled.get(this)}get fulfilling(){return ar.accessed.set(this,Date.now()),ar.fulfilling.has(this)}get value(){return ar.accessed.set(this,Date.now()),ar.value.get(this)}}async function ur(e){const t=e.extract,n=e.deserialize;return e.extract=(e,r)=>{if("function"==typeof t)return t(e,r);if(304!==e.status&&2!==Math.floor(e.status/100)){if(403===e.status)throw new Error("Not authorized");const t=new Error;throw t.message=0===e.status?"Server is unreachable":"Unexpected response status code "+e.status,t.code=e.status,t.response=e.responseText,t}let i;if("function"==typeof n)i=n(e.responseText);else if((e.getResponseHeader("content-type")||"").startsWith("application/json"))try{i=e.responseText?JSON.parse(e.responseText):null}catch(t){throw new Error("Invalid JSON: "+e.responseText.slice(0,80))}else i=e.responseText;return i},z.request(e)}function fr(e){return Array.isArray(e)?nr(e,null,or):e}function dr(e,t){const n=tr(t);let r=lr[e].count.get(n);return r||(r=new cr,lr[e].count.set(n,r),ar.filter.set(r,t),r)}function hr(e,t,n){return ft(e,Object.entries(t).sort(((e,t)=>Math.abs(t[1])-Math.abs(e[1]))).reverse().reduce(((e,t)=>{const[r,i]=t;if(i<=0){if(null==n[r])return dt(["IS NOT NULL",["PARAM",r]],ft(["IS NULL",["PARAM",r]],e));let t=null;return t=dt(t,[">",["PARAM",r],n[r]]),dt(t,ft(["=",["PARAM",r],n[r]],e))}{let t=["IS NULL",["PARAM",r]];return null==n[r]?ft(t,e):(t=dt(t,["<",["PARAM",r],n[r]]),dt(t,ft(["=",["PARAM",r],n[r]],e)))}}),!0))}function pr(e,t,n,r){let i=[];for(const n of lr[e].objects.values())ut(t,n,or)&&i.push(n);return i=i.sort(function(e){const t=Object.entries(e).sort(((e,t)=>Math.abs(t[1])-Math.abs(e[1])));return(e,n)=>{for(const[r,i]of t){let t=e[r],s=n[r];if(null!=t&&"object"==typeof t&&(t=t.value?t.value[0]:null),null!=s&&"object"==typeof s&&(s=s.value?s.value[0]:null),t>s)return i;if(t<s)return-1*i;if(t!==s){const e={null:1,number:2,string:3},n=e[null==t?"null":typeof t]||4,r=e[null==s?"null":typeof s]||4;return Math.max(-1,Math.min(1,n-r))*i}}return 0}}(n)),r&&(i=i.slice(0,r)),i}function gr(e,t,n={}){const r=tr(t),i=Object.assign({},n.sort);for(const[e,t]of Object.entries(i))i[e]+=Math.sign(t);const s=n.limit||0;"devices"===e?i["DeviceID.ID"]=i["DeviceID.ID"]||1:i._id=i._id||1;const o=`${r}:${s}:${JSON.stringify(i)}`;let a=lr[e].fetch.get(o);return a||(a=new cr,lr[e].fetch.set(o,a),ar.filter.set(a,t),ar.limit.set(a,s),ar.sort.set(a,i),function(e,t){const n=ar.limit.get(t);let r=ar.filter.get(t);r=fr(r);const i=ar.bookmark.get(t),s=ar.sort.get(t);!i&&n||(i&&(r=hr(r,s,i)),function(e,t){if(!(t=Vn(t)))return!0;if(e=Vn(e),!Array.isArray(e))return!!e;const n=Hn(e=Qe(e,Zn)),r=Hn(t=Qe(t,Zn)),i=new Map,s=n.true(i),o=r.true(i),a=new Map(Array.from(i).map((([e,t])=>[t,JSON.parse(e)]))),{dcSet:l}=Gn(a);return c=[...Sn(o),...l,...s],an(on.from(yn(c)));var c}(lr[e].combinedFilter,r)&&ar.fulfilled.set(t,or)),ar.value.set(t,pr(e,r,s,n))}(e,a),a)}function mr(e,t,n){(function(e,t){let n=!1;if(t>or){for(const e of Object.values(lr))e.combinedFilter=null;or=t}const r=[];for(const[t,i]of Object.entries(lr))for(const[s,o]of i.count)ar.accessed.get(o)>=e?ar.fulfilling.has(o)||or<=ar.fulfilled.get(o)||(ar.fulfilling.add(o),r.push(new Promise(((e,r)=>{n=!0;let i=ar.filter.get(o);i=fr(i),ur({method:"HEAD",url:`api/${t}/?`+z.buildQueryString({filter:tr(i)}),extract:e=>{if(403===e.status)throw new Error("Not authorized");if(!e.status)throw new Error("Server is unreachable");if(200!==e.status)throw new Error("Unexpected response status code "+e.status);return+e.getResponseHeader("x-total-count")},background:!0}).then((t=>{ar.value.set(o,t),ar.fulfilled.set(o,or),ar.fulfilling.delete(o),e()})).catch((e=>r(e)))})))):i.count.delete(s);const i={};for(const[t,s]of Object.entries(lr))for(const[o,a]of s.fetch)if(ar.accessed.get(a)>=e){if(!(ar.fulfilling.has(a)||or<=ar.fulfilled.get(a))){ar.fulfilling.add(a),i[t]=i[t]||[],i[t].push(a);const e=ar.limit.get(a),s=ar.sort.get(a);e&&r.push(new Promise(((r,i)=>{n=!0;let o=ar.filter.get(a);o=fr(o),ur({method:"GET",url:`api/${t}/?`+z.buildQueryString({filter:tr(o),limit:1,skip:e-1,sort:JSON.stringify(s),projection:Object.keys(s).join(",")})}).then((e=>{if(e.length){const t=Object.keys(s).reduce(((t,n)=>(null!=e[0][n]&&("object"==typeof e[0][n]?null!=e[0][n].value&&(t[n]=e[0][n].value[0]):t[n]=e[0][n]),t)),{});ar.bookmark.set(a,t)}else ar.bookmark.delete(a);r()})).catch(i)})))}}else s.fetch.delete(o);return new Promise(((e,t)=>{Promise.all(r).then((()=>{const r=[];for(const[e,t]of Object.entries(i)){let i=null;for(const e of t){let t=ar.filter.get(e);t=nr(t,null,or);const n=ar.bookmark.get(e),r=ar.sort.get(e);n&&(t=hr(t,r,n)),i=dt(i,t)}const[s,o]=er(lr[e].combinedFilter,i);if(!o){for(const n of t){let t=ar.filter.get(n);t=nr(t,null,or);const r=ar.limit.get(n),i=ar.bookmark.get(n),s=ar.sort.get(n);i&&(t=hr(t,s,i)),ar.value.set(n,pr(e,t,s,r)),ar.fulfilled.set(n,or),ar.fulfilling.delete(n)}continue}n=!0;let a=new Set;lr[e].combinedFilter||(a=new Set(lr[e].objects.keys()));const l=o;lr[e].combinedFilter=s,r.push(new Promise(((n,r)=>{ur({method:"GET",url:`api/${e}/?`+z.buildQueryString({filter:tr(l)})}).then((r=>{for(const t of r){const n="devices"===e?t["DeviceID.ID"].value[0]:t._id;lr[e].objects.set(n,t),a.delete(n)}for(const t of a){const n=lr[e].objects.get(t);ut(l,n,or)&&lr[e].objects.delete(t)}for(const n of t){let t=ar.filter.get(n);t=fr(t);const r=ar.limit.get(n),i=ar.bookmark.get(n),s=ar.sort.get(n);i&&(t=hr(t,s,i)),ar.value.set(n,pr(e,t,s,r)),ar.fulfilled.set(n,or),ar.fulfilling.delete(n)}n()})).catch(r)})))}Promise.all(r).then((()=>e(n))).catch(t)})).catch(t)}))})(e,t).then(n,(e=>{bt("error",e.message),n&&n(!1)}))}function vr(e,t){for(const n of t)n.status="pending",n.device=e;return ur({method:"POST",url:`api/devices/${encodeURIComponent(e)}/tasks`,body:t,extract:e=>{if(403===e.status)throw new Error("Not authorized");if(!e.status)throw new Error("Server is unreachable");if(200!==e.status)throw new Error(e.response);const n=e.getResponseHeader("Connection-Request"),r=JSON.parse(e.response);for(const[e,n]of r.entries())t[e]._id=n._id,t[e].status=n.status,t[e].fault=n.fault;return n}})}function _r(e,t){return ur({method:"POST",url:`api/devices/${encodeURIComponent(e)}/tags`,body:t})}function wr(e,t){return ur({method:"DELETE",url:`api/${e}/${encodeURIComponent(t)}`})}function br(e,t,n){for(const e in n)void 0===n[e]&&(n[e]=null);return ur({method:"PUT",url:`api/${e}/${encodeURIComponent(t)}`,body:n})}function yr(e,t){const n=["=",["PARAM","devices"===e?"DeviceID.ID":"_id"],t];return ur({method:"HEAD",url:`api/${e}/?`+z.buildQueryString({filter:tr(n)}),extract:e=>{if(403===e.status)throw new Error("Not authorized");if(!e.status)throw new Error("Server is unreachable");if(200!==e.status)throw new Error("Unexpected response status code "+e.status);return+e.getResponseHeader("x-total-count")},background:!0})}function Ar(e,t){return Array.isArray(e)?nr(e,t,or):e}function Sr(e,t,n){const r={newPassword:t};return n&&(r.authPassword=n),ur({method:"PUT",url:`api/users/${e}/password`,background:!0,body:r})}function xr(e){return z("svg.icon.icon-"+e,{key:"icon-"+e},z("use",{href:"icons.svg#icon-"+e}))}setInterval((function(){z.request({url:"status",method:"GET",background:!0,extract:e=>{if(200!==e.status)rr||(rr=bt("warning","Server is unreachable",{}));else{rr&&(yt(rr),rr=null);const t=e.getResponseHeader("x-config-snapshot")!==St,n=e.getResponseHeader("genieacs-version")!==xt;!ir!=!t&&(ir?(yt(ir),ir=null):ir=bt("warning","Configuration has been modified, please reload the page",{Reload:()=>{window.location.reload()}})),!sr!=!n&&(sr?(yt(sr),sr=null):sr=bt("warning","Server has been updated, please reload the page",{Reload:()=>{window.location.reload()}}))}}}).catch((e=>{bt("error",e.message)}))}),3e3);const Dr=new Set,kr=new Set;function Or(e){let t=Dr.size;for(const n of e)Dr.has(n)||++t;return t<=100}function Cr(...e){if(Or(e))for(const t of e)t.status="queued",Dr.add(t);else bt("error","Too many tasks in queue")}function Er(e){Dr.delete(e)}function Pr(){return Dr}function Nr(){Dr.clear()}function jr(){return kr}function zr(e){Dr.size+e.devices.length>100?bt("error","Too many tasks in queue"):kr.add(e)}function Ir(e,t){const n={};if(!Or(e))return Promise.reject(new Error("Too many tasks in queue"));for(const t of e)n[t.device]=n[t.device]||[],n[t.device].push(t),t.status="queued",Dr.add(t);return new Promise((e=>{let r=1;for(const[i,s]of Object.entries(n))++r,vr(i,s).then((n=>{for(const e of s)"pending"===e.status?e.status="stale":"done"===e.status&&Dr.delete(e);t(i,null,n,s),0==--r&&e()})).catch((n=>{for(const e of s)e.status="stale";t(i,n,null,s),0==--r&&e()}));0==--r&&e()}))}const Tr=new WeakSet;function Mr(e){return z("span.parameter",{title:e},""+e)}function Lr(e,t,n){function r(e){"Enter"===e.key?t():"Escape"===e.key?n():e.redraw=!1}let i;return i="xsd:boolean"===e.parameterValues[0][2]?z("select",{value:e.parameterValues[0][1].toString(),onchange:t=>{t.redraw=!1,e.parameterValues[0][1]=i.dom.value},onkeydown:r,oncreate:e=>{e.dom.focus()}},[z("option",{value:"true"},"true"),z("option",{value:"false"},"false")]):z("input",{type:["xsd:dateTime","xsd:int","xsd:unsignedInt"].includes(e.parameterValues[0][2])?"number":"text",value:e.parameterValues[0][1],oninput:t=>{t.redraw=!1,e.parameterValues[0][1]=i.dom.value},onkeydown:r,oncreate:e=>{e.dom.focus(),e.dom.select(),e.dom.parentNode.parentNode.scrollTop=0}}),[z("span","Editing ",Mr(e.parameterValues[0][0])),i]}function Rr(e){e.fileName&&e.fileType?Tr.delete(e):Tr.add(e);const t=gr("files",!0);let n="",r="";for(const t of e.devices){const e=t.split("-");""===n?n=e[0]:n!==e[0]&&(n=null),3===e.length&&(""===r?r=e[1]:r!==e[1]&&(r=null))}n&&(n=decodeURIComponent(n)),r&&(r=decodeURIComponent(r));const i=["","1 Firmware Upgrade Image","2 Web Content","3 Vendor Configuration File","4 Tone File","5 Ringer File"].map((t=>z("option",{disabled:!t,value:t,selected:(e.fileType||"")===t},t))),s=[""].concat(t.value.filter((e=>!(e["metadata.oui"]&&e["metadata.oui"]!==n||e["metadata.productClass"]&&e["metadata.productClass"]!==r))).map((e=>e._id))).map((t=>z("option",{disabled:!t,value:t,selected:(e.fileName||"")===t},t)));return["Push ",z("select",{onchange:n=>{const r=n.target.value;e.fileName=r,e.fileType="";for(const n of t.value)n._id===r&&(e.fileType=n["metadata.fileType"])},disabled:t.fulfilling,style:"width: 350px"},s)," as ",z("select",{onchange:t=>{e.fileType=t.target.value}},i)]}const $r=()=>({view:e=>{const t=Pr(),n=jr();let r,i;const s=function(e){const t=[];for(const n of e){let e;if(n.actions){const t=Object.entries(n.actions).map((([e,t])=>z("button.primary",{onclick:t},e)));t.length&&(e=z("div",{style:"float: right"},t))}t.push(z("div.notification",{class:n.type,style:"position: absolute;opacity: 0",oncreate:e=>{e.dom.style.opacity="1"},onbeforeremove:e=>(e.dom.style.opacity="0",new Promise((e=>{setTimeout((()=>{e()}),500)}))),key:n.timestamp},z("div",e,n.message)))}return t}(wt),o=function(e){const t=[];for(const n of e){const r=()=>{e.delete(n);for(const e of n.devices){const t=Object.assign({device:e},n);delete t.devices,Cr(t)}},i=()=>{e.delete(n)};let s;"setParameterValues"===n.name?s=Lr(n,r,i):"download"===n.name&&(s=Rr(n));const o=z("button.primary",{title:"Queue task",onclick:r,disabled:Tr.has(n)},"Queue"),a=z("button",{title:"Cancel edit",onclick:i},"Cancel");t.push(z(".staging",s,z("div.actions",o,a)))}return t}(n),a=function(e){const t=[],n={};for(const t of e)n[t.device]=n[t.device]||[],n[t.device].push(t);for(const[e,i]of Object.entries(n)){t.push(z("strong",e));for(const e of i){const n=[];"fault"!==e.status&&"stale"!==e.status||n.push(z("button",{title:"Retry this task",onclick:()=>{Cr(e)}},xr("retry"))),n.push(z("button",{title:"Remove this task",onclick:()=>{Er(e)}},xr("remove"))),"setParameterValues"===e.name?t.push(z("div."+e.status,z("span","Set ",Mr(e.parameterValues[0][0])," to '",(r=e.parameterValues[0][1],z("span.value",{title:r},""+r)),"'"),z(".actions",n))):"refreshObject"===e.name?t.push(z("div."+e.status,z("span","Refresh ",Mr(e.parameterName)),z(".actions",n))):"reboot"===e.name?t.push(z("div."+e.status,"Reboot",z(".actions",n))):"factoryReset"===e.name?t.push(z("div."+e.status,"Factory reset",z(".actions",n))):"addObject"===e.name?t.push(z("div."+e.status,z("span","Add ",Mr(e.objectName)),z(".actions",n))):"deleteObject"===e.name?t.push(z("div."+e.status,z("span","Delete ",Mr(e.objectName)),z(".actions",n))):"getParameterValues"===e.name?t.push(z("div."+e.status,`Refresh ${e.parameterNames.length} parameters`,z(".actions",n))):"download"===e.name?t.push(z("div."+e.status,`Push file: ${e.fileName} (${e.fileType})`,z(".actions",n))):t.push(z("div."+e.status,e.name,z(".actions",n)))}}var r;return t}(t);function l(){let e=10;for(const t of s)t.dom.style.top=""+e,e+=t.dom.offsetHeight+10}function c(){let t=i.dom.offsetTop+i.dom.offsetHeight;if(o.length)for(const e of o)t=Math.max(t,e.dom.offsetTop+e.dom.offsetHeight);else if(e.state.mouseIn)for(const e of r.children)t=Math.max(t,e.dom.offsetTop+e.dom.offsetHeight);r.dom.style.height=t}if(o.length+a.length){const n={queued:0,pending:0,fault:0,stale:0};for(const e of t)n[e.status]+=1;const s=z(".actions",z("button.primary",{title:"Commit queued tasks",disabled:!n.queued,onclick:()=>{Ir(Array.from(Pr()).filter((e=>"queued"===e.status)),((e,t,n,r)=>{if(t)bt("error",`${e}: ${t.message}`);else if("OK"===n){for(const t of r){if("stale"===t.status)return void bt("error",e+": No contact from device");if("fault"===t.status)return void bt("error",e+": Task(s) faulted")}bt("success",e+": Task(s) committed")}else bt("error",`${e}: ${n}`)})).then((()=>{mr(0,Date.now())})).catch((e=>{bt("error",e.message)}))}},"Commit"),z("button",{title:"Clear tasks",onclick:Nr,disabled:!a.length},"Clear"));i=z(".status",z("span.queued",{class:n.queued?"active":""},"Queued: "+n.queued),z("span.pending",{class:n.pending?"active":""},"Pending: "+n.pending),z("span.fault",{class:n.fault?"active":""},"Fault: "+n.fault),z("span.stale",{class:n.stale?"active":""},"Stale: "+n.stale),s),r=z(".drawer",{key:"drawer",style:"opacity: 0;height: 0;",oncreate:t=>{e.state.mouseIn=!1,t.dom.style.opacity="1",c()},onmouseover:t=>{e.state.mouseIn=!0,c(),t.redraw=!1},onmouseleave:t=>{e.state.mouseIn=!1,c(),t.redraw=!1},onupdate:c,onbeforeremove:e=>(e.dom.onmouseover=null,e.dom.onmouseleave=null,e.dom.style.opacity="0",e.dom.style.height="0",new Promise((e=>{setTimeout(e,500)})))},i,o.length?o:z(".queue",a))}return z("div.drawer-wrapper",r,z("div.notifications-wrapper",{key:"notifications",style:"position: relative;",onupdate:l,oncreate:l},s))}}),Br=()=>({view:()=>window.username?z("div.user-menu",window.username,z("button",{onclick:e=>(e.target.disabled=!0,ur({method:"POST",url:"logout"}).then((()=>{location.hash="",location.reload()})).catch((t=>{e.target.disabled=!1,bt("error",t.message)})),!1)},"Log out")):z("div.user-menu",z("a",{href:"#!/login?"+z.buildQueryString({continue:z.route.get()})},"Log in"))}),Ur=()=>({view:e=>{const t={[e.attrs.page]:"active"},n=[];return window.authorizer.hasAccess("presets",1)&&n.push(z("li",{class:t.presets},z("a",{href:"#!/admin/presets"},"Presets"))),window.authorizer.hasAccess("provisions",1)&&n.push(z("li",{class:t.provisions},z("a",{href:"#!/admin/provisions"},"Provisions"))),window.authorizer.hasAccess("virtualParameters",1)&&n.push(z("li",{class:t.virtualParameters},z("a",{href:"#!/admin/virtualParameters"},"Virtual Parameters"))),window.authorizer.hasAccess("files",1)&&n.push(z("li",{class:t.files},z("a",{href:"#!/admin/files"},"Files"))),window.authorizer.hasAccess("config",1)&&n.push(z("li",{class:t.config},z("a",{href:"#!/admin/config"},"Config"))),window.authorizer.hasAccess("permissions",1)&&n.push(z("li",{class:t.permissions},z("a",{href:"#!/admin/permissions"},"Permissions"))),window.authorizer.hasAccess("users",1)&&n.push(z("li",{class:t.users},z("a",{href:"#!/admin/users"},"Users"))),z("nav#side-menu",z("ul",n))}});let Fr=null,qr=null;function Wr(e,t=null){Fr=e,qr=t}function Jr(e,t=!0){return!(e!==Fr||!t&&qr&&!qr()||(Fr=null,qr=null,0))}document.addEventListener("keydown",(e=>{Fr&&"Escape"===e.key&&Jr(Fr,!1)&&z.redraw()})),window.addEventListener("popstate",(()=>{Jr(Fr,!1)&&z.redraw()}));const Vr=["presets","provisions","virtualParameters","files","config","users","permissions"],Hr=()=>({view:e=>{let t,n;if(Vr.includes(e.attrs.page)){n="admin";const r={};r.page=e.attrs.page,t=z(Ur,r)}const r={};return r.page=n||e.attrs.page,[z("#header",[z("img.logo",{src:"logo.svg"}),z(Br),z(I,r),z($r)]),z("#content-wrapper",t,z("#content",{class:"page-"+e.attrs.page},[e.children])),Fr?z(".overlay-wrapper",{tabindex:0,onclick:()=>{Jr(Fr,!1)},style:"opacity: 0",oncreate:e=>{e.dom.focus(),e.dom.style.opacity="1"},onbeforeremove:e=>(e.dom.style.opacity="0",new Promise((e=>{setTimeout((()=>{e()}),500)})))},z(".overlay",{onclick:e=>{e.stopPropagation()}},Fr())):null]}}),Kr=Object.freeze({__proto__:null,init:async function(){return z.request({url:"init"})},component:e=>{let t=e.attrs;const n=new Set;for(const[e,r]of Object.entries(t))r&&n.add(e);return{view:()=>{document.title="Initialization wizard - GenieACS";const e=["users","presets","filters","device","index","overview"].map((e=>(t[e]||n.delete(e),z("input",{type:"checkbox",checked:n.has(e),disabled:!t[e],style:"display: inline; margin-right: 0.5em;",onclick:t=>{t.target.checked?n.add(e):n.delete(e)}}))));return z(".wizard-dialog",[z("h1","Initialization wizard"),z("p","This wizard will seed the database with a minimal initial configuration to serve as a starting point. Select what you want to initialize and click 'ABRACADABRA!'."),z("div",z("label",e[0],"Users, roles and permissions")),z("div",z("label",e[1],"Presets and provisions")),z("div",z("label",e[2],"Devices predefined search filters")),z("div",z("label",e[3],"Device details page")),z("div",z("label",e[4],"Devices listing page")),z("div",z("label",e[5],"Overview page")),z("button.primary",{style:"margin: 10px;",disabled:0===n.size,onclick:e=>{e.target.disabled=!0;const r={};for(const e of n)r[e]=!0;z.request({method:"POST",url:"init",body:r}).then((()=>{setTimeout((()=>{z.request({url:"init"}).then((n=>{e.target.disabled=!1,t=n,bt("success","Initialization complete",{"Open Sesame!":()=>{z.route.set("/login"),window.location.reload()}})})).catch((e=>{bt("error",e.message)}))}),3e3),r.users&&alert("An administrator user has been created for you. Use admin/admin to log in. Don't forget to change the default password.")})).catch((e=>{bt("error",e.message)}))}},"ABRACADABRA!")])}}}}),Gr={year:31104e6,month:2592e6,day:864e5,hour:36e5,minute:6e4,second:1e3},Qr=vt(((e,t,n)=>{let r=n;e=ut(e,null,n,(e=>{if(!Array.isArray(e))return e;for(let n=1;n<e.length;++n)if(Array.isArray(e[n])&&"PARAM"===e[n][0]&&!Array.isArray(e[n][1])){let i=null;const s=t[e[n][1]];s&&s.value&&(i=s.value[0],r=Math.min(r,s.valueTimestamp)),(e=e.slice())[n]=i}return"FUNC"!==e[0]||"DATE_STRING"!==e[1]||Array.isArray(e[2])?e:new Date(e[2]).toLocaleString()}));let i=null,s=null;if(Array.isArray(e)){if("PARAM"===e[0]){const n=t[e[1]];n&&n.value&&(r=n.valueTimestamp,s=n.value[0],i=e[1])}}else s=e;return{value:s,timestamp:r,parameter:i}})),Yr=At.ui.overview.charts,Zr=vt(Xe),Xr=new WeakMap,ei={parameter:()=>({view:e=>{const t=e.attrs.device,{value:n,timestamp:r,parameter:i}=Qr(e.attrs.parameter,e.attrs.device,or);if(null==n)return null;let s;t[i]&&t[i].writable&&(s=ri("button",{title:"Edit parameter value",onclick:()=>{var e;e={name:"setParameterValues",devices:[t["DeviceID.ID"].value[0]],parameterValues:[[i,t[i].value[0],t[i].value[1]]]},Dr.size+e.devices.length>100?bt("error","Too many tasks in queue"):kr.add(e)}},xr("edit")));const o=ri("long-text",{text:""+n});return ri("span",{class:"parameter-value",onmouseover:e=>{if(e.redraw=!1,e.target===o.dom){const t=Date.now(),n=new Date(r).toLocaleString();e.target.title=`${n} (${function(e){let t="",n=2;for(const[r,i]of Object.entries(Gr))if(e>=i){let s;if(n>1?(s=Math.floor(e/i),e-=s*i):s=Math.round(e/i),t+=s>1?`${s} ${r}s `:`${s} ${r} `,!--n)break}return t+"ago"}(t-r)})`}}},o,s)}}),"parameter-list":()=>({view:e=>{const t=e.attrs.device,n=Object.values(e.attrs.parameters).map((e=>{const n=ri.context({device:t,parameter:e.parameter},e.type||"parameter",e);return ri("tr",{onupdate:e=>{e.dom.style.display=n.dom?"":"none"}},ri("th",e.label),ri("td",n))}));return ri("table.parameter-list",n)}}),"parameter-table":()=>({oninit:e=>{const t=e.attrs.parameter;if(!Array.isArray(t)||"PARAM"!==t[0])throw new Error("Object must be a parameter path");e.state.object=t[1],e.state.parameters=Object.values(e.attrs.childParameters)},view:e=>{const t=e.attrs.device,n=Ar(e.state.object,t),r=e.state.parameters;if("string"!=typeof n||!t[n])return null;const i=new Set,s=n+".";for(const e in t)if(e.startsWith(s)){const t=e.indexOf(".",s.length);-1===t?i.add(e):i.add(e.slice(0,t))}const o=Object.values(r).map((e=>ri("th",e.label))),a=ri("thead",ri("tr",o)),l=[];for(const n of i){let i=null==e.attrs.filter||e.attrs.filter;if(i=Qe(i,(e=>Array.isArray(e)&&"PARAM"===e[0]?["PARAM",["||",n,".",e[1]]]:e)),!Ar(i,t))continue;const s=r.map((e=>{const r=Qe(e.parameter,(e=>Array.isArray(e)&&"PARAM"===e[0]?["PARAM",["||",n,".",e[1]]]:e));return ri("td",ri.context({device:t,parameter:r},e.type||"parameter",Object.assign({},e,{device:t,parameter:r,label:null})))}));!0===t[n].writable&&s.push(ri("td",ri("button",{title:"Delete this instance",onclick:()=>{Cr({name:"deleteObject",device:t["DeviceID.ID"].value[0],objectName:n})}},xr("delete-instance")))),l.push(ri("tr",s))}let c;return l.length||l.push(ri("tr.empty",ri("td",{colspan:o.length},"No instances"))),!0===t[n].writable&&l.push(ri("tr",ri("td",{colspan:o.length}),ri("td",ri("button",{title:"Create a new instance",onclick:()=>{Cr({name:"addObject",device:t["DeviceID.ID"].value[0],objectName:n})}},xr("add-instance"))))),e.attrs.label&&(c=ri("h2",e.attrs.label)),[c,ri("table.table",a,ri("tbody",l))]}}),"overview-dot":()=>({view:e=>{const t=e.attrs.device,n=Yr[e.attrs.chart];if(!n)return null;for(const e of Object.values(n.slices))if(Ar(e.filter,t)){const t=ri("svg",{width:"1em",height:"1em",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink"},ri("circle",{cx:"0.5em",cy:"0.5em",r:"0.4em",fill:e.color}));return ri("span.overview-dot",t,""+e.label)}return null}}),container:()=>({view:e=>{if(e.attrs.filter&&!Ar(e.attrs.filter,e.attrs.device))return null;const t=Object.values(e.attrs.components).map((e=>"object"!=typeof e?""+e:ri(e.type,e)));return e.attrs.element?ri(e.attrs.element,t):t}}),"summon-button":()=>({view:e=>{const t=e.attrs.device;return ri("button.primary",{title:"Initiate session and refresh basic parameters",onclick:n=>{n.target.disabled=!0,Ir([{name:"getParameterValues",parameterNames:Object.values(e.attrs.parameters).map((e=>Array.isArray(e)&&"PARAM"===e[0]?Ar(e[1],t):null)).filter((e=>!!e)),device:t["DeviceID.ID"].value[0]}],((e,t,n,r)=>{if(t)bt("error",`${e}: ${t.message}`);else{for(const e of r)"stale"===e.status&&Er(e);"OK"!==n?bt("error",`${e}: ${n}`):"stale"===r[0].status?bt("error",e+": No contact from device"):"fault"===r[0].status?bt("error",e+": Refresh faulted"):bt("success",e+": Summoned")}})).then((()=>{n.target.disabled=!1,mr(0,Date.now())})).catch((e=>{n.target.disabled=!1,bt("error",e.message)}))}},"Summon")}}),"device-faults":()=>({view:e=>{const t=e.attrs.device["DeviceID.ID"].value[0],n=gr("faults",["AND",[">",["PARAM","_id"],t+":"],["<",["PARAM","_id"],t+":zzzz"]]),r=["Channel","Code","Message","Retries","Timestamp"].map((e=>ri("th",e))),i=ri("thead",ri("tr",r)),s=[];for(const e of n.value)s.push([ri("td",e.channel),ri("td",e.code),ri("td",e.message),ri("td",e.retries),ri("td",new Date(e.timestamp).toLocaleString()),ri("td",ri("button",{title:"Delete fault",onclick:t=>{t.redraw=!1,wr("faults",e._id).then((()=>{bt("success","Fault deleted"),mr(Date.now(),Date.now()),ri.redraw()})).catch((e=>{bt("error",e.message),mr(Date.now(),Date.now())}))}},xr("remove")))]);let o;return o=s.length?ri("tbody",s.map((e=>ri("tr",e)))):ri("tbody",ri("tr.empty",ri("td",{colspan:r.length},"No faults"))),ri("table.table",i,o)}}),"all-parameters":()=>({view:e=>{const t=e.attrs.device,n=ri("input",{type:"text",placeholder:"Search parameters",oninput:t=>{e.state.searchString=t.target.value,t.redraw=!1,clearTimeout(e.state.timeout),e.state.timeout=setTimeout(ri.redraw,500)}}),r=/\.[0-9]+$/;let i;if(e.state.searchString){const t=e.state.searchString.split(" ").filter((e=>e));t.length&&(i=new RegExp(t.map((e=>e.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"))).join(".*"),"i"))}const s=[],o=function(e){if(Xr.has(e))return Xr.get(e);const t=[];for(const n of Object.keys(e)){let e=0;for(let t=n.lastIndexOf(".",n.length-2);t>=0;t=n.lastIndexOf(".",t-1))++e;for(;t.length<=e;)t.push([]);t[e].push(n)}return Xr.set(e,t),t}(t);let a=0;for(const e of o){let n=0;for(const r of e){const e=t[r],o=e.value&&e.value[0]?`${r} ${e.value[0]}`:r;i&&!i.test(o)||(++n,a<100&&s.push(r))}a+=n}s.sort();const l=s.map((e=>{const n=t[e],i=[],s={key:e};return!1===n.object?i.push(ri("parameter",Object.assign({device:t,parameter:Zr(e)}))):n.object&&n.writable&&(r.test(e)?i.push(ri("button",{title:"Delete this instance",onclick:()=>{Cr({name:"deleteObject",device:t["DeviceID.ID"].value[0],objectName:e})}},xr("delete-instance"))):i.push(ri("button",{title:"Create a new instance",onclick:()=>{Cr({name:"addObject",device:t["DeviceID.ID"].value[0],objectName:e})}},xr("add-instance")))),i.push(ri("button",{title:"Refresh tree",onclick:()=>{Cr({name:"getParameterValues",device:t["DeviceID.ID"].value[0],parameterNames:[e]})}},xr("refresh"))),ri("tr",s,ri("td.left",ri("long-text",{text:e})),ri("td.right",i))}));return ri(".all-parameters",ri("a.download-csv",{href:`api/devices/${encodeURIComponent(t["DeviceID.ID"].value[0])}.csv`,download:"",style:"float: right;"},"Download"),n,ri(".parameter-list",ri("table",ri("tbody",l)),ri("m",`Displaying ${s.length} out of ${a} parameters.`)))}}),"device-actions":()=>({view:e=>{const t=e.attrs.device,n=[];return n.push(ri("button.primary",{title:"Reboot device",onclick:()=>{Cr({name:"reboot",device:t["DeviceID.ID"].value[0]})}},"Reboot")),n.push(ri("button.critical",{title:"Factory reset device",onclick:()=>{Cr({name:"factoryReset",device:t["DeviceID.ID"].value[0]})}},"Reset")),n.push(ri("button.critical",{title:"Push a firmware or a config file",onclick:()=>{zr({name:"download",devices:[t["DeviceID.ID"].value[0]]})}},"Push file")),n.push(ri("button.primary",{title:"Delete device",onclick:()=>{if(!confirm("Deleting this device. Are you sure?"))return;const e=t["DeviceID.ID"].value[0];wr("devices",e).then((()=>{bt("success",e+": Device deleted"),ri.route.set("/devices")})).catch((e=>{bt("error",e.message)}))}},"Delete")),ri(".actions-bar",n)}}),tags:()=>({view:e=>{const t=e.attrs.device;let n=!0;null!=e.attrs.writable&&(n=e.attrs.writable);const r=[];for(const e of Object.keys(t))e.startsWith("Tags.")&&r.push((i=e.slice(5),decodeURIComponent(i.replace(/0x(?=[0-9A-Z]{2})/g,"%"))));var i;return r.sort(),n?ri(".tags",r.map((e=>ri("span.tag",e,ri("button",{onclick:n=>{n.target.disabled=!0;const r=t["DeviceID.ID"].value[0];_r(r,{[e]:!1}).then((()=>{n.target.disabled=!1,bt("success",r+": Tags updated"),mr(0,Date.now())})).catch((e=>{n.target.disabled=!1,bt("error",`${r}: ${e.message}`)}))}},xr("remove"))))),ri("span.tag.writable",ri.trust("&nbsp;"),ri("button",{onclick:e=>{e.target.disabled=!0;const n=t["DeviceID.ID"].value[0],r=prompt("Enter tag to assign to device:");r?_r(n,{[r]:!0}).then((()=>{e.target.disabled=!1,bt("success",n+": Tags updated"),mr(0,Date.now())})).catch((t=>{e.target.disabled=!1,bt("error",`${n}: ${t.message}`)})):e.target.disabled=!1}},xr("add")))):ri(".tags",r.map((e=>ri("span.tag",e))))}}),ping:e=>{let t,n;const r=()=>{if(!n){const t=e.dom;return void(t&&(t.innerHTML=""))}let r="";(function(e){return ur({url:"api/ping/"+encodeURIComponent(e),background:!0})})(n).then((e=>{r=null!=e.avg?Math.trunc(e.avg)+" ms":"Unreachable"})).catch((()=>{r="Error!",clearInterval(t)})).finally((()=>{const t=e.dom;t&&(t.innerHTML=`Pinging ${n}: ${r}`)}))};return{onremove:()=>{clearInterval(t)},view:e=>{const i=e.attrs.device;let s,o=i["InternetGatewayDevice.ManagementServer.ConnectionRequestURL"];return o||(o=i["Device.ManagementServer.ConnectionRequestURL"]),o&&o.value&&(s=new URL(o.value[0]).hostname),n!==s&&(n=s,clearInterval(t),n&&(r(),t=setInterval(r,3e3))),ri("div",`Pinging ${n}:`)}}},"device-link":()=>({view:e=>{let t;e.attrs.device&&(t=e.attrs.device["DeviceID.ID"].value[0]);const n=Object.values(e.attrs.components).map((t=>{if("object"!=typeof t)return""+t;const n=Object.assign({},e.attrs,t);return ri(n.type,n)}));return t?ri("a",{href:"#!/devices/"+encodeURIComponent(t)},n):n}}),"long-text":()=>({view:e=>{const t=e.attrs.text,n=e.attrs.element||"span";function r(e){e.dom.classList.add("long-text-overflowed"),e.dom.onclick=e=>{Wr((()=>z("textarea.long-text",{value:t,cols:80,rows:24,readonly:"",oncreate:e=>{e.dom.focus(),e.dom.select()}}))),e.stopPropagation(),z.redraw()}}return z(n,{oncreate:e=>{e.dom.clientWidth!==e.dom.scrollWidth&&r(e)},onupdate:e=>{e.dom.clientWidth===e.dom.scrollWidth?(e.dom.classList.remove("long-text-overflowed"),e.dom.onclick=null):r(e)},class:"long-text",title:t},t)}})},ti=new WeakMap,ni=new WeakMap,ri=new Proxy(z,{apply:(e,t,n)=>{const r=n[0];return"string"!=typeof r?n[0]=oi(r):ei[r]&&(n[0]=oi(ei[r])),Reflect.apply(e,void 0,n)},get:(e,t)=>"context"===t?ii:Reflect.get(e,t)});function ii(e,...t){const n=Reflect.apply(ri,void 0,t);return ni.set(n,e),n}function si(e,t){if(Array.isArray(e))for(const n of e)si(n,t);else if(e&&"object"==typeof e&&e.tag){const n=Object.assign({},t,ni.get(e));if("string"!=typeof e.tag&&(ni.set(e,n),e.attrs=Object.assign({},n,e.attrs)),e.children&&e.children.length)for(const t of e.children)si(t,n)}}function oi(e){let t=ti.get(e);if(!t){if("function"!=typeof e){t=Object.assign({},e);const n=e.view;t.view=function(e){const t=ni.get(e)||{},r=Reflect.apply(n,this,[e]);return si(r,t),r}}else{if(e.prototype&&e.prototype.view)throw new Error("Class components not supported");t=t=>{const n=e(t),r=n.view;return n.view=function(e){const t=ni.get(e)||{},n=Reflect.apply(r,this,[e]);return si(n,t),n},n}}ti.set(e,t)}return t}const ai=()=>({view:e=>{const t=e.attrs.onPasswordChange,n=!e.attrs.noAuth,r=e.attrs.username;r&&(e.state.username=r);const i=[ri("p",ri("label",{for:"username"},"Username"),ri("input",{name:"username",type:"text",value:e.state.username,disabled:!!r,oninput:t=>{e.state.username=t.target.value},oncreate:e=>{e.dom.focus()}}))];let s={newPassword:"New password",confirmPassword:"Confirm password"};n&&(s=Object.assign({authPassword:"Your password"},s));for(const[t,n]of Object.entries(s))i.push(ri("p",ri("label",{for:t},n),ri("input",{name:t,type:"password",value:e.state[t],oninput:n=>{e.state[t]=n.target.value}})));const o=ri("button.primary",{type:"submit"},"Change password");i.push(ri(".actions-bar",o));const a=[ri("h1","Change password"),ri("form",{onsubmit:r=>{r.redraw=!1,r.preventDefault(),!e.state.username||!e.state.newPassword||n&&!e.state.authPassword?bt("error","Please fill all fields"):e.state.newPassword!==e.state.confirmPassword?bt("error","Password confirm doesn't match new password"):(o.dom.disabled=!0,Sr(e.state.username,e.state.newPassword,e.state.authPassword).then((()=>{bt("success","Password updated successfully"),t&&t(),o.dom.disabled=!1})).catch((e=>{bt("error",e.message),o.dom.disabled=!1})))}},i)];return ri("div.put-form",a)}}),li=Object.freeze({__proto__:null,init:function(e){return Promise.resolve(e)},component:()=>({view:e=>(window.username&&ri.route.set(e.attrs.continue||"/"),document.title="Login - GenieACS",[ri("h1","Log in"),ri("form",ri("p",ri("label",{for:"username"},"Username"),ri("input",{name:"username",type:"text",value:e.state.username,oncreate:e=>{e.dom.focus()},oninput:t=>{e.state.username=t.target.value}})),ri("p",ri("label",{for:"password"},"Password"),ri("input",{name:"password",type:"password",value:e.state.password,oninput:t=>{e.state.password=t.target.value}})),ri("p",ri("button.primary",{type:"submit",onclick:t=>{var n,r;return t.target.disabled=!0,(n=e.state.username,r=e.state.password,ur({method:"POST",url:"login",background:!0,body:{username:n,password:r}})).then((()=>{location.reload()})).catch((e=>{bt("error",e.response||e.message),t.target.disabled=!1})),!1}},"Login"))),ri("a",{onclick:()=>{const e=()=>{const t={onPasswordChange:()=>{Jr(e),ri.redraw()}};return ri(ai,t)};Wr(e)}},"Change password")])})}),ci=vt(et),ui=()=>({view:e=>function(e){const t=e.slices,n=Array.from(Object.values(e.slices)).reduce(((e,t)=>e+(t.count.value||0)),0),r=[],i=[],s=[];let o,a,l=0,c=100*Math.cos(2*Math.PI*l),u=100*Math.sin(2*Math.PI*l);for(const e of Object.values(t)){const t=n>0?(e.count.value||0)/n:0;if(r.push(ri(".legend-line",[ri("span.color",{style:`background-color: ${e.color} !important;`}),e.label+": ",ri("a",{href:"#!/devices/?"+ri.buildQueryString({filter:ci(e.filter)})},e.count.value||0),` (${(100*t).toFixed(2)}%)`])),t>0){l+=t,o=100*Math.cos(2*Math.PI*l),a=100*Math.sin(2*Math.PI*l);const n=`M ${c} ${u} A 100 100 0 ${t>.5?1:0} 1 ${o} ${a} L 0 0 z`;c=o,u=a,i.push(ri("path",{d:n,fill:e.color}));const r=50*Math.cos(2*Math.PI*(l-t/2)),f=50*Math.sin(2*Math.PI*(l-t/2));s.push(ri("a",{"xlink:href":"#!/devices/?"+ri.buildQueryString({filter:ci(e.filter)})},[ri("path",{d:n,"fill-opacity":0}),ri("text",{x:r,y:f,"dominant-baseline":"middle","text-anchor":"middle"},(100*t).toFixed(2)+"%")]))}}return r.push(ri("span.legend-total","Total: "+n)),ri("div",{class:"pie-chart"},[ri("svg",{viewBox:"-102 -102 204 204",width:"204px",height:"204px",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink"},i.concat(s)),ri(".legend",r)])}(e.attrs.chart)}),fi=At.ui.overview.groups||{},di={};for(const e of Object.values(fi))for(const t of Object.values(e.charts))di[t]=At.ui.overview.charts[t];function hi(e){e=Object.assign({},e);for(let[t,n]of Object.entries(e)){e[t]=n=Object.assign({},n),n.slices=Object.assign({},n.slices);for(let[e,t]of Object.entries(n.slices)){const r=t.filter;n.slices[e]=t=Object.assign({},t),t.count=dr("devices",r)}}return e}const pi=Object.freeze({__proto__:null,init:function(){return window.authorizer.hasAccess("devices",1)?Promise.resolve({charts:hi(di)}):Promise.reject(new Error("You are not authorized to view this page"))},component:()=>({view:e=>{document.title="Overview - GenieACS";const t=[];for(const n of Object.values(fi)){n.label&&t.push(ri("h1",n.label));const r=[];for(const t of Object.values(n.charts)){const n=e.attrs.charts[t],i=[];n.label&&i.push(ri("h2",n.label));const s={};s.chart=n,i.push(ri(ui,s)),r.push(ri(".overview-chart",i))}t.push(ri(".overview-chart-group",r))}return t}})}),gi=()=>{let e=new Set;return{view:t=>{const n=t.attrs.attributes,r=t.attrs.data,i=t.attrs.valueCallback,s=t.attrs.total,o=t.attrs.showMoreCallback,a=t.attrs.sortAttributes,l=t.attrs.onSortChange,c=t.attrs.downloadUrl,u=t.attrs.actionsCallback,f=t.attrs.recordActionsCallback,d=new Set;for(const t of r){const n=t._id||t["DeviceID.ID"].value[0];e.has(n)&&d.add(n)}return e=d,function(e,t,n,r,i,s,o,a,l,c,u){const f=t||[];let d=[];"function"==typeof c?(d=c(i),Array.isArray(d)||(d=[d])):Array.isArray(c)&&(d=c);const h=[];if(d.length){const e=ri("input",{type:"checkbox",checked:f.length&&i.size===f.length,onchange:e=>{for(const t of f){const n=t._id||t["DeviceID.ID"].value[0];e.target.checked?i.add(n):i.delete(n)}},disabled:!n});h.push(ri("th",e))}for(let t=0;t<e.length;t++){const n=e[t].label;if(!s.hasOwnProperty(t)){h.push(ri("th",n));continue}let r=1,i=xr("unsorted");s[t]>0?i=xr("sorted-asc"):s[t]<0&&(i=xr("sorted-dsc"));const a=ri("button",{onclick:()=>(s[t]>0&&(r*=-1),o({[t]:r}))},i);h.push(ri("th",[n,a]))}const p=[];for(const t of f){const n=t._id||t["DeviceID.ID"].value[0],r=[];if(d.length){const e=ri("input",{type:"checkbox",checked:i.has(n),onchange:e=>{e.target.checked?i.add(n):i.delete(n)},onclick:e=>{e.stopPropagation(),e.redraw=!1}});r.push(ri("td",e))}for(const n of e){const e={};let i;if("function"==typeof l)i=l(n,t);else if("code"===n.type){const r=t[n.id].split("\n",11);r.length>10&&(r[10]=[""]),null==e.title&&(e.title=r.join("\n")),i=r[0]||""}else i=t[n.id];r.push(ri("td",e,i))}let s=[];"function"==typeof u?(s=u(t),Array.isArray(s)||(s=[s])):Array.isArray(u)&&(s=u);for(const e of s)r.push(ri("td.table-row-links",e));p.push(ri("tr",{onclick:e=>{["INPUT","BUTTON","A"].includes(e.target.nodeName)?e.redraw=!1:i.delete(n)||i.add(n)}},r))}p.length||p.push(ri("tr.empty",ri("td",{colspan:h.length},"No records")));const g=[];null!=n?g.push(`${f.length}/${n}`):g.push(""+f.length),g.push(ri("button",{title:"Show more records",onclick:r,disabled:!t.length||f.length>=Math.min(200,n)},"More")),a&&g.push(ri("a.download-csv",{href:a,download:""},"Download"));const m=ri("tfoot",ri("tr",ri("td",{colspan:h.length},g))),v=[ri("table.table.highlight",ri("thead",ri("tr",h)),ri("tbody",p),m)];return d.length&&v.push(ri("div.actions-bar",d)),v}(n,r,s,o,e,a,l,c,i,u,f)}}};class mi{constructor(e,t){this.callback=t,this.element=null,this.hideTimeout=null,this.visible=!1,this.default=null,this.selection=null,this.container=document.createElement("div"),this.container.style.position="absolute",this.container.style.display="block",this.container.style.opacity="0",this.container.className=e}attach(e){e.setAttribute("autocomplete","off"),e.addEventListener("focus",(()=>{this.element=e;const t=e.getBoundingClientRect();this.container.style.left=t.left+window.pageXOffset+"px",this.container.style.width=t.width+"px",this.container.style.top=t.bottom+window.pageYOffset+"px",this.update()})),e.addEventListener("blur",(()=>{this.element===e&&this.visible&&this.hide()})),e.addEventListener("keydown",(t=>{this.element===e&&("Escape"===t.key?this.visible&&this.hide():"Enter"===t.key?null!=this.default&&(e.value=this.default,t.preventDefault(),this.update()):"ArrowDown"===t.key?(t.preventDefault(),null==this.selection?this.selection=0:++this.selection,this.update()):"ArrowUp"===t.key&&(t.preventDefault(),--this.selection,this.update()))})),e.addEventListener("input",(()=>{this.element===e&&(this.selection=null,this.update())}))}hide(){this.container.style.opacity="0",this.visible=!1,this.default=null,this.selection=null,clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout((()=>{for(this.hideTimeout=null;this.container.firstChild;)this.container.removeChild(this.container.firstChild);document.body.removeChild(this.container)}),500)}update(){const e=this.element;this.callback(e.value,(t=>{if(this.element!==e)return;if(this.default=null,!t.length)return void(this.visible&&this.hide());for(;this.container.firstChild;)this.container.removeChild(this.container.firstChild);let n;this.visible||(this.hideTimeout?(clearTimeout(this.hideTimeout),this.hideTimeout=null):(document.body.appendChild(this.container),window.getComputedStyle(this.container).opacity),this.container.style.opacity="1",this.visible=!0),null!=this.selection?(this.selection=(this.selection%t.length+t.length)%t.length,this.default=t[this.selection].value):this.default=t[0].value;for(const[r,i]of t.entries()){const t=document.createElement("div");i.tip&&(t.title=i.tip),t.classList.add("suggestion"),r===this.selection&&(t.classList.add("selected"),n=t);const s=document.createTextNode(i.value);t.appendChild(s),t.addEventListener("mousedown",(t=>{t.preventDefault(),e.value=i.value,this.element===e&&this.update()})),this.container.appendChild(t)}n&&(this.container.scrollTop=Math.min(this.container.scrollTop,n.offsetTop),this.container.scrollTop=Math.max(this.container.scrollTop,n.offsetTop+n.scrollHeight-this.container.clientHeight))}))}}const vi={devices:{},faults:{Device:{parameter:["PARAM","device"],type:"string"},Channel:{parameter:["PARAM","channel"],type:"string"},Code:{parameter:["PARAM","code"],type:"string"},Retries:{parameter:["PARAM","retries"],type:"number"},Timestamp:{parameter:["PARAM","timestamp"],type:"timestamp"}},presets:{ID:{parameter:["PARAM","_id"],type:"string"},Channel:{parameter:["PARAM","channel"],type:"string"},Weight:{parameter:["PARAM","weight"],type:"number"}},provisions:{ID:{parameter:["PARAM","_id"],type:"string"}},virtualParameters:{ID:{parameter:["PARAM","_id"],type:"string"}},files:{ID:{parameter:["PARAM","_id"],type:"string"},Type:{parameter:["PARAM","metadata.fileType"],type:"string"},OUI:{parameter:["PARAM","metadata.oui"],type:"string"},"Product class":{parameter:["PARAM","metadata.productClass"],type:"string"},Version:{parameter:["PARAM","metadata.version"],type:"string"}},permissions:{Role:{parameter:["PARAM","role"],type:"string"},Resource:{parameter:["PARAM","resource"],type:"string"},Access:{parameter:["PARAM","access"],type:"number"}},users:{Username:{parameter:["PARAM","_id"],type:"string"}}};for(const e of Object.values(At.ui.filters))vi.devices[e.label]={parameter:e.parameter,type:(e.type||"").split(",").map((e=>e.trim()))};function _i(e,t){let n;if(vi[e]&&vi[e][t]){const r=vi[e][t],i="devices"===e?r.type:r.type.split(","),s=[];for(const e of i)switch(e.trim()){case"string":s.push("case insensitive string pattern");break;case"number":s.push("numeric value");break;case"timestamp":s.push("Unix timestamp or string in the form YYYY-MM-DDTHH:mm:ss.sssZ");break;case"mac":s.push("partial case insensitive MAC address");break;case"tag":s.push("case sensitive string")}s.length&&(n=`${t}: ${s.join(", ")}`)}return n}function wi(e,t,n){if(!vi[e])return null;const r=vi[e][t].type;n=n.trim();const i=["OR"];if(0===r.length||r.includes("number")){const r=function(e,t){let n="=";for(const e of["<>","=","<=","<",">=",">"])if(t.startsWith(e)){n=e,t=t.slice(e.length).trim();break}const r=parseInt(t);return r!==+t?null:[n,e,r]}(vi[e][t].parameter,n);r&&i.push(r)}if(0===r.length||r.includes("string")){const r=function(e,t){return["LIKE",["FUNC","LOWER",e],t.toLowerCase()]}(vi[e][t].parameter,n);r&&i.push(r)}if(0===r.length||r.includes("timestamp")){const r=function(e,t){let n="=";for(const e of["<>","=","<=","<",">=",">"])if(t.startsWith(e)){n=e,t=t.slice(e.length).trim();break}let r=parseInt(t);return r!==+t&&(r=Date.parse(t)),isNaN(r)?null:[n,e,r]}(vi[e][t].parameter,n);r&&i.push(r)}if(r.includes("mac")){const r=function(e,t){return(t=t.replace(/[^a-f0-9]/gi,"").toLowerCase())?12===t.length?["LIKE",["FUNC","LOWER",e],t.replace(/(..)(?!$)/g,"$1:")]:["OR",["LIKE",["FUNC","LOWER",e],`%${t.replace(/(..)(?!$)/g,"$1:")}%`],["LIKE",["FUNC","LOWER",e],`%${t.replace(/(.)(.)/g,"$1:$2")}%`]]:null}(vi[e][t].parameter,n);r&&i.push(r)}if(r.includes("tag")){const e=["IS NOT NULL",["PARAM","Tags."+function(e){return encodeURIComponent(e).replace(/[!~*'()]/g,(e=>"%"+e.charCodeAt(0).toString(16).toUpperCase())).replace(/0x(?=[0-9A-Z]{2})/g,"0%78").replace(/%/g,"0x")}(n)]];e&&i.push(e)}return i.length<=1?null:2===i.length?i[1]:i}const bi=Array.isArray,yi=vt((e=>{const t=function(e){return vi[e]?Object.keys(vi[e]):[]}(e);return new mi("autocomplete",((n,r)=>{n=n.toLowerCase(),r(t.filter((e=>e.toLowerCase().includes(n))).map((t=>({value:t+": ",tip:_i(e,t)}))))}))}));function Ai(e){return Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?`${e[2]}: ${e[3]}`:et(e)}const Si=vt((e=>{if(!e)return[""];const t=[],n=Xe(e);if(Array.isArray(n)&&"AND"===n[0])for(const e of n.slice(1))t.push(Ai(e));else t.push(Ai(n));return t.push(""),t})),xi=()=>({view:e=>{function t(){e.state.filterInvalid=0,e.state.filterList=e.state.filterList.filter((e=>e));let t=e.state.filterList.map(((t,n)=>{try{return function(e,t){let n;if(/^[\s0-9a-zA-Z]+:/.test(t)){const e=t.split(":",1)[0],r=t.slice(e.length+1).trim();n=["FUNC","Q",e.trim(),r]}else n=Xe(t);return r=Vn(r=Qe(n,(t=>{if(Array.isArray(t)&&"FUNC"===t[0]){if("Q"===t[1])return wi(e,t[2],t[3]);if("NOW"===t[1])return Date.now()}return t}))),Array.isArray(r)&&"CASE"===r[0]&&(r=["AND",...r.slice(1)]),function(e){if(!bi(e)){if(!0===e)return{};throw new Error("Primitives are not valid queries")}!function e(t,n){const r=t[0];if("AND"===r&&2===(t=t.filter((e=>!0!==e))).length)return e(t[1],n);if("OR"===r&&2===(t=t.filter((e=>!1!==e))).length)return e(t[1],n);if(!n&&"AND"===r||n&&"OR"===r)return{$and:t.slice(1).map((t=>e(t,n)))};if(!n&&"OR"===r||n&&"AND"===r)return{$or:t.slice(1).map((t=>e(t,n)))};if("NOT"===r)return e(t[1],!n);if(bi(t[2]))throw new Error(`Invalid RHS operand of ${r} clause`);if("LIKE"===r||"NOT LIKE"===r){let e,i;if("NOT LIKE"===r&&(n=!n),!Array.isArray(t[1]))throw new Error(`Invalid LHS operand of ${r} clause`);if("FUNC"===t[1][0]&&"UPPER"===t[1][1]){if(t[2]!==t[2].toUpperCase())throw new Error(`Invalid RHS operand of ${r} clause`);e=t[1][2][1],i="i"}else if("FUNC"===t[1][0]&&"LOWER"===t[1][1]){if(t[2]!==t[2].toLowerCase())throw new Error(`Invalid RHS operand of ${r} clause`);e=t[1][2][1],i="i"}else{if("PARAM"!==t[1][0])throw new Error(`Invalid LHS operand of ${r} clause`);e=t[1][1],i=""}const s=st(t[2],t[3],i);return n?{[e]:{$nin:[s,null]}}:{[e]:s}}if("_tags"===r){let e=t[2];return n&&(e=!e),e?{_tags:t[1]}:{_tags:{$ne:t[1]}}}if(!bi(t[1])||"PARAM"!==t[1][0])throw new Error(`Invalid LHS operand of ${r} clause`);if("IS NULL"===r)return{[t[1][1]]:null};if("IS NOT NULL"===r)return{[t[1][1]]:{$ne:null}};if(bi(t[2])||null==t[2])throw new Error(`Invalid RHS operand of ${r} clause`);if("="===r){const e=t[1][1],r=t[2];return n?{[e]:{$nin:[r,null]}}:{[e]:r}}if("<>"===r){const e=t[1][1],r=t[2];return n?{[e]:r}:{[e]:{$nin:[r,null]}}}if(">"===r){const e=t[1][1],r=t[2];return n?{[e]:{$lte:r}}:{[e]:{$gt:r}}}if(">="===r){const e=t[1][1],r=t[2];return n?{[e]:{$lt:r}}:{[e]:{$gte:r}}}if("<"===r){const e=t[1][1],r=t[2];return n?{[e]:{$gte:r}}:{[e]:{$lt:r}}}if("<="===r){const e=t[1][1],r=t[2];return n?{[e]:{$gt:r}}:{[e]:{$lte:r}}}throw new Error("Unrecognized operator "+r)}(e,!1)}(r),n;var r}(e.attrs.resource,t)}catch(t){e.state.filterInvalid|=1<<n}return null}));e.state.filterList.push(""),e.state.filterInvalid||(delete e.state.filter,0===t.length?e.attrs.onChange(""):(t=t.length>1?["AND"].concat(t):t[0],e.attrs.onChange(et(t))))}return e.state.filterList&&e.attrs.filter===e.state.filter||(e.state.filterInvalid=0,e.state.filter=e.attrs.filter,e.state.filterList=Si(e.attrs.filter)),z("div.filter",[z("b","Filter")].concat(e.state.filterList.map(((n,r)=>z("input",{type:"text",class:e.state.filterInvalid>>r&1?"error":"",value:n,onchange:n=>{e.state.filterList=e.state.filterList.slice(),e.state.filterList[r]=n.target.value.trim(),t()},oncreate:t=>{yi(e.attrs.resource).attach(t.dom)}})))))}}),Di=At.ui.pageSize||10,ki=vt(Xe),Oi=vt(JSON.parse),Ci=vt((e=>{const t=function(e){const t=new Set;return Qe(e,(e=>(tt(e)&&"PARAM"===e[0]&&t.add(e[1]),e))),Array.from(t)}(e);if(1===t.length){const e=ut(t[0]);if("string"==typeof e)return e}return null})),Ei=vt(((e,t)=>{const n={};for(const e of t)n[e.label]=et(e.parameter);return"api/devices.csv?"+ri.buildQueryString({filter:et(e),columns:JSON.stringify(n)})})),Pi=vt((e=>Qe(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wi("devices",e[2],e[3]):e))));function Ni(e){const t=[];return t.push(ri("button.primary",{title:"Reboot selected devices",disabled:!e.size,onclick:()=>{Cr(...[...e].map((e=>({name:"reboot",device:e}))))}},"Reboot")),t.push(ri("button.critical",{title:"Factory reset selected devices",disabled:!e.size,onclick:()=>{Cr(...[...e].map((e=>({name:"factoryReset",device:e}))))}},"Reset")),t.push(ri("button.critical",{title:"Push a firmware or a config file",disabled:!e.size,onclick:()=>{zr({name:"download",devices:[...e]})}},"Push file")),t.push(ri("button.primary",{title:"Delete selected devices",disabled:!e.size,onclick:()=>{const t=Array.from(e);if(!confirm(`Deleting ${t.length} devices. Are you sure?`))return;let n=1;for(const e of t)++n,wr("devices",e).then((()=>{bt("success",e+": Deleted"),0==--n&&mr(0,Date.now())})).catch((t=>{bt("error",`${e}: ${t.message}`),0==--n&&mr(0,Date.now())}));0==--n&&mr(0,Date.now())}},"Delete")),t.push(ri("button.primary",{title:"Tag selected devices",disabled:!e.size,onclick:()=>{const t=Array.from(e),n=prompt(`Enter tag to assign to ${t.length} devices:`);if(!n)return;let r=1;for(const e of t)++r,_r(e,{[n]:!0}).then((()=>{bt("success",e+": Tags updated"),0==--r&&mr(0,Date.now())})).catch((t=>{bt("error",`${e}: ${t.message}`),0==--r&&mr(0,Date.now())}));0==--r&&mr(0,Date.now())}},"Tag")),t.push(ri("button.primary",{title:"Untag selected devices",disabled:!e.size,onclick:()=>{const t=Array.from(e),n=prompt(`Enter tag to unassign from ${t.length} devices:`);if(!n)return;let r=1;for(const e of t)++r,_r(e,{[n]:!1}).then((()=>{bt("success",e+": Tags updated"),0==--r&&mr(0,Date.now())})).catch((t=>{bt("error",`${e}: ${t.message}`),0==--r&&mr(0,Date.now())}));0==--r&&mr(0,Date.now())}},"Untag")),t}const ji=Object.freeze({__proto__:null,init:function(e){return new Promise(((t,n)=>{if(!window.authorizer.hasAccess("devices",2))return void n(new Error("You are not authorized to view this page"));const r=e.hasOwnProperty("filter")?""+e.filter:"",i=e.hasOwnProperty("sort")?""+e.sort:"",s=Object.values(At.ui.index);s.length||s.push({label:"ID",parameter:["PARAM","DeviceID.ID"]}),t({filter:r,indexParameters:s,sort:i})}))},component:()=>({view:e=>{document.title="Devices - GenieACS";const t=e.attrs.indexParameters,n=e.attrs.sort?Oi(e.attrs.sort):{},r={};for(let e=0;e<t.length;e++){const i=t[e];if(i.unsortable)continue;const s=Ci(i.parameter);s&&(r[e]=n[s]||0)}let i=!e.attrs.filter||ki(e.attrs.filter);i=Pi(i);const s=gr("devices",i,{limit:e.state.showCount||Di,sort:n}),o=dr("devices",i),a=Ei(i,t),l={};l.attributes=t,l.data=s.value,l.total=o.value,l.showMoreCallback=function(){e.state.showCount=(e.state.showCount||Di)+Di,ri.redraw()},l.sortAttributes=r,l.onSortChange=function(r){const i=Object.assign({},n);for(const[e,n]of Object.entries(r)){const r=Ci(t[e].parameter);r&&(delete i[r],i[r]=n)}const s={sort:JSON.stringify(i)};e.attrs.filter&&(s.filter=e.attrs.filter),ri.route.set("/devices",s)},l.downloadUrl=a,l.valueCallback=(e,t)=>ri.context({device:t,parameter:e.parameter},e.type||"parameter",e),l.recordActionsCallback=e=>ri("a",{href:"#!/devices/"+encodeURIComponent(e["DeviceID.ID"].value[0])},"Show"),window.authorizer.hasAccess("devices",3)&&(l.actionsCallback=Ni);const c={resource:"devices"};return c.filter=e.attrs.filter,c.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),ri.route.set("/devices",n)},[ri("h1","Listing devices"),ri(xi,c),ri(gi,l)]}})}),zi=Object.freeze({__proto__:null,init:function(e){return window.authorizer.hasAccess("devices",2)?Promise.resolve({deviceId:e.id,deviceFilter:["=",["PARAM","DeviceID.ID"],e.id]}):Promise.reject(new Error("You are not authorized to view this page"))},component:()=>({view:e=>{document.title=e.attrs.deviceId+" - Devices - GenieACS";const t=gr("devices",e.attrs.deviceFilter).value;if(!t.length)return"Loading";const n=At.ui.device,r=[];for(const e of Object.values(n))r.push(ri.context({device:t[0]},e.type,e));return[ri("h1",e.attrs.deviceId),r]}})}),Ii=()=>({view:function(e){return document.title="Error! - GenieACS",ri("p.error",e.attrs.error)}});let Ti,Mi,Li;function Ri(){Li||(Li=bt("error","Error loading JS resource, please reload the page",{Reload:()=>{window.location.reload()}}))}function $i(){return Ti?Promise.resolve():new Promise(((e,t)=>{const n=[i.e(528).then(i.t.bind(i,710,7)),i.e(528).then(i.t.bind(i,457,7)),i.e(528).then(i.t.bind(i,926,7))];Promise.all(n).then((t=>{Ti=t[0].default,e()})).catch((e=>{Ri(),t(e)}))}))}function Bi(){return Mi?Promise.resolve():new Promise(((e,t)=>{i.e(35).then(i.t.bind(i,242,7)).then((t=>{Mi=t,e()})).catch((e=>{Ri(),t(e)}))}))}const Ui=At.ui.pageSize||10,Fi=vt(Xe),qi=vt(JSON.parse),Wi=[{id:"device",label:"Device"},{id:"channel",label:"Channel"},{id:"code",label:"Code"},{id:"message",label:"Message"},{id:"detail",label:"Detail"},{id:"retries",label:"Retries"},{id:"timestamp",label:"Timestamp"}],Ji=vt((e=>{const t={};for(const e of Wi)t[e.label]="timestamp"===e.id?`DATE_STRING(${e.id})`:e.id;return"api/faults.csv?"+ri.buildQueryString({filter:et(e),columns:JSON.stringify(t)})})),Vi=vt((e=>Qe(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wi("faults",e[2],e[3]):e)))),Hi=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("faults",2))return Promise.reject(new Error("You are not authorized to view this page"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return new Promise(((e,r)=>{Bi().then((()=>{e({filter:n,sort:t})})).catch(r)}))},component:()=>({view:e=>{document.title="Faults - GenieACS";const t=e.attrs.sort?qi(e.attrs.sort):{},n={};for(let e=0;e<Wi.length;e++){const r=Wi[e];"detail"!==r.id&&(n[e]=t[r.id]||0)}let r=!e.attrs.filter||Fi(e.attrs.filter);r=Vi(r);const i=gr("faults",r,{limit:e.state.showCount||Ui,sort:t}),s=dr("faults",r),o=Ji(r),a={};a.attributes=Wi,a.data=i.value,a.valueCallback=(e,t)=>{if("device"===e.id){const e="#!/devices/"+encodeURIComponent(t.device);return ri("a",{href:e},t.device)}return"detail"===e.id?ri("long-text",{text:Mi.stringify(t.detail)}):"timestamp"===e.id?new Date(t.timestamp).toLocaleString():t[e.id]},a.total=s.value,a.showMoreCallback=function(){e.state.showCount=(e.state.showCount||Ui)+Ui,ri.redraw()},a.sortAttributes=n,a.onSortChange=function(n){const r=Object.assign({},t);for(const[e,t]of Object.entries(n))delete r[Wi[e].id],r[Wi[e].id]=t;const i={sort:JSON.stringify(r)};e.attrs.filter&&(i.filter=e.attrs.filter),ri.route.set("/faults",i)},a.downloadUrl=o,window.authorizer.hasAccess("faults",3)&&(a.actionsCallback=e=>ri("button.primary",{disabled:0===e.size,title:"Delete selected faults",onclick:t=>{t.redraw=!1,t.target.disabled=!0,confirm(`Deleting ${e.size} faults. Are you sure?`)&&Promise.all(Array.from(e).map((e=>wr("faults",e)))).then((e=>{bt("success",e.length+" faults deleted"),mr(0,Date.now())})).catch((e=>{bt("error",e.message),mr(0,Date.now())}))}},"Delete"));const l={resource:"faults"};return l.filter=e.attrs.filter,l.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),ri.route.set("/faults",n)},[ri("h1","Listing faults"),ri(xi,l),ri(gi,a)]}})}),Ki=()=>({view:e=>ri("textarea",{name:e.attrs.id,value:e.attrs.value,oncreate:t=>{const n=Ti.fromTextArea(t.dom,{mode:e.attrs.mode,lineNumbers:!0,readOnly:e.attrs.readOnly,extraKeys:{"Ctrl-Enter":()=>{e.attrs.onSubmit&&e.attrs.onSubmit(t.dom)},"Cmd-Enter":()=>{e.attrs.onSubmit&&e.attrs.onSubmit(t.dom)}}});e.attrs.onChange&&n.on("change",(t=>{e.attrs.onChange(t.getValue())})),e.attrs.focus&&n.focus(),e.attrs.onReady&&e.attrs.onReady(n)}})}),Gi={presets:"preset",provisions:"provision",virtualParameters:"virtual parameter",files:"file",users:"user",permissions:"permission"};function Qi(e,t,n){if("combo"===t.type){let r="",i=t.options;null!=e.object[t.id]&&(i.includes(e.object[t.id])||(i=i.concat([e.object[t.id]])),r=e.object[t.id]);const s=[ri("option",{value:""},"")];for(const e of i)s.push(ri("option",{value:e},e));return ri("select",{name:t.id,value:r,oncreate:n?e=>{e.dom.focus()}:null,onchange:n=>{e.object[t.id]=n.target.value,e.modified=!0,n.redraw=!1}},s)}if("multi"===t.type){const r=Array.from(new Set(t.options.concat(e.object[t.id]||[]))),i=new Set(e.object[t.id]),s=r.map((r=>{const o=`${t.id}-${r}`;return ri("tr",[ri("td",ri("input",{type:"checkbox",id:o,value:r,oncreate:e=>{n&&!s.length&&e.dom.focus(),i.has(r)&&(e.dom.checked=!0)},onchange:n=>{n.target.checked?i.add(r):i.delete(r),e.object[t.id]=Array.from(i),e.modified=!0,n.redraw=!1}})),ri("td",r)])}));return ri("table",s)}if("code"===t.type){const n={id:t.id,value:e.object[t.id],mode:"javascript",onSubmit:e=>{e.form.querySelector("button[type=submit]").click()},onChange:n=>{e.object[t.id]=n,e.modified=!0}};return ri(Ki,n)}return"file"===t.type?ri("input",{type:"file",name:t.id,oncreate:n?e=>{e.dom.focus()}:null,onchange:n=>{e.object[t.id]=n.target.files,e.modified=!0,n.redraw=!1}}):"textarea"===t.type?ri("textarea",{name:t.id,value:e.object[t.id],readonly:"_id"===t.id&&!e.isNew,cols:t.cols||80,rows:t.rows||4,style:"resize: none;",oncreate:n?e=>{const t=e.dom;t.focus(),t.setSelectionRange(t.value.length,t.value.length)}:null,oninput:n=>{e.object[t.id]=n.target.value,e.modified=!0,n.redraw=!1},onkeypress:e=>(e.redraw=!1,!(13===e.which&&!e.shiftKey)||(e.target.form.querySelector("button[type=submit]").click(),!1))}):ri("input",{type:"password"===t.type?"password":"text",name:t.id,disabled:"_id"===t.id&&!e.isNew,value:e.object[t.id],oncreate:n?e=>{e.dom.focus()}:null,oninput:n=>{e.object[t.id]=n.target.value,e.modified=!0,n.redraw=!1}})}const Yi=()=>({view:e=>{const t=e.attrs.actionHandler,n=e.attrs.attributes,r=e.attrs.resource,i=e.attrs.base||{};e.state.current||(e.state.current={isNew:!i._id,object:Object.assign({},i),modified:!1});const s=e.state.current,o=[];let a=!1;for(const e of n){let t=!1;a||!s.isNew&&"_id"===e.id||(t=a=!0),o.push(ri("p",ri("label",{for:e.id},e.label||e.id),ri("br"),Qi(s,e,t)))}const l=ri("button.primary",{type:"submit"},"Save"),c=[l];s.isNew||c.push(ri("button.primary",{type:"button",title:"Delete "+(Gi[r]||r),onclick:e=>{e.redraw=!1,e.target.disabled=!0,t("delete",s.object).then((()=>{e.target.disabled=!1}))}},"Delete")),o.push(ri(".actions-bar",c));const u=[ri("h1",`${s.isNew?"New":"Editing"} ${Gi[r]||r}`),ri("form",{onsubmit:e=>{e.redraw=!1,e.preventDefault(),l.dom.disabled=!0,t("save",s.object).then((()=>{l.dom.disabled=!1}))}},o)];return ri("div.put-form",u)}}),Zi=At.ui.pageSize||10,Xi=vt(Xe),es=vt(JSON.parse),ts=[{id:"_id",label:"Name"},{id:"channel",label:"Channel"},{id:"weight",label:"Weight"},{id:"schedule",label:"Schedule"},{id:"events",label:"Events"},{id:"precondition",label:"Precondition",type:"textarea"},{id:"provision",label:"Provision",type:"combo"},{id:"provisionArgs",label:"Arguments",type:"textarea"}],ns=vt((e=>Qe(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wi("presets",e[2],e[3]):e))));function rs(e,t,n){return new Promise(((r,i)=>{const s=Object.assign({},t);if("save"===e){const e=s._id;delete s._id;const t={};if(e||(t._id="ID can not be empty"),s.provision||(t.provision="Provision not selected"),Object.keys(t).length)return void r(t);if(s.precondition)try{s.precondition=et(Xi(s.precondition))}catch(e){return void r({precondition:"Precondition must be valid expression"})}yr("presets",e).then((t=>t&&n?(mr(0,Date.now()),void r({_id:"Preset already exists"})):t||n?void br("presets",e,s).then((()=>{bt("success","Preset "+(t?"updated":"created")),mr(0,Date.now()),r()})).catch(i):(mr(0,Date.now()),void r({_id:"Preset does not exist"})))).catch(i)}else"delete"===e?wr("presets",s._id).then((()=>{bt("success","Preset deleted"),mr(0,Date.now()),r()})).catch((e=>{i(e),mr(0,Date.now())})):i(new Error("Undefined action"))}))}const is={resource:"presets",attributes:ts},ss=vt((e=>{const t={};for(const e of ts)t[e.label]=e.id;return"api/presets.csv?"+ri.buildQueryString({filter:et(e),columns:JSON.stringify(t)})})),os=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("presets",2))return Promise.reject(new Error("You are not authorized to view this page"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return Promise.resolve({filter:n,sort:t})},component:()=>({view:e=>{document.title="Presets - GenieACS";const t=e.attrs.sort?es(e.attrs.sort):{},n={};for(let e=0;e<ts.length;e++){const r=ts[e];"events"!==r.id&&"precondition"!==r.id&&"provision"!==r.id&&"provisionArgs"!==r.id&&(n[e]=t[r.id]||0)}let r=!e.attrs.filter||Xi(e.attrs.filter);r=ns(r);const i=gr("presets",r,{limit:e.state.showCount||Zi,sort:t}),s=dr("presets",r),o=new Set,a=new Set(["refresh","value","tag","reboot","reset","download","instances"]),l=gr("provisions",!0);if(l.fulfilled)for(const e of l.value)o.add(e._id),a.add(e._id);ts.find((e=>"provision"===e.id)).options=Array.from(a);const c=ss(r),u={};u.attributes=ts,u.data=i.value,u.total=s.value,u.showMoreCallback=function(){e.state.showCount=(e.state.showCount||Zi)+Zi,ri.redraw()},u.sortAttributes=n,u.onSortChange=function(n){const r=Object.assign({},t);for(const[e,t]of Object.entries(n))delete r[ts[e].id],r[ts[e].id]=t;const i={sort:JSON.stringify(r)};e.attrs.filter&&(i.filter=e.attrs.filter),ri.route.set("/admin/presets",i)},u.downloadUrl=c,u.valueCallback=(e,t)=>{if("precondition"===e.id){let e="#!/devices";return t.precondition.length&&(e+="?"+ri.buildQueryString({filter:t.precondition})),ri("a",{href:e,title:t.precondition},t.precondition)}return"provision"===e.id&&o.has(t[e.id])?ri("a",{href:"#!/admin/provisions?"+ri.buildQueryString({filter:`Q("ID", "${t.provision}")`})},t.provision):t[e.id]},u.recordActionsCallback=e=>[ri("a",{onclick:()=>{let t=null;const n=ri(Yi,Object.assign({base:e,actionHandler:(e,n)=>new Promise((r=>{rs(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)bt("error",e);else Jr(t);r()})).catch((e=>{bt("error",e.message),r()}))}))},is));t=()=>e.provision?n:ri("div",{style:"margin:20px"},"This UI only supports presets with a single 'provision' configuraiton. If this preset was originally created from the old UI (genieacs-gui), you must edit it there."),Wr(t,(()=>!n.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"Show")],window.authorizer.hasAccess("presets",3)&&(u.actionsCallback=e=>[ri("button.primary",{title:"Create new preset",onclick:()=>{let e=null;const t=ri(Yi,Object.assign({actionHandler:(t,n)=>new Promise((r=>{rs(t,n,!0).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)bt("error",e);else Jr(e);r()})).catch((e=>{bt("error",e.message),r()}))}))},is));e=()=>t,Wr(e,(()=>!t.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"New"),ri("button.primary",{title:"Delete selected presets",disabled:!e.size,onclick:t=>{confirm(`Deleting ${e.size} presets. Are you sure?`)&&(t.redraw=!1,t.target.disabled=!0,Promise.all(Array.from(e).map((e=>wr("presets",e)))).then((e=>{bt("success",e.length+" presets deleted"),mr(0,Date.now())})).catch((e=>{bt("error",e.message),mr(0,Date.now())})))}},"Delete")]);const f={resource:"presets"};return f.filter=e.attrs.filter,f.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),ri.route.set("/admin/presets",n)},[ri("h1","Listing presets"),ri(xi,f),ri(gi,u)]}})}),as=At.ui.pageSize||10,ls=vt(Xe),cs=vt(JSON.parse),us=[{id:"_id",label:"Name"},{id:"script",label:"Script",type:"code"}],fs=vt((e=>Qe(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wi("provisions",e[2],e[3]):e))));function ds(e,t,n){return new Promise(((r,i)=>{const s=Object.assign({},t);if("save"===e){const e=s._id;if(delete s._id,!e)return void r({_id:"ID can not be empty"});yr("provisions",e).then((t=>t&&n?(mr(0,Date.now()),void r({_id:"Provision already exists"})):t||n?void br("provisions",e,s).then((()=>{bt("success","Provision "+(t?"updated":"created")),mr(0,Date.now()),r()})).catch(i):(mr(0,Date.now()),void r({_id:"Provision does not exist"})))).catch(i)}else"delete"===e?wr("provisions",s._id).then((()=>{bt("success","Provision deleted"),mr(0,Date.now()),r()})).catch((e=>{mr(0,Date.now()),i(e)})):i(new Error("Undefined action"))}))}const hs={resource:"provisions",attributes:us},ps=vt((e=>{const t={};for(const e of us)t[e.label]=e.id;return"api/provisions.csv?"+ri.buildQueryString({filter:et(e),columns:JSON.stringify(t)})})),gs=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("provisions",2))return Promise.reject(new Error("You are not authorized to view this page"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return new Promise(((e,r)=>{$i().then((()=>{e({filter:n,sort:t})})).catch(r)}))},component:()=>({view:e=>{document.title="Provisions - GenieACS";const t=e.attrs.sort?cs(e.attrs.sort):{},n={};for(let e=0;e<us.length;e++)n[e]=t[us[e].id]||0;let r=!e.attrs.filter||ls(e.attrs.filter);r=fs(r);const i=gr("provisions",r,{limit:e.state.showCount||as,sort:t}),s=dr("provisions",r),o=ps(r),a={};a.attributes=us,a.data=i.value,a.total=s.value,a.showMoreCallback=function(){e.state.showCount=(e.state.showCount||as)+as,ri.redraw()},a.sortAttributes=n,a.onSortChange=function(n){const r=Object.assign({},t);for(const[e,t]of Object.entries(n))delete r[us[e].id],r[us[e].id]=t;const i={sort:JSON.stringify(r)};e.attrs.filter&&(i.filter=e.attrs.filter),ri.route.set("/admin/provisions",i)},a.downloadUrl=o,a.recordActionsCallback=e=>[ri("a",{onclick:()=>{let t=null;const n=ri(Yi,Object.assign({base:e,actionHandler:(e,n)=>new Promise((r=>{ds(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)bt("error",e);else Jr(t);r()})).catch((e=>{bt("error",e.message),r()}))}))},hs));t=()=>n,Wr(t,(()=>!n.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"Show")],window.authorizer.hasAccess("provisions",3)&&(a.actionsCallback=e=>[ri("button.primary",{title:"Create new provision",onclick:()=>{let e=null;const t=ri(Yi,Object.assign({actionHandler:(t,n)=>new Promise((r=>{ds(t,n,!0).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)bt("error",e);else Jr(e);r()})).catch((e=>{bt("error",e.message),r()}))}))},hs));e=()=>t,Wr(e,(()=>!t.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"New"),ri("button.primary",{title:"Delete selected provisions",disabled:!e.size,onclick:t=>{confirm(`Deleting ${e.size} provisions. Are you sure?`)&&(t.redraw=!1,t.target.disabled=!0,Promise.all(Array.from(e).map((e=>wr("provisions",e)))).then((e=>{bt("success",e.length+" provisions deleted"),mr(0,Date.now())})).catch((e=>{bt("error",e.message),mr(0,Date.now())})))}},"Delete")]);const l={resource:"provisions"};return l.filter=e.attrs.filter,l.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),ri.route.set("/admin/provisions",n)},[ri("h1","Listing provisions"),ri(xi,l),ri(gi,a)]}})}),ms=At.ui.pageSize||10,vs=vt(Xe),_s=vt(JSON.parse),ws=[{id:"_id",label:"Name"},{id:"script",label:"Script",type:"code"}],bs=vt((e=>Qe(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wi("virtualParameters",e[2],e[3]):e))));function ys(e,t,n){return new Promise(((r,i)=>{const s=Object.assign({},t);if("save"===e){const e=s._id;if(delete s._id,!e)return void r({_id:"ID can not be empty"});yr("virtualParameters",e).then((t=>t&&n?(mr(0,Date.now()),void r({_id:"Virtual parameter already exists"})):t||n?void br("virtualParameters",e,s).then((()=>{bt("success","Virtual parameter "+(t?"updated":"created")),mr(0,Date.now()),r()})).catch(i):(mr(0,Date.now()),void r({_id:"Virtual parameter does not exist"})))).catch(i)}else"delete"===e?wr("virtualParameters",s._id).then((()=>{bt("success","Virtual parameter deleted"),mr(0,Date.now()),r()})).catch((e=>{mr(0,Date.now()),i(e)})):i(new Error("Undefined action"))}))}const As={resource:"virtualParameters",attributes:ws},Ss=vt((e=>{const t={};for(const e of ws)t[e.label]=e.id;return"api/virtualParameters.csv?"+ri.buildQueryString({filter:et(e),columns:JSON.stringify(t)})})),xs=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("virtualParameters",2))return Promise.reject(new Error("You are not authorized to view this page"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return new Promise(((e,r)=>{$i().then((()=>{e({filter:n,sort:t})})).catch(r)}))},component:()=>({view:e=>{document.title="Virtual Parameters - GenieACS";const t=e.attrs.sort?_s(e.attrs.sort):{},n={};for(let e=0;e<ws.length;e++)n[e]=t[ws[e].id]||0;let r=!e.attrs.filter||vs(e.attrs.filter);r=bs(r);const i=gr("virtualParameters",r,{limit:e.state.showCount||ms,sort:t}),s=dr("virtualParameters",r),o=Ss(r),a={};a.attributes=ws,a.data=i.value,a.total=s.value,a.showMoreCallback=function(){e.state.showCount=(e.state.showCount||ms)+ms,ri.redraw()},a.sortAttributes=n,a.onSortChange=function(n){const r=Object.assign({},t);for(const[e,t]of Object.entries(n))delete r[ws[e].id],r[ws[e].id]=t;const i={sort:JSON.stringify(r)};e.attrs.filter&&(i.filter=e.attrs.filter),ri.route.set("/admin/virtualParameters",i)},a.downloadUrl=o,a.recordActionsCallback=e=>[ri("a",{onclick:()=>{let t=null;const n=ri(Yi,Object.assign({base:e,actionHandler:(e,n)=>new Promise((r=>{ys(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)bt("error",e);else Jr(t);r()})).catch((e=>{bt("error",e.message),r()}))}))},As));t=()=>n,Wr(t,(()=>!n.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"Show")],window.authorizer.hasAccess("virtualParameters",3)&&(a.actionsCallback=e=>[ri("button.primary",{title:"Create new virtual parameter",onclick:()=>{let e=null;const t=ri(Yi,Object.assign({actionHandler:(t,n)=>new Promise((r=>{ys(t,n,!0).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)bt("error",e);else Jr(e);r()})).catch((e=>{bt("error",e.message),r()}))}))},As));e=()=>t,Wr(e,(()=>!t.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"New"),ri("button.primary",{title:"Delete selected virtual parameters",disabled:!e.size,onclick:t=>{confirm(`Deleting ${e.size} virtual parameters. Are you sure?`)&&(t.redraw=!1,t.target.disabled=!0,Promise.all(Array.from(e).map((e=>wr("virtualParameters",e)))).then((e=>{bt("success",e.length+" virtual parameters deleted"),mr(0,Date.now())})).catch((e=>{bt("error",e.message),mr(0,Date.now())})))}},"Delete")]);const l={resource:"virtualParameters"};return l.filter=e.attrs.filter,l.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),ri.route.set("/admin/virtualParameters",n)},[ri("h1","Listing virtual parameters"),ri(xi,l),ri(gi,a)]}})}),Ds=At.ui.pageSize||10,ks=vt(Xe),Os=vt(JSON.parse),Cs=[{id:"_id",label:"Name"},{id:"metadata.fileType",label:"Type",type:"combo",options:["1 Firmware Upgrade Image","2 Web Content","3 Vendor Configuration File","4 Tone File","5 Ringer File"]},{id:"metadata.oui",label:"OUI"},{id:"metadata.productClass",label:"Product Class"},{id:"metadata.version",label:"Version"}],Es={resource:"files",attributes:Cs.slice(1).concat([{id:"file",label:"File",type:"file"}])},Ps=vt((e=>Qe(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wi("files",e[2],e[3]):e)))),Ns=vt((e=>{const t={};for(const e of Cs)t[e.label]=e.id;return"api/files.csv?"+ri.buildQueryString({filter:et(e),columns:JSON.stringify(t)})})),js=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("files",2))return Promise.reject(new Error("You are not authorized to view this page"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return Promise.resolve({filter:n,sort:t})},component:()=>({view:e=>{document.title="Files - GenieACS";const t=e.attrs.sort?Os(e.attrs.sort):{},n={};for(let e=0;e<Cs.length;e++)n[e]=t[Cs[e].id]||0;let r=!e.attrs.filter||ks(e.attrs.filter);r=Ps(r);const i=gr("files",r,{limit:e.state.showCount||Ds,sort:t}),s=dr("files",r),o=Ns(r),a={};a.attributes=Cs,a.data=i.value,a.total=s.value,a.showMoreCallback=function(){e.state.showCount=(e.state.showCount||Ds)+Ds,ri.redraw()},a.sortAttributes=n,a.onSortChange=function(n){const r=Object.assign({},t);for(const[e,t]of Object.entries(n))delete r[Cs[e].id],r[Cs[e].id]=t;const i={sort:JSON.stringify(r)};e.attrs.filter&&(i.filter=e.attrs.filter),ri.route.set("/admin/files",i)},a.downloadUrl=o,window.authorizer.hasAccess("files",3)&&(a.actionsCallback=e=>[ri("button.primary",{title:"Create new file",onclick:()=>{let e=null;const t=ri(Yi,Object.assign({actionHandler:(t,n)=>new Promise((r=>{(function(e,t){return new Promise(((n,r)=>{const i=Object.assign({},t);if("save"===e){const e=i.file?i.file[0]:null;if(delete i.file,!e)return void n({file:"File not selected"});const t=e.name;yr("files",t).then((s=>{if(s)return mr(0,Date.now()),void n({file:"File already exists"});ur({method:"PUT",headers:Object.assign({"Content-Type":"application/octet-stream",Accept:"application/octet-stream"},i),url:"api/files/"+encodeURIComponent(t),serialize:e=>e,body:e}).then((()=>{bt("success","File "+(s?"updated":"created")),mr(0,Date.now()),n()})).catch(r)})).catch(r)}else r(new Error("Undefined action"))}))})(t,n).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)bt("error",e);else Jr(e);r()})).catch((e=>{bt("error",e.message),r()}))}))},Es));e=()=>t,Wr(e,(()=>!t.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"New"),ri("button.primary",{title:"Delete selected files",disabled:!e.size,onclick:t=>{confirm(`Deleting ${e.size} files. Are you sure?`)&&(t.redraw=!1,t.target.disabled=!0,Promise.all(Array.from(e).map((e=>wr("files",e)))).then((e=>{bt("success",e.length+" files deleted"),mr(0,Date.now())})).catch((e=>{bt("error",e.message),mr(0,Date.now())})))}},"Delete")]);const l={resource:"files"};return l.filter=e.attrs.filter,l.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),ri.route.set("/admin/files",n)},[ri("h1","Listing files"),ri(xi,l),ri(gi,a)]}})});function zs(e){let t=1;if("object"!=typeof e)return t;if(Array.isArray(e)){for(const n of e)t+=zs(n);return t}const n=Object.entries(e).map((([e,t])=>[e,zs(t)]));n.sort(((e,t)=>e[1]!==t[1]?e[1]-t[1]:t[0]>e[0]?-1:1));for(const[r,i]of n){t+=i;const n=e[r];delete e[r],e[r]=n}return t}function Is(e){e.sort(((e,t)=>e._id>t._id?1:e._id<t._id?-1:0));const t={};for(const n of e){const e=n._id.split(".");let r=t;for(;e.length>1;){const t=e.shift();"object"!=typeof r[t]&&(r[t]={}),r=r[t]}r[e[0]]=n.value}const n=function(e){if(null==e||"object"!=typeof e)return e;if(Object.keys(e).length<=300){let t=[];for(const n of Object.keys(e)){const e=Math.floor(+n);if(!(e>=0&&e<300&&String(e)===n)){t=[];break}{const n=Math.floor(e/30);t[n]||(t[n]=0),t[n]|=1<<e%30}}let n=0;for(;t.length&&1073741823===(n=t.shift()););if(n&&(~n&n+1)===n+1){const t=[];for(let n=0;n<Object.keys(e).length;n++)t[n]=e[n];e=t}}for(const[t,r]of Object.entries(e))e[t]=n(r);return e},r=n(t);return zs(r),r}const Ts=()=>({view:e=>{const t=e.attrs.prefix.split("."),n=e.attrs.name,r=e.attrs.data;let i;if(""===t[t.length-1]&&t.pop(),r.length){i=Is(r);for(const e of t)i=i[e]}const s=i&&Object.values(i).length?Mi.stringify(i,{schema:"failsafe"}):"",o=ri(Ki,{id:n+"-ui-config",value:s,mode:"yaml",focus:!0,onSubmit:e=>{e.form.querySelector("button[type=submit]").click()},onChange:t=>{e.state.updatedYaml=t,e.state.modified=!0}}),a=ri("button.primary",{type:"submit"},"Save");return ri("div.put-form",[ri("h1","Editing "+n),ri("form",{onsubmit:n=>{n.redraw=!1,n.preventDefault(),null==e.state.updatedYaml&&(e.state.updatedYaml=s),function(e,t){return new Promise(((n,r)=>{try{let i=Mi.parse(t,{schema:"failsafe"});if(i){const t={};let n=t;e.forEach(((t,r)=>{r<e.length-1?(n[t]={},n=n[t]):n[t]=i})),i=function(e){const t={},n=(e,r)=>{for(const[i,s]of Object.entries(e)){const e=r?`${r}.${i}`:i;void 0!==s&&(null===s||"object"!=typeof s?t[e]=s:n(s,e))}};return null!==e&&"object"==typeof e&&n(e,""),t}(t)}else i={};for(const e of Object.values(i))Xe(e);(function(e="%"){const t=et(["LIKE",["PARAM","_id"],e]);return ur({method:"GET",url:"api/config/?"+z.buildQueryString({filter:t}),background:!0})})(e.join(".")+".%").then((e=>{const t={};for(const n of e)t[n._id]=n.value;const s=function(e,t){const n={add:[],remove:[]};for(const[r,i]of Object.entries(t))e[r]&&e[r]===i||n.add.push({_id:r,value:i});for(const r of Object.keys(e))t[r]||n.remove.push(r);return n}(t,i);if(!s.add.length&&!s.remove.length)return void n();const o=[];for(const e of s.add)o.push(br("config",e._id,e));for(const e of s.remove)o.push(wr("config",e));Promise.all(o).then((()=>{n()})).catch(r)})).catch(r)}catch(e){n({config:e.message})}}))}(t,e.state.updatedYaml).then(e.attrs.onUpdate).catch(e.attrs.onError)}},[o,ri(".actions-bar",[a])])])}});function Ms(e,t,n){return new Promise(((r,i)=>{const s=Object.assign({},t);if("save"===e){let e=s._id||"";delete s._id;const t=/^[0-9a-zA-Z_.-]+$/;if(e=e.trim(),!e.match(t))return void r({_id:"Invalid ID"});try{s.value=et(Xe(s.value||""))}catch(e){return void r({value:"Config value must be valid expression"})}yr("config",e).then((t=>t&&n?(mr(0,Date.now()),void r({_id:"Config already exists"})):t||n?void br("config",e,s).then((()=>{bt("success","Config "+(t?"updated":"created")),mr(0,Date.now()),r()})).catch(i):(mr(0,Date.now()),void r({_id:"Config does not exist"})))).catch(i)}else"delete"===e?wr("config",s._id).then((()=>{bt("success","Config deleted"),mr(0,Date.now()),r()})).catch((e=>{mr(0,Date.now()),i(e)})):i(new Error("Undefined action"))}))}const Ls={resource:"config",attributes:[{id:"_id",label:"Key"},{id:"value",label:"Value",type:"textarea"}]};function Rs(e,t){const n=e.value.sort(((e,t)=>e._id<t._id?-1:1));let r;if(t){const e=t.split(" ").filter((e=>e));e.length&&(r=new RegExp(e.map((e=>e.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"))).join(".*"),"i"))}const i=[];for(const e of n){const t={};!r||r.test(e._id)||r.test(e.value)||(t.style="display: none;");const n=ri("button",{title:"Edit config value",onclick:()=>{let t=null;const n=ri(Yi,Object.assign({base:e,actionHandler:(e,n)=>new Promise((r=>{Ms(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)bt("error",e);else Jr(t);r()})).catch((e=>{bt("error",e.message),r()}))}))},Ls));t=()=>n,Wr(t,(()=>!n.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},xr("edit")),s=ri("button",{title:"Delete config",onclick:()=>{confirm(`Deleting ${e._id} config. Are you sure?`)&&Ms("delete",e).catch((e=>{throw e}))}},xr("remove"));i.push(ri("tr",t,ri("td.left",ri("long-text",{text:e._id})),ri("td.right",ri("span",[ri("long-text",{text:""+e.value}),n,s]))))}return i.length||i.push(ri("tr.empty",ri("td",{colspan:2},"No config"))),ri("table",ri("tbody",i))}const $s=Object.freeze({__proto__:null,init:function(){return window.authorizer.hasAccess("config",2)?new Promise(((e,t)=>{Promise.all([$i(),Bi()]).then((()=>{e({})})).catch(t)})):Promise.reject(new Error("You are not authorized to view this page"))},component:()=>({view:e=>{document.title="Config - GenieACS";const t=ri("input",{type:"text",placeholder:"Search config",oninput:t=>{e.state.searchString=t.target.value,t.redraw=!1,clearTimeout(e.state.timeout),e.state.timeout=setTimeout(ri.redraw,250)}}),n=gr("config",!0);let r;const i=[];if(window.authorizer.hasAccess("config",3)){r=ri("button.primary",{title:"Create new config",onclick:()=>{let e=null;const t=ri(Yi,Object.assign({actionHandler:(t,n)=>new Promise((r=>{Ms(t,n,!0).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)bt("error",e);else Jr(e);r()})).catch((e=>{bt("error",e.message),r()}))}))},Ls));e=()=>t,Wr(e,(()=>!t.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"New config");const e=[{name:"overview",prefix:"ui.overview.groups.",data:[]},{name:"charts",prefix:"ui.overview.charts.",data:[]},{name:"filters",prefix:"ui.filters.",data:[]},{name:"index page",prefix:"ui.index.",data:[]},{name:"device page",prefix:"ui.device.",data:[]}];if(n.fulfilled)for(const t of n.value)for(const n of e)if(t._id.startsWith(n.prefix)){n.data.push(t);break}for(const t of e){const e={prefix:t.prefix,name:t.name,data:t.data};i.push(ri("button",{onclick:()=>{let n=null;const r=ri(Ts,Object.assign({onUpdate:e=>{const r=e?Object.values(e):[];if(r.length)for(const e of r)bt("error",e);else bt("success",t.name.replace(/^[a-z]/,t.name[0].toUpperCase())+" config updated"),Jr(n);mr(0,Date.now())},onError:e=>{bt("error",e.message),mr(0,Date.now()),Jr(n)}},e));n=()=>r,Wr(n,(()=>!r.state.modified||confirm("You have unsaved changes. Close anyway?")))}},"Edit "+t.name))}}return[ri("h1","Listing config"),ri(".all-parameters",t,ri(".parameter-list",{style:"height: 400px"},Rs(n,e.state.searchString)),ri(".actions-bar",[r].concat(i)))]}})}),Bs=At.ui.pageSize||10,Us=vt(Xe),Fs=vt(JSON.parse),qs=[{id:"role",label:"Role"},{id:"resource",label:"Resource",type:"combo",options:["config","devices","faults","files","permissions","users","presets","provisions","virtualParameters"]},{id:"filter",label:"Filter",type:"textarea"},{id:"access",label:"Access",type:"combo",options:["1: count","2: read","3: write"]},{id:"validate",label:"Validate",type:"textarea"}],Ws=vt((e=>Qe(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wi("permissions",e[2],e[3]):e))));function Js(e,t){return new Promise(((n,r)=>{const i=Object.assign({},t);if("save"===e){if(!i.role)return void n({role:"Role can not be empty"});if(!i.resource)return void n({resource:"Resource can not be empty"});if(!i.access)return void n({access:"Access can not be empty"});if("3: write"===i.access)i.access=3;else if("2: read"===i.access)i.access=2;else{if("1: count"!==i.access)return void n({access:"Invalid access level"});i.access=1}if(i.filter)try{i.filter=et(Us(i.filter))}catch(e){return void n({filter:"Filter must be valid expression"})}if(i.validate)try{i.validate=et(Us(i.validate))}catch(e){return void n({validate:"Validate must be valid expression"})}const e=`${i.role}:${i.resource}:${i.access}`;yr("permissions",e).then((t=>{if(t)return mr(0,Date.now()),void n({_id:"Permission already exists"});br("permissions",e,i).then((()=>{bt("success","Permission created"),mr(0,Date.now()),n()})).catch(r)})).catch(r)}else"delete"===e?wr("permissions",i._id).then((()=>{bt("success","Permission deleted"),mr(0,Date.now()),n()})).catch((e=>{mr(0,Date.now()),r(e)})):r(new Error("Undefined action"))}))}const Vs={resource:"permissions",attributes:qs},Hs=vt((e=>{const t={};for(const e of qs)t[e.label]=e.id;return"api/permissions.csv?"+ri.buildQueryString({filter:et(e),columns:JSON.stringify(t)})})),Ks=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("permissions",2))return Promise.reject(new Error("You are not authorized to view this page"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return Promise.resolve({filter:n,sort:t})},component:()=>({view:e=>{document.title="Permissions - GenieACS";const t=e.attrs.sort?Fs(e.attrs.sort):{},n={};for(let e=0;e<qs.length;e++){const r=qs[e];"filter"!==r.id&&"validate"!==r.id&&(n[e]=t[r.id]||0)}let r=!e.attrs.filter||Us(e.attrs.filter);r=Ws(r);const i=gr("permissions",r,{limit:e.state.showCount||Bs,sort:t}),s=dr("permissions",r),o=Hs(r),a={};a.attributes=qs,a.data=i.value,a.total=s.value,a.valueCallback=(e,t)=>{if("access"===e.id){const e=t.access;return 1===e?"1: count":2===e?"2: read":3===e?"3: write":e}return t[e.id]},a.showMoreCallback=function(){e.state.showCount=(e.state.showCount||Bs)+Bs,ri.redraw()},a.sortAttributes=n,a.onSortChange=function(n){const r=Object.assign({},t);for(const[e,t]of Object.entries(n))delete r[qs[e].id],r[qs[e].id]=t;const i={sort:JSON.stringify(r)};e.attrs.filter&&(i.filter=e.attrs.filter),ri.route.set("/admin/permissions",i)},a.downloadUrl=o,window.authorizer.hasAccess("permissions",3)&&(a.recordActionsCallback=e=>[ri("button",{title:"Delete permission",onclick:()=>{confirm(`Deleting ${e._id} permission. Are you sure?`)&&Js("delete",e).catch((e=>{bt("error",e.message)}))}},xr("remove"))],a.actionsCallback=e=>[ri("button.primary",{title:"Create new permission",onclick:()=>{let e=null;const t=ri(Yi,Object.assign({actionHandler:(t,n)=>new Promise((r=>{Js(t,n).then((t=>{const n=t?Object.values(t):[];if(n.length)for(const e of n)bt("error",e);else Jr(e);r()})).catch((e=>{bt("error",e.message),r()}))}))},Vs));e=()=>t,Wr(e,(()=>!t.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"New"),ri("button.primary",{title:"Delete selected permissions",disabled:!e.size,onclick:t=>{confirm(`Deleting ${e.size} permissions. Are you sure?`)&&(t.redraw=!1,t.target.disabled=!0,Promise.all(Array.from(e).map((e=>wr("permissions",e)))).then((e=>{bt("success",e.length+" permissions deleted"),mr(0,Date.now())})).catch((e=>{bt("error",e.message),mr(0,Date.now())})))}},"Delete")]);const l={resource:"permissions"};return l.filter=e.attrs.filter,l.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),ri.route.set("/admin/permissions",n)},[ri("h1","Listing permissions"),ri(xi,l),ri(gi,a)]}})}),Gs=At.ui.pageSize||10,Qs=vt(Xe),Ys=vt(JSON.parse),Zs=[{id:"_id",label:"Username"},{id:"roles",label:"Roles",type:"multi",options:[]}],Xs=vt((e=>Qe(e,(e=>Array.isArray(e)&&"FUNC"===e[0]&&"Q"===e[1]?wi("users",e[2],e[3]):e))));function eo(e,t,n){return new Promise(((r,i)=>{const s=Object.assign({},t);if("save"===e){const e=s._id,t=s.password,o=s.confirm;if(delete s._id,delete s.password,delete s.confirm,!e)return void r({_id:"ID can not be empty"});if(n){if(!t)return void r({password:"Password can not be empty"});if(t!==o)return void r({confirm:"Confirm password doesn't match password"})}if(!Array.isArray(s.roles)||!s.roles.length)return void r({roles:"Role(s) must be selected"});s.roles=s.roles.join(","),yr("users",e).then((o=>o&&n?(mr(0,Date.now()),void r({_id:"User already exists"})):o||n?void br("users",e,s).then((()=>{n?Sr(e,t).then((()=>{bt("success","User created"),mr(0,Date.now()),r()})).catch(i):(bt("success","User updated"),mr(0,Date.now()),r())})).catch(i):(mr(0,Date.now()),void r({_id:"User does not exist"})))).catch(i)}else"delete"===e?wr("users",s._id).then((()=>{bt("success","User deleted"),mr(0,Date.now()),r()})).catch((e=>{mr(0,Date.now()),i(e)})):i(new Error("Undefined action"))}))}const to=vt((e=>{const t={};for(const e of Zs)t[e.label]=e.id;return"api/users.csv?"+ri.buildQueryString({filter:et(e),columns:JSON.stringify(t)})})),no=Object.freeze({__proto__:null,init:function(e){if(!window.authorizer.hasAccess("users",2))return Promise.reject(new Error("You are not authorized to view this page"));const t=e.hasOwnProperty("sort")?""+e.sort:"",n=e.hasOwnProperty("filter")?""+e.filter:"";return Promise.resolve({filter:n,sort:t})},component:()=>({view:e=>{document.title="Users - GenieACS";const t=e.attrs.sort?Ys(e.attrs.sort):{},n={};for(let e=0;e<Zs.length;e++)"roles"!==Zs[e].id&&(n[e]=t[Zs[e].id]||0);let r=!e.attrs.filter||Qs(e.attrs.filter);r=Xs(r);const i=gr("users",r,{limit:e.state.showCount||Gs,sort:t}),s=dr("users",r),o=gr("permissions",!0);if(o.fulfilled)for(const e of Zs)"roles"===e.id&&(e.options=[...new Set(o.value.map((e=>e.role)))]);const a=to(r),l=window.authorizer.hasAccess("users",3),c={};if(c.attributes=Zs,c.data=i.value,c.total=s.value,c.showMoreCallback=function(){e.state.showCount=(e.state.showCount||Gs)+Gs,ri.redraw()},c.sortAttributes=n,c.onSortChange=function(n){const r=Object.assign({},t);for(const[e,t]of Object.entries(n))delete r[Zs[e].id],r[Zs[e].id]=t;const i={sort:JSON.stringify(r)};e.attrs.filter&&(i.filter=e.attrs.filter),ri.route.set("/admin/users",i)},c.downloadUrl=a,c.recordActionsCallback=e=>[ri("a",{onclick:()=>{let t=null;const n=ri(Yi,Object.assign({base:{_id:e._id,roles:e.roles.split(",")},actionHandler:(e,n)=>new Promise((r=>{eo(e,n,!1).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)bt("error",e);else Jr(t);r()})).catch((e=>{bt("error",e.message),r()}))}))},{resource:"users",attributes:Zs}));t=()=>{const r=[n];if(l){r.push(ri("hr"));const n={noAuth:!0,username:e._id,onPasswordChange:()=>{Jr(t),ri.redraw()}};r.push(ri(ai,n))}return r},Wr(t,(()=>!n.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"Show")],l){const e={resource:"users",attributes:[Zs[0],{id:"password",label:"Password",type:"password"},{id:"confirm",label:"Confirm password",type:"password"},Zs[1]]};c.actionsCallback=t=>[ri("button.primary",{title:"Create new user",onclick:()=>{let t=null;const n=ri(Yi,Object.assign({actionHandler:(e,n)=>new Promise((r=>{eo(e,n,!0).then((e=>{const n=e?Object.values(e):[];if(n.length)for(const e of n)bt("error",e);else Jr(t);r()})).catch((e=>{bt("error",e.message),r()}))}))},e));t=()=>n,Wr(t,(()=>!n.state.current.modified||confirm("You have unsaved changes. Close anyway?")))}},"New"),ri("button.primary",{title:"Delete selected users",disabled:!t.size,onclick:e=>{confirm(`Deleting ${t.size} users. Are you sure?`)&&(e.redraw=!1,e.target.disabled=!0,Promise.all(Array.from(t).map((e=>wr("users",e)))).then((e=>{bt("success",e.length+" users deleted"),mr(0,Date.now())})).catch((e=>{bt("error",e.message),mr(0,Date.now())})))}},"Delete")]}const u={resource:"users"};return u.filter=e.attrs.filter,u.onChange=function(t){const n={filter:t};e.attrs.sort&&(n.sort=e.attrs.sort),ri.route.set("/admin/users",n)},[ri("h1","Listing users"),ri(xi,u),ri(gi,c)]}})});window.authorizer=new class{constructor(e){this.permissionSets=e,this.validatorCache=new WeakMap,this.hasAccessCache=new Map,this.getFilterCache=new Map}hasAccess(e,t){const n=`${e}-${t}`;if(this.hasAccessCache.has(n))return this.hasAccessCache.get(n);let r=!1;for(const n of this.permissionSets)for(const i of n)if(i[e]&&i[e].access>=t){r=!0;break}return this.hasAccessCache.set(n,r),r}getFilter(e,t){const n=`${e}-${t}`;if(this.getFilterCache.has(n))return this.getFilterCache.get(n);let r=null;for(const n of this.permissionSets)for(const i of n)i[e]&&i[e].access>=t&&(r=dt(r,i[e].filter));return this.getFilterCache.set(n,r),r}getValidator(e,t){if(this.validatorCache.has(t))return this.validatorCache.get(t);const n=[];for(const t of this.permissionSets)for(const r of t)r[e]&&r[e].access>=3&&r[e].validate&&n.push(r[e].validate);const r=(r,i,s)=>{if(!n.length)return!1;const o={mutationType:r,mutation:i,resourceType:e,object:t,options:s},a=ut(n.length>1?["OR",n]:n[0],(e=>{const t=e.split(".",1)[0];e=e.slice(t.length+1);let n=null;if(["mutation","options"].includes(t)){n=o[t];for(const t of e.split("."))if(n=null!=n&&"object"!=typeof n?null:n[t],null==n)break}else o[t]&&(n=e?o[t][e]:o[t]);return n}),Date.now());return!Array.isArray(a)&&!!a};return this.validatorCache.set(t,r),r}getPermissionSets(){return this.permissionSets}}(window.permissionSets);const ro=["presets","provisions","virtualParameters","files","config","users","permissions"];let io,so=0,oo=0,ao=null;function lo(){clearTimeout(ao),ao=setTimeout((()=>{mr(so,oo,(e=>{e&&z.redraw()}))}),100)}function co(e,t){return{render:()=>{let n;so=Date.now(),n=io&&io.error?z(Ii,io):z(oi(t.component),io),lo();const r={};return r.page=e,z(Hr,r,n)},onmatch:(e,n)=>(oo=Date.now(),t.init?new Promise((r=>{t.init(e).then((e=>{e?(io=e,r(),lo()):z.route.set("/")})).catch((e=>{!window.username&&e.message.indexOf("authorized")>=0&&(bt("error",e.message),z.route.set("/login",{continue:n})),io={error:e.message},r()}))})):(io=null,lo(),null))}}z.route(document.body,"/overview",{"/wizard":co("wizard",Kr),"/login":co("login",li),"/overview":co("overview",pi),"/devices":co("devices",ji),"/devices/:id":co("devices",zi),"/faults":co("faults",Hi),"/admin":{onmatch:()=>{for(const e of ro)if(window.authorizer.hasAccess(e,2))return z.route.set("/admin/"+e),null;return null}},"/admin/presets":co("presets",os),"/admin/provisions":co("provisions",gs),"/admin/virtualParameters":co("virtualParameters",xs),"/admin/files":co("files",js),"/admin/config":co("config",$s),"/admin/users":co("users",no),"/admin/permissions":co("permissions",Ks)})})();
//# sourceMappingURL=app.js.map